<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="æ™ºèƒ½å¥åº·é¥®é£ŸåŠ©æ‰‹" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='bg' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23667eea'/><stop offset='1' stop-color='%23764ba2'/></linearGradient></defs><rect width='64' height='64' rx='16' fill='url(%23bg)'/><ellipse cx='32' cy='32' rx='24' ry='24' fill='%23fff'/><ellipse cx='32' cy='32' rx='18' ry='16' fill='%2366bb6a' opacity='0.8'/><circle cx='24' cy='26' r='5' fill='%234caf50'/><circle cx='40' cy='26' r='5' fill='%234caf50'/><circle cx='22' cy='34' r='4.5' fill='%23f44336'/><circle cx='42' cy='34' r='4.5' fill='%23f44336'/></svg>" type="image/svg+xml">
    <meta
      name="description"
      content="ä¸“ä¸šçš„AIé©±åŠ¨å¥åº·é¥®é£Ÿç®¡ç†åŠ©æ‰‹ï¼Œæä¾›ä¸ªæ€§åŒ–è¥å…»è¿½è¸ªå’Œæ™ºèƒ½é¥®é£Ÿå»ºè®®"
    />
    <title>æ™ºèƒ½å¥åº·é¥®é£ŸåŠ©æ‰‹ - AIé©±åŠ¨çš„ä¸ªæ€§åŒ–å¥åº·ç®¡ç†</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --text-primary: #333;
        --text-secondary: #666;
        --bg-light: #f8f9fa;
        --border-radius: 15px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        color: var(--text-primary);
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 119, 198, 0.3),
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(255, 119, 198, 0.3),
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 20%,
            rgba(255, 255, 255, 0.1),
            transparent 50%
          );
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) rotate(0deg);
        }
        33% {
          transform: translate(-20px, -20px) rotate(1deg);
        }
        66% {
          transform: translate(20px, -10px) rotate(-1deg);
        }
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: fadeInDown 0.8s ease-out;
      }

      .header h1 {
        font-size: 3.5em;
        margin-bottom: 15px;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        letter-spacing: 2px;
      }

      .header p {
        font-size: 1.3em;
        opacity: 0.95;
        font-weight: 300;
      }

      .nav-buttons {
        margin-top: 25px;
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 35px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .nav-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .nav-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .nav-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .nav-btn.active {
        background: white;
        color: #667eea;
        border-color: white;
        font-weight: 600;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin-bottom: 40px;
      }

      @media (min-width: 768px) {
        .main-content {
          grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
        animation: slideUp 0.6s ease-out;
        position: relative;
        overflow: hidden;
        grid-column: 1 / -1;
      }

      /* .card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(102, 126, 234, 0.05) 0%,
          transparent 70%
        );
        transform: rotate(45deg);
        transition: transform 0.6s;
      }

      .card:hover::before {
        transform: rotate(45deg) translate(10%, 10%);
      } */

      .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 2em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .meal-time-section {
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        border-left: 5px solid #667eea;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .meal-time-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: var(--transition);
        position: relative;
        z-index: 1;
      }

      .meal-time-header:hover {
        background: rgba(102, 126, 234, 0.1);
      }

      .meal-time-title {
        color: #667eea;
        font-size: 1.5em;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .meal-expand-arrow {
        color: #667eea;
        font-size: 1.2em;
        transition: transform 0.3s ease;
      }

      .meal-time-section.expanded .meal-expand-arrow {
        transform: rotate(180deg);
      }

      .meal-content {
        padding: 0 25px 25px;
        display: none;
        position: relative;
        z-index: 1;
      }

      .meal-time-section.expanded .meal-content {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .meal-search-container {
        position: relative;
        margin-bottom: 15px;
      }

      .meal-search-input {
        width: 100%;
        padding: 12px 50px 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 15px;
        transition: var(--transition);
        background: white;
      }

      .meal-search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .search-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--primary-gradient);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        font-size: 18px;
      }

      .search-btn:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .nutrition-tracker {
        background: var(--secondary-gradient);
        color: white;
        padding: 30px;
        border-radius: 25px;
        margin-top: 25px;
        position: relative;
        overflow: hidden;
      }

      .nutrition-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 20px;
        margin-top: 25px;
        position: relative;
        z-index: 1;
      }

      .nutrition-stat {
        background: rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
      }

      .nutrition-stat:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.25);
      }

      .nutrition-value {
        font-size: 2.2em;
        font-weight: bold;
        margin-bottom: 8px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .progress-bar {
        background: rgba(255, 255, 255, 0.3);
        height: 10px;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
        background: white;
        position: relative;
        overflow: hidden;
      }

      .water-glass {
        font-size: 2.5em;
        cursor: pointer;
        transition: var(--transition);
        display: inline-block;
        filter: grayscale(100%);
        opacity: 0.5;
      }

      .water-glass.filled {
        filter: grayscale(0%);
        opacity: 1;
        animation: fillWater 0.5s ease;
      }

      @keyframes fillWater {
        0% {
          transform: scale(1) rotate(0deg);
        }
        50% {
          transform: scale(1.2) rotate(-10deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      .water-glass:hover {
        transform: scale(1.15) rotate(-5deg);
      }

      .profile-page,
      .chat-page,
      .diet-plan-page {
        display: none;
      }

      .profile-container,
      .chat-page-container,
      .diet-plan-container {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 30px;
        padding: 40px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        max-width: 1200px;
        margin: 0 auto;
        animation: slideUp 0.6s ease-out;
      }

      .chat-page-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
      }

      .chat-main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid #e9ecef;
      }

      .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .input-container {
        padding: 15px;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .message-input {
        flex: 1;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        padding: 10px 15px;
        font-size: 14px;
        outline: none;
        resize: none;
        min-height: 40px;
        max-height: 100px;
        font-family: inherit;
      }

      .send-button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chat-message {
        margin-bottom: 20px;
        display: flex;
        animation: messageSlideIn 0.3s ease-out;
      }

      .chat-message.user {
        justify-content: flex-end;
      }

      .chat-message.assistant {
        justify-content: flex-start;
      }

      .chat-message-content {
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 20px;
        word-wrap: break-word;
        line-height: 1.6;
      }

      .chat-message.user .chat-message-content {
        background: var(--primary-gradient);
        color: white;
        border-bottom-right-radius: 5px;
      }

      .chat-message.assistant .chat-message-content {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .chat-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin: 0 10px;
        flex-shrink: 0;
      }

      .chat-message.user .chat-avatar {
        background: var(--primary-gradient);
        color: white;
        order: 2;
      }

      .chat-message.assistant .chat-avatar {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
        animation: slideInRight 0.5s ease;
        z-index: 1000;
        max-width: 350px;
      }

      .notification.success {
        border-left: 5px solid var(--success-color);
      }

      .notification.warning {
        border-left: 5px solid var(--warning-color);
      }

      .notification.info {
        border-left: 5px solid #2196f3;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 2.2em;
        }

        .header p {
          font-size: 1.1em;
        }

        .nav-buttons {
          flex-direction: column;
          width: 100%;
        }

        .nav-btn {
          width: 100%;
          max-width: 300px;
          margin: 5px auto;
        }

        .card {
          padding: 20px;
        }

        .nutrition-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.8em;
        }

        .nutrition-grid {
          grid-template-columns: 1fr;
        }

        .water-glass {
          font-size: 2em;
        }

        .chat-message-content {
          max-width: 85%;
        }
      }

      /* å…¶ä»–å¿…è¦æ ·å¼ */
      button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin: 5px;
      }

      button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #667eea;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        transition: var(--transition);
        background: #f8f9fa;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }

      .bmi-calculator {
        background: var(--primary-gradient);
        color: white;
        padding: 25px;
        border-radius: 20px;
        margin-top: 20px;
        text-align: center;
      }

      .bmi-display {
        font-size: 3em;
        font-weight: bold;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .bmi-status {
        font-size: 1.2em;
        padding: 10px 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        display: inline-block;
        margin-top: 10px;
      }

      .water-tracker {
        text-align: center;
        margin-top: 20px;
      }

      .water-glasses {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .meal-search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
      }

      .food-result-item {
        background: white;
        padding: 15px;
        margin: 8px 0;
        border-radius: 15px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid transparent;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .food-result-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      }

      .nutrition-badge {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin: 0 2px;
      }

      .add-food-btn {
        background: var(--success-color);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: var(--transition);
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
      }

      .add-food-btn:hover {
        background: #45a049;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      /* æµå¼è¾“å‡ºå…‰æ ‡æ•ˆæœ */
      .streaming-cursor {
        display: inline-block;
        width: 2px;
        height: 1.2em;
        background: #667eea;
        animation: blink 1s infinite;
        vertical-align: baseline;
        margin-left: 2px;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      /* åŠ è½½åŠ¨ç”» */
      .chat-typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .chat-typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.4s infinite ease-in-out;
      }

      .chat-typing-indicator span:nth-child(1) {
        animation-delay: 0ms;
      }
      .chat-typing-indicator span:nth-child(2) {
        animation-delay: 200ms;
      }
      .chat-typing-indicator span:nth-child(3) {
        animation-delay: 400ms;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-8px);
          opacity: 1;
        }
      }

      /* è‡ªå®šä¹‰å¤é€‰æ¡†æ ·å¼ */
      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px solid #e9ecef;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 12px;
        border-radius: 8px;
        transition: var(--transition);
        background: white;
        border: 2px solid transparent;
        position: relative;
        user-select: none;
      }

      .checkbox-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .checkbox-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .checkbox-custom {
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-radius: 4px;
        position: relative;
        transition: var(--transition);
        flex-shrink: 0;
      }

      .checkbox-item input[type="checkbox"]:checked + .checkbox-custom {
        background: var(--primary-gradient);
        border-color: #667eea;
      }

      .checkbox-item input[type="checkbox"]:checked + .checkbox-custom::after {
        content: "âœ“";
        position: absolute;
        color: white;
        font-size: 14px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .checkbox-label {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        flex: 1;
      }

      .checkbox-item input[type="checkbox"]:checked ~ .checkbox-label {
        color: #667eea;
        font-weight: 600;
      }

      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        .checkbox-group {
          grid-template-columns: 1fr 1fr;
          gap: 8px;
          padding: 12px;
        }

        .checkbox-item {
          padding: 8px 10px;
          font-size: 14px;
        }

        .checkbox-custom {
          width: 18px;
          height: 18px;
        }

        .checkbox-label {
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        .checkbox-group {
          grid-template-columns: 1fr;
        }
      }
      .plan-generator-panel {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 2px solid #e9ecef;
      }

      .generator-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .generator-header h3 {
        color: #667eea;
        font-size: 1.8em;
        margin-bottom: 10px;
      }

      .generator-header p {
        color: #666;
        font-size: 1.1em;
      }

      .generate-actions {
        text-align: center;
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .generate-plan-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .generate-plan-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .generate-plan-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .reset-btn,
      .save-plan-btn,
      .export-btn,
      .apply-btn {
        border: none;
        padding: 12px 25px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
      }

      .plan-display-area {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.6s ease-out;
      }

      .plan-overview {
        margin-bottom: 30px;
        padding: 20px;
        background: var(--primary-gradient);
        color: white;
        border-radius: 15px;
      }

      .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .plan-content {
        margin-bottom: 30px;
      }

      .day-plan {
        margin-bottom: 25px;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        background: white;
      }

      .day-header {
        background: var(--secondary-gradient);
        color: white;
        padding: 15px 25px;
        font-weight: 600;
        font-size: 1.2em;
      }

      .day-meals {
        padding: 20px;
      }

      .meal-section {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 12px;
        background: #f8f9fa;
        border-left: 4px solid #667eea;
      }

      .meal-title {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .meal-items {
        display: grid;
        gap: 10px;
      }

      .meal-item {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      .meal-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
      }

      .item-info {
        flex: 1;
      }

      .item-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
      }

      .item-nutrition {
        font-size: 0.85em;
        color: #666;
      }

      .item-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        object-fit: cover;
        margin-left: 15px;
      }

      .plan-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
      }

      .saved-plans-section {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .saved-plans-section h3 {
        color: #667eea;
        margin-bottom: 20px;
        text-align: center;
      }

      .saved-plan-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        transition: var(--transition);
      }

      .saved-plan-item:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .plan-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .plan-item-title {
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
      }

      .plan-item-date {
        color: #666;
        font-size: 0.9em;
      }

      .plan-item-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        font-size: 0.9em;
      }

      .plan-item-actions {
        display: flex;
        gap: 10px;
      }

      .plan-item-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.85em;
        transition: var(--transition);
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .custom-food-dialog,
      .photo-recognition-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .custom-food-dialog-content,
      .photo-dialog-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        animation: slideUp 0.3s ease;
        width: 90%;
      }
    </style>

    <!-- Markdownè§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¥— æ™ºèƒ½å¥åº·é¥®é£ŸåŠ©æ‰‹</h1>
        <p>æ‚¨çš„ä¸“å±è¥å…»ç®¡ç†ä¸“å®¶ - AIé©±åŠ¨çš„å¥åº·ç”Ÿæ´»</p>
        <div class="nav-buttons">
          <button onclick="showMainPage()" class="nav-btn active" id="mainBtn">
            <span style="position: relative; z-index: 1">ğŸ  ä¸»é¡µ</span>
          </button>
          <button onclick="showProfilePage()" class="nav-btn" id="profileBtn">
            <span style="position: relative; z-index: 1">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</span>
          </button>
          <button onclick="showChatPage()" class="nav-btn" id="chatBtn">
            <span style="position: relative; z-index: 1">ğŸ¤– æ™ºèƒ½é—®ç­”</span>
          </button>
          <button onclick="showDietPlanPage()" class="nav-btn" id="dietPlanBtn">
            <span style="position: relative; z-index: 1">ğŸ“‹ é¥®é£Ÿè®¡åˆ’</span>
          </button>
        </div>
      </div>

      <!-- ä¸»é¡µå†…å®¹ -->
      <div class="main-content" id="mainContent">
        <div class="card">
          <h2>ğŸ“‹ æˆ‘çš„å¥åº·è®¡åˆ’</h2>
          <div id="personalPlanDisplay"></div>
          <div class="bmi-calculator" id="bmiCalculator" style="display: none">
            <h3>BMI èº«ä½“è´¨é‡æŒ‡æ•°</h3>
            <div class="bmi-display" id="bmiValue">--</div>
            <div class="bmi-status" id="bmiStatus">è¯·å…ˆå®Œå–„ä¸ªäººä¿¡æ¯</div>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ½ï¸ ä»Šæ—¥é¥®é£Ÿè®°å½•</h2>
          <div id="mealSuggestions">
            <!-- æ—©é¤ -->
            <div class="meal-time-section" id="breakfastSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('breakfast')"
              >
                <h3 class="meal-time-title">ğŸŒ… æ—©é¤</h3>
                <span class="meal-expand-arrow">â–¼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>è®°å½•æ—©é¤</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="breakfastSearchInput"
                      placeholder="æœç´¢æ—©é¤é£Ÿç‰©..."
                      onkeyup="handleSearchKeyUp(event, 'breakfast')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('breakfast')"
                    >
                      ğŸ”
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-breakfast"
                      onclick="openCustomFoodDialog('breakfast')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      â• è‡ªå®šä¹‰é£Ÿç‰©
                    </button>
                    <button
                      id="photoRecognitionBtn-breakfast"
                      onclick="openPhotoRecognitionDialog('breakfast')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ğŸ“· æ‹ç…§è¯†åˆ«
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="breakfastSearchResults"
                  ></div>
                  <div class="meal-recorded" id="breakfastRecorded">
                    <h5>å·²è®°å½•ï¼š</h5>
                    <div id="breakfastRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- åˆé¤ -->
            <div class="meal-time-section" id="lunchSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('lunch')"
              >
                <h3 class="meal-time-title">â˜€ï¸ åˆé¤</h3>
                <span class="meal-expand-arrow">â–¼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>è®°å½•åˆé¤</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="lunchSearchInput"
                      placeholder="æœç´¢åˆé¤é£Ÿç‰©..."
                      onkeyup="handleSearchKeyUp(event, 'lunch')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('lunch')"
                    >
                      ğŸ”
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-lunch"
                      onclick="openCustomFoodDialog('lunch')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      â• è‡ªå®šä¹‰é£Ÿç‰©
                    </button>
                    <button
                      id="photoRecognitionBtn-lunch"
                      onclick="window.openPhotoRecognitionDialog('lunch')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ğŸ“· æ‹ç…§è¯†åˆ«
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="lunchSearchResults"
                  ></div>
                  <div class="meal-recorded" id="lunchRecorded">
                    <h5>å·²è®°å½•ï¼š</h5>
                    <div id="lunchRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- æ™šé¤ -->
            <div class="meal-time-section" id="dinnerSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('dinner')"
              >
                <h3 class="meal-time-title">ğŸŒ™ æ™šé¤</h3>
                <span class="meal-expand-arrow">â–¼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>è®°å½•æ™šé¤</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="dinnerSearchInput"
                      placeholder="æœç´¢æ™šé¤é£Ÿç‰©..."
                      onkeyup="handleSearchKeyUp(event, 'dinner')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('dinner')"
                    >
                      ğŸ”
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-dinner"
                      onclick="openCustomFoodDialog('dinner')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      â• è‡ªå®šä¹‰é£Ÿç‰©
                    </button>
                    <button
                      id="photoRecognitionBtn-dinner"
                      onclick="openPhotoRecognitionDialog('dinner')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ğŸ“· æ‹ç…§è¯†åˆ«
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="dinnerSearchResults"
                  ></div>
                  <div class="meal-recorded" id="dinnerRecorded">
                    <h5>å·²è®°å½•ï¼š</h5>
                    <div id="dinnerRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ“Š è¥å…»è¿½è¸ª</h2>
          <div class="nutrition-tracker">
            <h3>ä»Šæ—¥è¥å…»æ‘„å…¥æƒ…å†µ</h3>
            <div class="nutrition-grid" id="nutritionGrid">
              <div class="nutrition-stat">
                <h4>ğŸ”¥ å¡è·¯é‡Œ</h4>
                <div class="nutrition-value" id="calorieValue">0</div>
                <div class="nutrition-target" id="calorieTarget">
                  ç›®æ ‡: 2000
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="calorieProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>ğŸ¥© è›‹ç™½è´¨</h4>
                <div class="nutrition-value" id="proteinValue">0g</div>
                <div class="nutrition-target" id="proteinTarget">ç›®æ ‡: 50g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="proteinProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>ğŸŒ¾ ç¢³æ°´åŒ–åˆç‰©</h4>
                <div class="nutrition-value" id="carbValue">0g</div>
                <div class="nutrition-target" id="carbTarget">ç›®æ ‡: 250g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="carbProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>ğŸ¥‘ è„‚è‚ª</h4>
                <div class="nutrition-value" id="fatValue">0g</div>
                <div class="nutrition-target" id="fatTarget">ç›®æ ‡: 65g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="fatProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="water-tracker">
            <h3>ğŸ’§ ä»Šæ—¥é¥®æ°´é‡</h3>
            <div class="water-glasses" id="waterGlasses">
              <span class="water-glass" onclick="toggleWater(0)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(1)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(2)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(3)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(4)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(5)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(6)">ğŸ¥¤</span>
              <span class="water-glass" onclick="toggleWater(7)">ğŸ¥¤</span>
            </div>
            <p id="waterCount" style="margin-top: 15px; font-size: 1.1em">
              å·²é¥®ç”¨:
              <span style="font-weight: bold; color: #2196f3">0</span> æ¯ (<span
                style="font-weight: bold; color: #2196f3"
                >0</span
              >
              ml)
            </p>
            <p style="margin-top: 10px; opacity: 0.8">
              å»ºè®®æ¯æ—¥é¥®æ°´ 8 æ¯ (2000ml)
            </p>
          </div>
        </div>
      </div>

      <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
      <div class="profile-page" id="profilePage">
        <div class="profile-container">
          <div class="profile-header">
            <h2 style="color: #667eea; text-align: center">ğŸ‘¤ ä¸ªäººå¥åº·æ¡£æ¡ˆ</h2>
            <p style="text-align: center; color: #666">
              å®Œå–„æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œè·å¾—æ›´ç²¾å‡†çš„å¥åº·å»ºè®®
            </p>
          </div>

          <div class="profile-form" id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="fullName">å§“å *</label>
                <input
                  type="text"
                  id="fullName"
                  required
                  placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
                />
              </div>
              <div class="form-group">
                <label for="gender">æ€§åˆ« *</label>
                <select id="gender" required>
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="male">ç”·</option>
                  <option value="female">å¥³</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ *</label>
                <input type="date" id="birthDate" required />
              </div>
              <div class="form-group">
                <label for="phone">è”ç³»ç”µè¯</label>
                <input type="tel" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="profileHeight">èº«é«˜ (cm) *</label>
                <input
                  type="number"
                  id="profileHeight"
                  step="0.1"
                  required
                  min="50"
                  max="250"
                  placeholder="170"
                />
              </div>
              <div class="form-group">
                <label for="profileWeight">ä½“é‡ (kg) *</label>
                <input
                  type="number"
                  id="profileWeight"
                  step="0.1"
                  required
                  min="20"
                  max="300"
                  placeholder="65"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="targetWeight">ç›®æ ‡ä½“é‡ (kg)</label>
                <input
                  type="number"
                  id="targetWeight"
                  step="0.1"
                  min="20"
                  max="300"
                  placeholder="60"
                />
              </div>
              <div class="form-group">
                <label for="activityLevel">è¿åŠ¨é¢‘ç‡ *</label>
                <select id="activityLevel" required>
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="sedentary">ä¹…åå°‘åŠ¨</option>
                  <option value="light">è½»åº¦è¿åŠ¨ (1-2å¤©/å‘¨)</option>
                  <option value="moderate">ä¸­åº¦è¿åŠ¨ (3-4å¤©/å‘¨)</option>
                  <option value="active">é«˜åº¦è¿åŠ¨ (5-6å¤©/å‘¨)</option>
                  <option value="very-active">ä¸“ä¸šè¿åŠ¨å‘˜</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>å¥åº·ç›®æ ‡ *</label>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 15px;
                  margin-top: 10px;
                "
              >
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-weight-loss"
                    value="weight-loss"
                  />
                  å‡é‡ç˜¦èº«
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-muscle-gain"
                    value="muscle-gain"
                  />
                  å¢è‚Œå¡‘å½¢
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-healthy-eating"
                    value="healthy-eating"
                  />
                  å¥åº·é¥®é£Ÿ
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-disease-prevention"
                    value="disease-prevention"
                  />
                  ç–¾ç—…é¢„é˜²
                </label>
              </div>
            </div>

            <button
              type="button"
              onclick="saveProfile()"
              style="display: block; margin: 30px auto"
            >
              ä¿å­˜ä¸ªäººä¿¡æ¯
            </button>
          </div>
        </div>
      </div>

      <!-- é¥®é£Ÿè®¡åˆ’é¡µé¢ -->
      <div class="diet-plan-page" id="dietPlanPage">
        <div class="diet-plan-container">
          <div class="diet-plan-header">
            <h2 style="color: #667eea; text-align: center">ğŸ“‹ æ™ºèƒ½é¥®é£Ÿè®¡åˆ’</h2>
            <p style="text-align: center; color: #666">
              åŸºäºæ‚¨çš„èº«ä½“æ•°æ®å’Œå¥åº·ç›®æ ‡ï¼ŒAIä¸ºæ‚¨åˆ¶å®šä¸“å±é¥®é£Ÿæ–¹æ¡ˆ
            </p>
          </div>

          <!-- è®¡åˆ’ç”Ÿæˆæ§åˆ¶é¢æ¿ -->
          <div class="plan-generator-panel">
            <div class="generator-header">
              <h3>ğŸ¯ è®¡åˆ’ç”Ÿæˆå‚æ•°</h3>
              <p>è¯·è®¾ç½®æ‚¨çš„é¥®é£Ÿåå¥½ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆæœ€é€‚åˆçš„é¥®é£Ÿè®¡åˆ’</p>
            </div>

            <div class="generator-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="planDuration">è®¡åˆ’å‘¨æœŸ</label>
                  <select id="planDuration">
                    <option value="day">å•æ—¥è®¡åˆ’</option>
                    <option value="week" selected>ä¸€å‘¨è®¡åˆ’</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="dietType">é¥®é£Ÿç±»å‹</label>
                  <select id="dietType">
                    <option value="">æ— ç‰¹æ®Šè¦æ±‚</option>
                    <option value="vegetarian">ç´ é£Ÿä¸»ä¹‰</option>
                    <option value="vegan">çº¯ç´ é£Ÿ</option>
                    <option value="ketogenic">ç”Ÿé…®é¥®é£Ÿ</option>
                    <option value="paleo">åŸå§‹é¥®é£Ÿ</option>
                    <option value="whole30">Whole30</option>
                    <option value="gluten free">æ— éº¸è´¨</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="intolerances">é£Ÿç‰©è¿‡æ•/ä¸è€å—</label>
                  <div class="checkbox-group" id="intolerancesCheckboxes">
                    <label class="checkbox-item">
                      <input type="checkbox" value="dairy" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸ¥› ä¹³åˆ¶å“</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="egg" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸ¥š é¸¡è›‹</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="gluten" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸŒ¾ éº¸è´¨</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="grain" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸŒ¾ è°·ç‰©</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="peanut" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸ¥œ èŠ±ç”Ÿ</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="seafood" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸŸ æµ·é²œ</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="shellfish" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸš è´ç±»</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="soy" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸ«˜ å¤§è±†</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="tree nut" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">ğŸŒ° åšæœ</span>
                    </label>
                  </div>
                  <small
                    style="
                      color: #666;
                      font-size: 0.85em;
                      margin-top: 8px;
                      display: block;
                    "
                  >
                    ğŸ’¡ ç‚¹å‡»é€‰æ‹©æ‚¨éœ€è¦é¿å…çš„é£Ÿç‰©ç±»å‹
                  </small>
                </div>
                <div class="form-group">
                  <label for="excludeIngredients">æ’é™¤é£Ÿæ</label>
                  <textarea
                    id="excludeIngredients"
                    placeholder="è¯·è¾“å…¥è¦æ’é™¤çš„é£Ÿæï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šæ´‹è‘±,å¤§è’œ,è¾£æ¤’"
                    rows="3"
                  ></textarea>
                </div>
              </div>

              <div class="generate-actions">
                <button onclick="generateDietPlan()" class="generate-plan-btn">
                  ğŸš€ ç”Ÿæˆæ™ºèƒ½é¥®é£Ÿè®¡åˆ’
                </button>
                <button
                  onclick="resetPlanForm()"
                  class="reset-btn"
                  style="background: #6c757d"
                >
                  ğŸ”„ é‡ç½®å‚æ•°
                </button>
              </div>
            </div>
          </div>

          <!-- è®¡åˆ’å±•ç¤ºåŒºåŸŸ -->
          <div
            class="plan-display-area"
            id="planDisplayArea"
            style="display: none"
          >
            <div class="plan-overview">
              <h3>ğŸ“Š è®¡åˆ’æ¦‚è§ˆ</h3>
              <div class="overview-stats" id="overviewStats">
                <!-- åŠ¨æ€ç”Ÿæˆè¥å…»ç»Ÿè®¡ -->
              </div>
            </div>

            <div class="plan-content" id="planContent">
              <!-- åŠ¨æ€ç”Ÿæˆé¥®é£Ÿè®¡åˆ’å†…å®¹ -->
            </div>

            <div class="plan-actions">
              <button onclick="saveDietPlan()" class="save-plan-btn">
                ğŸ’¾ ä¿å­˜è®¡åˆ’
              </button>
              <button
                onclick="exportDietPlan()"
                class="export-btn"
                style="background: #28a745"
              >
                ğŸ“„ å¯¼å‡ºPDF
              </button>
              <button
                onclick="applyTodayPlan()"
                class="apply-btn"
                style="background: #17a2b8"
              >
                âœ… åº”ç”¨åˆ°ä»Šæ—¥
              </button>
            </div>
          </div>

          <!-- å·²ä¿å­˜çš„è®¡åˆ’åˆ—è¡¨ -->
          <div class="saved-plans-section">
            <h3>ğŸ“š æˆ‘çš„é¥®é£Ÿè®¡åˆ’</h3>
            <div class="saved-plans-list" id="savedPlansList">
              <div style="text-align: center; padding: 20px; color: #999">
                <p>æš‚æ— ä¿å­˜çš„é¥®é£Ÿè®¡åˆ’</p>
                <small>ç”Ÿæˆå¹¶ä¿å­˜æ‚¨çš„ç¬¬ä¸€ä¸ªé¥®é£Ÿè®¡åˆ’å§ï¼</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-page" id="chatPage">
        <div class="chat-page-container">
          <div class="chat-page-header">
            <h2 style="color: #667eea; text-align: center">ğŸ¤– AIå¥åº·é¡¾é—®</h2>
            <p style="text-align: center; color: #666">
              æ‚¨çš„ä¸“å±æ™ºèƒ½å¥åº·åŠ©æ‰‹ï¼Œéšæ—¶ä¸ºæ‚¨ç­”ç–‘è§£æƒ‘
            </p>
          </div>

          <div class="chat-main-container">
            <div class="messages-container" id="chatPageMessagesContainer">
              <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>

            <div class="input-container">
              <textarea
                class="message-input"
                id="chatPageMessageInput"
                placeholder="è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
                rows="1"
              ></textarea>
              <button
                class="send-button"
                id="chatPageSendButton"
                onclick="sendChatPageMessage()"
                disabled
              >
                â¤
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- è‡ªå®šä¹‰é£Ÿç‰©å¯¹è¯æ¡†ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰ -->
    <div class="custom-food-dialog" id="customFoodDialog">
      <div class="custom-food-dialog-content">
        <h3 style="color: #667eea; margin-bottom: 20px">â• æ·»åŠ è‡ªå®šä¹‰é£Ÿç‰©</h3>

        <div class="form-group">
          <label for="customFoodName">é£Ÿç‰©åç§° *</label>
          <input
            type="text"
            id="customFoodName"
            placeholder="ä¾‹å¦‚ï¼šè¥¿çº¢æŸ¿ç‚’é¸¡è›‹"
          />
        </div>

        <div class="form-group">
          <label for="customFoodDescription">é£Ÿç‰©æè¿° *</label>
          <textarea
            id="customFoodDescription"
            placeholder="è¯·è¯¦ç»†æè¿°é£Ÿç‰©ï¼Œä¾‹å¦‚ï¼š&#10;é¸¡è›‹ 2ä¸ª&#10;è¥¿çº¢æŸ¿ 200g"
            rows="4"
          ></textarea>
          <small
            style="
              color: #666;
              font-size: 0.85em;
              margin-top: 5px;
              display: block;
            "
          >
            ğŸ’¡ è¯·å°½é‡è¯¦ç»†æè¿°é£Ÿæå’Œé‡é‡ï¼Œè¿™æ ·è¥å…»åˆ†æä¼šæ›´å‡†ç¡®
          </small>
        </div>

        <div
          id="nutritionAnalysisLoading"
          style="display: none; text-align: center; padding: 20px"
        >
          <div class="chat-typing-indicator" style="display: inline-flex">
            <span></span><span></span><span></span>
          </div>
          <p style="margin-top: 15px; color: #666">æ­£åœ¨åˆ†æè¥å…»æˆåˆ†...</p>
          <small style="color: #999">ä½¿ç”¨Edamam APIè¿›è¡Œç²¾ç¡®è®¡ç®—</small>
        </div>

        <div id="nutritionAnalysisResult" style="display: none">
          <h4 style="color: #667eea; margin: 20px 0 10px 0">ğŸ”¬ è¥å…»åˆ†æç»“æœ</h4>
          <div
            id="analysisResultContent"
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <!-- è¥å…»åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
          "
        >
          <button
            onclick="closeCustomFoodDialog()"
            style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            å–æ¶ˆ
          </button>
          <button
            id="analyzeNutritionBtn"
            onclick="analyzeCustomFood()"
            style="
              background: #28a745;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            ğŸ”¬ åˆ†æè¥å…»
          </button>
          <button
            id="addAnalyzedFoodBtn"
            onclick="addAnalyzedFood()"
            style="
              background: #667eea;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              display: none;
            "
          >
            âœ… æ·»åŠ é£Ÿç‰©
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹ç…§è¯†åˆ«å¯¹è¯æ¡† -->
    <div class="photo-recognition-dialog" id="photoRecognitionDialog">
      <div class="photo-dialog-content">
        <h3 style="color: #667eea; margin-bottom: 20px">ğŸ“· æ‹ç…§è¯†åˆ«é£Ÿç‰©</h3>

        <div style="text-align: center; margin-bottom: 20px">
          <div id="photoPreview" style="display: none; margin-bottom: 15px">
            <img
              id="previewImage"
              style="
                max-width: 100%;
                max-height: 300px;
                border-radius: 10px;
                border: 2px solid #e9ecef;
              "
            />
          </div>

          <input
            type="file"
            id="photoInput"
            accept="image/*"
            capture="environment"
            style="display: none"
            onchange="handlePhotoSelection(event)"
          />

          <button
            onclick="document.getElementById('photoInput').click()"
            style="
              background: var(--primary-gradient);
              color: white;
              border: none;
              padding: 15px 30px;
              border-radius: 25px;
              font-size: 16px;
              cursor: pointer;
              margin: 5px;
            "
          >
            ğŸ“· æ‹ç…§ / é€‰æ‹©å›¾ç‰‡
          </button>
        </div>

        <div id="recognitionResults" style="display: none">
          <h4 style="color: #667eea; margin-bottom: 15px">è¯†åˆ«ç»“æœï¼š</h4>
          <div id="recognizedFoodsList"></div>
        </div>

        <div
          id="recognitionLoading"
          style="display: none; text-align: center; padding: 20px"
        >
          <div class="chat-typing-indicator" style="display: inline-flex">
            <span></span><span></span><span></span>
          </div>
          <p style="margin-top: 15px; color: #666">æ­£åœ¨è¯†åˆ«é£Ÿç‰©...</p>
          <small style="color: #999">è¯·ç¨å€™ï¼ŒAIæ­£åœ¨åˆ†ææ‚¨çš„å›¾ç‰‡</small>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
          "
        >
          <button
            onclick="closePhotoRecognitionDialog()"
            style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <script>
      // ç»§ç»­ä½¿ç”¨ä¹‹å‰å®Œæ•´çš„JavaScriptä»£ç 
      // å…¨å±€å˜é‡ï¼ˆæ·»åŠ åˆ†æç»“æœå­˜å‚¨ï¼‰
      var recordedFoods = {
        breakfast: [],
        lunch: [],
        dinner: [],
        snack: [],
      };
      var waterGlasses = new Array(8).fill(false);
      var userProfile = {};
      var nutritionPlan = {};
      var chatPageAI = null;
      var currentMealType = ""; // ç”¨äºè·Ÿè¸ªå½“å‰æ“ä½œçš„é¤é£Ÿç±»å‹
      var currentAnalysisResult = null; // å­˜å‚¨å½“å‰è¥å…»åˆ†æç»“æœ

      // APIé…ç½®
      var EDAMAM_API_ID = "dc898717";
      var EDAMAM_API_KEY = "b477cf9e5553f71d75f64d086ea37188";
      var EDAMAM_BASE_URL = "https://api.edamam.com/api/food-database/v2";

      // Spoonacular APIé…ç½®ï¼ˆç”¨äºç”Ÿæˆé¥®é£Ÿè®¡åˆ’ï¼‰
      var SPOONACULAR_API_KEY = "e26fdd72dfc249abac89fc085c020a67";
      var SPOONACULAR_BASE_URL = "https://api.spoonacular.com";

      // 2Brain AI APIé…ç½®
      var AI_API_CONFIG = {
        endpoint: "https://ai.2brain.cn/api/bot/chat/v1/chat/completions",
        token: "2B-WnYnyfZVPKJ39ACEnk8kiGLW5Dya8HRaxDtCL4LjkEmFbhP4Ec",
        headers: {
          "Content-Type": "application/json",
          Authorization:
            "Bearer 2B-WnYnyfZVPKJ39ACEnk8kiGLW5Dya8HRaxDtCL4LjkEmFbhP4Ec",
        },
      };

      // æœ¬åœ°é£Ÿç‰©æ•°æ®åº“ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
      var localFoodDatabase = [
        {
          id: 1,
          name: "ç‡•éº¦ç²¥",
          brand: "è¥å…»æ—©é¤",
          calories: 150,
          protein: 5,
          carbs: 27,
          fat: 3,
          unit: "ç¢—",
        },
        {
          id: 2,
          name: "å…¨éº¦é¢åŒ…",
          brand: "ä¸»é£Ÿ",
          calories: 80,
          protein: 4,
          carbs: 14,
          fat: 1,
          unit: "ç‰‡",
        },
        {
          id: 3,
          name: "ç…®é¸¡è›‹",
          brand: "è›‹ç™½è´¨",
          calories: 78,
          protein: 6,
          carbs: 0.6,
          fat: 5,
          unit: "ä¸ª",
        },
        {
          id: 4,
          name: "ç‰›å¥¶",
          brand: "ä¹³åˆ¶å“",
          calories: 83,
          protein: 8,
          carbs: 12,
          fat: 0.2,
          unit: "æ¯",
        },
        {
          id: 5,
          name: "é¸¡èƒ¸è‚‰",
          brand: "è›‹ç™½è´¨",
          calories: 165,
          protein: 31,
          carbs: 0,
          fat: 3.6,
          unit: "100g",
        },
        {
          id: 6,
          name: "ç±³é¥­",
          brand: "ä¸»é£Ÿ",
          calories: 116,
          protein: 2.6,
          carbs: 26,
          fat: 0.3,
          unit: "100g",
        },
        {
          id: 7,
          name: "è¥¿å…°èŠ±",
          brand: "è”¬èœ",
          calories: 34,
          protein: 2.8,
          carbs: 7,
          fat: 0.4,
          unit: "100g",
        },
        {
          id: 8,
          name: "è‹¹æœ",
          brand: "æ°´æœ",
          calories: 52,
          protein: 0.2,
          carbs: 14,
          fat: 0.2,
          unit: "100g",
        },
        {
          id: 9,
          name: "ä¸‰æ–‡é±¼",
          brand: "è›‹ç™½è´¨",
          calories: 208,
          protein: 20,
          carbs: 0,
          fat: 13,
          unit: "100g",
        },
        {
          id: 10,
          name: "é¦™è•‰",
          brand: "æ°´æœ",
          calories: 89,
          protein: 1.1,
          carbs: 23,
          fat: 0.3,
          unit: "æ ¹",
        },
      ];

      // === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===

      // æ‰“å¼€è‡ªå®šä¹‰é£Ÿç‰©å¯¹è¯æ¡†
      function openCustomFoodDialog(mealType) {
        currentMealType = mealType;
        document.getElementById("customFoodDialog").style.display = "flex";

        // é‡ç½®ç•Œé¢
        document.getElementById("customFoodName").value = "";
        document.getElementById("customFoodDescription").value = "";
        document.getElementById("nutritionAnalysisLoading").style.display =
          "none";
        document.getElementById("nutritionAnalysisResult").style.display =
          "none";
        document.getElementById("analyzeNutritionBtn").style.display =
          "inline-block";
        document.getElementById("addAnalyzedFoodBtn").style.display = "none";
        currentAnalysisResult = null;
      }

      // å…³é—­è‡ªå®šä¹‰é£Ÿç‰©å¯¹è¯æ¡†
      function closeCustomFoodDialog() {
        document.getElementById("customFoodDialog").style.display = "none";
        currentMealType = "";
        currentAnalysisResult = null;
      }

      // åˆ†æè‡ªå®šä¹‰é£Ÿç‰©è¥å…»
      async function analyzeCustomFood() {
        var foodName = document.getElementById("customFoodName").value.trim();
        var foodDescription = document
          .getElementById("customFoodDescription")
          .value.trim();

        if (!foodName || !foodDescription) {
          showNotification("è¯·å¡«å†™é£Ÿç‰©åç§°å’Œæè¿°", "warning");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById("nutritionAnalysisLoading").style.display =
          "block";
        document.getElementById("nutritionAnalysisResult").style.display =
          "none";
        document.getElementById("analyzeNutritionBtn").style.display = "none";

        try {
          // å°†æè¿°è½¬æ¢ä¸ºé£Ÿæåˆ—è¡¨
          var ingredients = foodDescription
            .split("\n")
            .filter((line) => line.trim());

          // ä½¿ç”¨Edamam APIåˆ†æè¥å…»
          var nutritionData = await calculateNutritionWithEdamam(ingredients);

          if (nutritionData) {
            // ä¿å­˜åˆ†æç»“æœ
            currentAnalysisResult = {
              name: foodName,
              nutrition: nutritionData,
              ingredients: ingredients,
            };

            // æ˜¾ç¤ºåˆ†æç»“æœ
            displayNutritionAnalysisResult(nutritionData);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById("nutritionAnalysisLoading").style.display =
              "none";
            document.getElementById("nutritionAnalysisResult").style.display =
              "block";
            document.getElementById("analyzeNutritionBtn").style.display =
              "none";
            document.getElementById("addAnalyzedFoodBtn").style.display =
              "inline-block";
          } else {
            throw new Error("è¥å…»åˆ†æå¤±è´¥");
          }
        } catch (error) {
          console.error("è¥å…»åˆ†æé”™è¯¯:", error);
          document.getElementById("nutritionAnalysisLoading").style.display =
            "none";
          document.getElementById("analyzeNutritionBtn").style.display =
            "inline-block";
          showNotification("è¥å…»åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥é£Ÿææè¿°æ ¼å¼", "error");
        }
      }

      // æ˜¾ç¤ºè¥å…»åˆ†æç»“æœ
      function displayNutritionAnalysisResult(nutritionData) {
        var resultContent = document.getElementById("analysisResultContent");
        resultContent.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>ğŸ”¥ æ€»çƒ­é‡</span>
                        <strong>${nutritionData.calories} kcal</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>ğŸ¥© è›‹ç™½è´¨</span>
                        <strong>${nutritionData.protein}g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>ğŸŒ¾ ç¢³æ°´åŒ–åˆç‰©</span>
                        <strong>${nutritionData.carbs}g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>ğŸ¥‘ è„‚è‚ª</span>
                        <strong>${nutritionData.fat}g</strong>
                    </div>
                    ${
                      nutritionData.fiber
                        ? `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>ğŸŒ¾ çº¤ç»´</span>
                        <strong>${nutritionData.fiber}g</strong>
                    </div>`
                        : ""
                    }
                </div>
            `;
      }

      // æ·»åŠ åˆ†æåçš„é£Ÿç‰©
      function addAnalyzedFood() {
        if (!currentAnalysisResult || !currentMealType) {
          showNotification("è¯·å…ˆå®Œæˆè¥å…»åˆ†æ", "warning");
          return;
        }

        var food = {
          id: "custom_" + Date.now(),
          name: currentAnalysisResult.name,
          calories: currentAnalysisResult.nutrition.calories,
          protein: currentAnalysisResult.nutrition.protein,
          carbs: currentAnalysisResult.nutrition.carbs,
          fat: currentAnalysisResult.nutrition.fat,
          fiber: currentAnalysisResult.nutrition.fiber || 0,
          unit: "ä»½",
          isCustom: true,
          isEdamamAnalyzed: true,
        };

        addFoodRecord(food, currentMealType, 1);
        closeCustomFoodDialog();
        showNotification("âœ… è‡ªå®šä¹‰é£Ÿç‰©å·²æ·»åŠ ", "success");
      }

      // æ·»åŠ è¯†åˆ«åçš„é£Ÿç‰©
      function addRecognizedFood(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));
          var quantity = prompt(
            "è¯·è¾“å…¥æ•°é‡ï¼ˆ" + (food.unit || "ä»½") + "ï¼‰:",
            "1"
          );

          if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
            addFoodRecord(food, currentMealType, parseFloat(quantity));
            showNotification("âœ… å·²æ·»åŠ  " + food.name, "success");

            // å¦‚æœè¿˜æœ‰å…¶ä»–è¯†åˆ«ç»“æœï¼Œä¿æŒå¯¹è¯æ¡†æ‰“å¼€
            var remainingItems = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            if (remainingItems.length <= 1) {
              closePhotoRecognitionDialog();
            }
          }
        } catch (error) {
          console.error("æ·»åŠ è¯†åˆ«é£Ÿç‰©å¤±è´¥:", error);
          showNotification("æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
        }
      }

      // ä½¿ç”¨Edamam APIæœç´¢é£Ÿç‰©
      async function searchFoodWithEdamam(query) {
        try {
          var url = `${EDAMAM_BASE_URL}/parser?app_id=${EDAMAM_API_ID}&app_key=${EDAMAM_API_KEY}&ingr=${encodeURIComponent(
            query
          )}&nutrition-type=cooking`;
          var response = await fetch(url);

          if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }

          var data = await response.json();

          if (!data.hints || data.hints.length === 0) {
            console.log("Edamam APIæœªæ‰¾åˆ°ç»“æœï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®åº“");
            return searchLocalFood(query);
          }

          return data.hints.slice(0, 5).map((hint) => {
            var food = hint.food;
            var nutrients = food.nutrients || {};

            return {
              id: "edamam_" + food.foodId,
              name: food.label,
              brand: food.brand || "Edamam Database",
              calories: Math.round(nutrients.ENERC_KCAL || 0),
              protein: Math.round((nutrients.PROCNT || 0) * 10) / 10,
              carbs: Math.round((nutrients.CHOCDF || 0) * 10) / 10,
              fat: Math.round((nutrients.FAT || 0) * 10) / 10,
              fiber: Math.round((nutrients.FIBTG || 0) * 10) / 10,
              sugar: Math.round((nutrients.SUGAR || 0) * 10) / 10,
              sodium: Math.round((nutrients.NA || 0) * 10) / 10,
              unit: "100g",
              image: food.image,
              foodId: food.foodId,
              measureURI:
                hint.measures && hint.measures[0] ? hint.measures[0].uri : null,
            };
          });
        } catch (error) {
          console.error("Edamam APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®åº“:", error);
          return searchLocalFood(query);
        }
      }

      // ä½¿ç”¨Edamam Nutrition Analysis APIè®¡ç®—ç²¾ç¡®è¥å…»æ•°æ®
      async function calculateNutritionWithEdamam(ingredients) {
        try {
          var url = `https://api.edamam.com/api/nutrition-details?app_id=${EDAMAM_API_ID}&app_key=${EDAMAM_API_KEY}`;

          var requestBody = {
            title: "User Meal Analysis",
            ingr: ingredients,
          };

          var response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(`è¥å…»åˆ†æAPIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }

          var data = await response.json();

          return {
            calories: Math.round(data.calories || 0),
            protein:
              Math.round((data.totalNutrients.PROCNT?.quantity || 0) * 10) / 10,
            carbs:
              Math.round((data.totalNutrients.CHOCDF?.quantity || 0) * 10) / 10,
            fat: Math.round((data.totalNutrients.FAT?.quantity || 0) * 10) / 10,
            fiber:
              Math.round((data.totalNutrients.FIBTG?.quantity || 0) * 10) / 10,
            sugar:
              Math.round((data.totalNutrients.SUGAR?.quantity || 0) * 10) / 10,
            sodium:
              Math.round((data.totalNutrients.NA?.quantity || 0) * 10) / 10,
            potassium:
              Math.round((data.totalNutrients.K?.quantity || 0) * 10) / 10,
            vitaminC:
              Math.round((data.totalNutrients.VITC?.quantity || 0) * 10) / 10,
            calcium:
              Math.round((data.totalNutrients.CA?.quantity || 0) * 10) / 10,
            iron: Math.round((data.totalNutrients.FE?.quantity || 0) * 10) / 10,
            weight: Math.round((data.totalWeight || 0) * 10) / 10,
          };
        } catch (error) {
          console.error("Edamamè¥å…»åˆ†æå¤±è´¥:", error);
          return null;
        }
      }

      // è·å–è¥å…»ç´ æ•°å€¼
      function getNutrientValue(nutrients, name) {
        var nutrient = nutrients.find((n) => n.name === name);
        return nutrient ? nutrient.amount : 0;
      }

      // æœç´¢æœ¬åœ°é£Ÿç‰©æ•°æ®åº“
      function searchLocalFood(query) {
        var searchTerm = query.toLowerCase().trim();
        return localFoodDatabase.filter(
          (food) =>
            food.name.toLowerCase().includes(searchTerm) ||
            food.brand.toLowerCase().includes(searchTerm)
        );
      }

      // é¡µé¢åˆ‡æ¢å‡½æ•°
      function showMainPage() {
        document.getElementById("mainContent").style.display = "grid";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("mainBtn").classList.add("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");
        displayPersonalPlan();
      }

      function showProfilePage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "block";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("profileBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");
        loadProfile();
      }

      function showChatPage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "block";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("chatBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");

        if (!chatPageAI) {
          initializeChatPageAI();
        }
      }

      function showDietPlanPage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "block";
        document.getElementById("dietPlanBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");

        loadSavedPlans();
      }

      // ä¿å­˜ä¸ªäººä¿¡æ¯
      function saveProfile() {
        var fullName = document.getElementById("fullName").value.trim();
        var gender = document.getElementById("gender").value;
        var birthDate = document.getElementById("birthDate").value;
        var height = document.getElementById("profileHeight").value;
        var weight = document.getElementById("profileWeight").value;
        var activityLevel = document.getElementById("activityLevel").value;

        if (
          !fullName ||
          !gender ||
          !birthDate ||
          !height ||
          !weight ||
          !activityLevel
        ) {
          showNotification("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼", "warning");
          return;
        }

        var checkedGoals = document.querySelectorAll(
          'input[type="checkbox"]:checked'
        );
        if (checkedGoals.length === 0) {
          showNotification("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå¥åº·ç›®æ ‡ï¼", "warning");
          return;
        }

        userProfile = {
          fullName: fullName,
          gender: gender,
          birthDate: birthDate,
          height: parseFloat(height),
          weight: parseFloat(weight),
          targetWeight:
            parseFloat(document.getElementById("targetWeight").value) || null,
          activityLevel: activityLevel,
          goals: Array.from(checkedGoals).map((cb) => cb.value),
        };

        generateNutritionPlan();
        saveUserData();
        showNotification("âœ… ä¸ªäººä¿¡æ¯å·²ä¿å­˜ï¼", "success");

        setTimeout(() => {
          showMainPage();
        }, 1500);
      }

      // ç”Ÿæˆè¥å…»è®¡åˆ’
      function generateNutritionPlan() {
        if (!userProfile.height || !userProfile.weight) {
          console.log("ç¼ºå°‘èº«ä½“æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤è¥å…»ç›®æ ‡");
          nutritionPlan = {
            bmi: 0,
            bmr: 0,
            targets: {
              calories: 2000,
              protein: 50,
              carbs: 250,
              fat: 65,
            },
          };
          updateNutritionTracking();
          return;
        }

        var bmi = userProfile.weight / Math.pow(userProfile.height / 100, 2);
        var age = getAge();
        var bmr;

        if (userProfile.gender === "male") {
          bmr =
            88.362 +
            13.397 * userProfile.weight +
            4.799 * userProfile.height -
            5.677 * age;
        } else {
          bmr =
            447.593 +
            9.247 * userProfile.weight +
            3.098 * userProfile.height -
            4.33 * age;
        }

        var activityMultipliers = {
          sedentary: 1.2,
          light: 1.375,
          moderate: 1.55,
          active: 1.725,
          "very-active": 1.9,
        };

        var multiplier = activityMultipliers[userProfile.activityLevel] || 1.2;
        var dailyCalories = Math.round(bmr * multiplier);

        if (userProfile.goals && userProfile.goals.includes("weight-loss")) {
          dailyCalories = Math.round(dailyCalories * 0.85);
        } else if (
          userProfile.goals &&
          userProfile.goals.includes("muscle-gain")
        ) {
          dailyCalories = Math.round(dailyCalories * 1.1);
        }

        nutritionPlan = {
          bmi: bmi,
          bmr: bmr,
          targets: {
            calories: dailyCalories,
            protein: Math.round((dailyCalories * 0.25) / 4),
            carbs: Math.round((dailyCalories * 0.45) / 4),
            fat: Math.round((dailyCalories * 0.3) / 9),
          },
        };

        updateNutritionTracking();
      }

      // è®¡ç®—å¹´é¾„
      function getAge() {
        if (!userProfile.birthDate) return 30;
        var birth = new Date(userProfile.birthDate);
        var today = new Date();
        var age = today.getFullYear() - birth.getFullYear();
        if (
          today.getMonth() < birth.getMonth() ||
          (today.getMonth() === birth.getMonth() &&
            today.getDate() < birth.getDate())
        ) {
          age--;
        }
        return age;
      }

      // æ˜¾ç¤ºä¸ªäººè®¡åˆ’
      function displayPersonalPlan() {
        var container = document.getElementById("personalPlanDisplay");

        if (!userProfile.fullName || !nutritionPlan.targets) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; background: #f0f0f0; border-radius: 15px;">' +
            '<p style="color: #666;">å°šæœªè®¾ç½®ä¸ªäººå¥åº·è®¡åˆ’</p>' +
            '<button onclick="showProfilePage()" style="margin-top: 15px;">ç«‹å³è®¾ç½®</button>' +
            "</div>";
          document.getElementById("bmiCalculator").style.display = "none";
          return;
        }

        container.innerHTML =
          '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">' +
          "<h3>ğŸ‘‹ " +
          userProfile.fullName +
          " çš„ä¸“å±è®¡åˆ’</h3>" +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px;">' +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.calories +
          "</div>" +
          '<div style="font-size: 0.9em;">æ¯æ—¥çƒ­é‡</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.protein +
          "g</div>" +
          '<div style="font-size: 0.9em;">è›‹ç™½è´¨</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.carbs +
          "g</div>" +
          '<div style="font-size: 0.9em;">ç¢³æ°´</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.fat +
          "g</div>" +
          '<div style="font-size: 0.9em;">è„‚è‚ª</div>' +
          "</div>" +
          "</div>" +
          "</div>";

        document.getElementById("bmiCalculator").style.display = "block";
        document.getElementById("bmiValue").textContent =
          nutritionPlan.bmi.toFixed(1);
        document.getElementById("bmiStatus").textContent = getBMIStatus(
          nutritionPlan.bmi
        );
      }

      // è·å–BMIçŠ¶æ€
      function getBMIStatus(bmi) {
        if (bmi < 18.5) return "åç˜¦";
        if (bmi < 24) return "æ­£å¸¸";
        if (bmi < 28) return "åèƒ–";
        return "è‚¥èƒ–";
      }

      // åˆ‡æ¢é¤é£ŸåŒºåŸŸ
      function toggleMealSection(mealType) {
        var section = document.getElementById(mealType + "Section");
        if (section) {
          section.classList.toggle("expanded");
        }
      }

      // æœç´¢å¤„ç†ï¼ˆæ›´æ–°ä¸ºå¼‚æ­¥ï¼‰
      async function handleSearchKeyUp(event, mealType) {
        if (event.key === "Enter") {
          await searchMealFood(mealType);
        }
      }

      // æœç´¢é£Ÿç‰©ï¼ˆæ›´æ–°ä¸ºä½¿ç”¨Edamam APIï¼‰
      async function searchMealFood(mealType) {
        var searchInput = document.getElementById(mealType + "SearchInput");
        var searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          showNotification("è¯·è¾“å…¥è¦æœç´¢çš„é£Ÿç‰©åç§°", "warning");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        var resultsContainer = document.getElementById(
          mealType + "SearchResults"
        );
        resultsContainer.innerHTML =
          '<div style="text-align: center; padding: 20px;"><div class="chat-typing-indicator"><span></span><span></span><span></span></div><p style="margin-top: 10px;">æ­£åœ¨æœç´¢é£Ÿç‰©...</p></div>';

        try {
          var results = await searchFoodWithEdamam(searchTerm);
          displayMealSearchResults(
            results.filter((r) => r !== null),
            mealType
          );
        } catch (error) {
          console.error("æœç´¢é£Ÿç‰©å¤±è´¥:", error);
          resultsContainer.innerHTML =
            '<p style="text-align: center; color: #ff4757;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
        }
      }

      // æ˜¾ç¤ºæœç´¢ç»“æœï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒæ›´å¤šè¥å…»ä¿¡æ¯ï¼‰
      function displayMealSearchResults(results, mealType) {
        var resultsContainer = document.getElementById(
          mealType + "SearchResults"
        );
        resultsContainer.innerHTML = "";

        if (results.length === 0) {
          resultsContainer.innerHTML =
            '<p style="text-align: center; color: #999;">æœªæ‰¾åˆ°ç›¸å…³é£Ÿç‰©</p>';
          return;
        }

        results.forEach((food) => {
          var resultItem = document.createElement("div");
          resultItem.className = "food-result-item";

          var imageHtml = "";
          if (food.image) {
            imageHtml = `<img src="${food.image}" 
                                style="width: 40px; height: 40px; border-radius: 8px; margin-right: 10px;" 
                                alt="${food.name}">`;
          }

          resultItem.innerHTML =
            '<div style="display: flex; align-items: center;">' +
            imageHtml +
            "<div>" +
            '<div style="font-weight: bold;">' +
            food.name +
            "</div>" +
            '<div style="font-size: 0.9em; color: #666;">' +
            food.brand +
            "</div>" +
            '<div style="margin-top: 5px;">' +
            '<span class="nutrition-badge">ğŸ”¥ ' +
            food.calories +
            " kcal</span>" +
            '<span class="nutrition-badge">ğŸ¥© ' +
            food.protein +
            "g</span>" +
            '<span class="nutrition-badge">ğŸŒ¾ ' +
            food.carbs +
            "g</span>" +
            '<span class="nutrition-badge">ğŸ¥‘ ' +
            food.fat +
            "g</span>" +
            (food.fiber
              ? '<span class="nutrition-badge">ğŸŒ¾ ' +
                food.fiber +
                "g çº¤ç»´</span>"
              : "") +
            "</div>" +
            "</div>" +
            "</div>" +
            '<button class="add-food-btn" onclick="addMealFoodFromSearch(\'' +
            encodeURIComponent(JSON.stringify(food)) +
            "', '" +
            mealType +
            "')\">æ·»åŠ </button>";
          resultsContainer.appendChild(resultItem);
        });
      }

      // æ·»åŠ é£Ÿç‰©ï¼ˆä»æœç´¢ç»“æœï¼‰- æ›´æ–°ä¸ºå¼‚æ­¥å‡½æ•°
      async function addMealFoodFromSearch(encodedFood, mealType) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));
          var quantity = prompt("è¯·è¾“å…¥æ•°é‡ï¼ˆ" + food.unit + "ï¼‰:", "1");
          if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
            await addFoodRecord(food, mealType, parseFloat(quantity));
          }
        } catch (error) {
          console.error("æ·»åŠ é£Ÿç‰©å¤±è´¥:", error);
          showNotification("æ·»åŠ é£Ÿç‰©å¤±è´¥", "error");
        }
      }

      // æ·»åŠ é£Ÿç‰©ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
      function addMealFood(foodId, mealType) {
        var food = localFoodDatabase.find((f) => f.id === foodId);
        if (!food) return;

        var quantity = prompt("è¯·è¾“å…¥æ•°é‡ï¼ˆ" + food.unit + "ï¼‰:", "1");
        if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
          addFoodRecord(food, mealType, parseFloat(quantity));
        }
      }

      // æ·»åŠ é£Ÿç‰©è®°å½•ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒEdamamç²¾ç¡®è¥å…»è®¡ç®—ï¼‰
      async function addFoodRecord(food, mealType, quantity) {
        try {
          // å¦‚æœæ˜¯Edamamé£Ÿç‰©ï¼Œä½¿ç”¨ç²¾ç¡®çš„è¥å…»åˆ†æ
          var nutritionData;
          if (food.id && food.id.startsWith("edamam_") && food.foodId) {
            var ingredient = `${quantity * 100}g ${food.name}`;
            nutritionData = await calculateNutritionWithEdamam([ingredient]);
          }

          // ä½¿ç”¨ç²¾ç¡®è¥å…»æ•°æ®æˆ–åŸå§‹æ•°æ®
          var recordedFood = {
            id: food.id,
            name: food.name,
            calories: nutritionData
              ? nutritionData.calories
              : Math.round(food.calories * quantity),
            protein: nutritionData
              ? nutritionData.protein
              : Math.round(food.protein * quantity * 10) / 10,
            carbs: nutritionData
              ? nutritionData.carbs
              : Math.round(food.carbs * quantity * 10) / 10,
            fat: nutritionData
              ? nutritionData.fat
              : Math.round(food.fat * quantity * 10) / 10,
            fiber: nutritionData
              ? nutritionData.fiber
              : food.fiber
              ? Math.round(food.fiber * quantity * 10) / 10
              : 0,
            sugar: nutritionData
              ? nutritionData.sugar
              : food.sugar
              ? Math.round(food.sugar * quantity * 10) / 10
              : 0,
            sodium: nutritionData
              ? nutritionData.sodium
              : food.sodium
              ? Math.round(food.sodium * quantity * 10) / 10
              : 0,
            recordId: Date.now(),
            quantity: quantity,
            unit: food.unit,
            isEdamamAnalyzed: !!nutritionData,
          };

          recordedFoods[mealType].push(recordedFood);
          updateMealRecorded(mealType);
          updateNutritionTracking();
          saveUserData();

          document.getElementById(mealType + "SearchInput").value = "";
          document.getElementById(mealType + "SearchResults").innerHTML = "";

          var message = nutritionData
            ? "âœ… å·²æ·»åŠ  " + food.name + " (ä½¿ç”¨Edamamç²¾ç¡®åˆ†æ)"
            : "âœ… å·²æ·»åŠ  " + food.name;
          showNotification(message, "success");
        } catch (error) {
          console.error("æ·»åŠ é£Ÿç‰©å¤±è´¥:", error);
          // å¦‚æœç²¾ç¡®åˆ†æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®
          var recordedFood = {
            id: food.id,
            name: food.name,
            calories: Math.round(food.calories * quantity),
            protein: Math.round(food.protein * quantity * 10) / 10,
            carbs: Math.round(food.carbs * quantity * 10) / 10,
            fat: Math.round(food.fat * quantity * 10) / 10,
            recordId: Date.now(),
            quantity: quantity,
            unit: food.unit,
          };

          recordedFoods[mealType].push(recordedFood);
          updateMealRecorded(mealType);
          updateNutritionTracking();
          saveUserData();

          showNotification("âœ… å·²æ·»åŠ  " + food.name, "success");
        }
      }

      // æ›´æ–°å·²è®°å½•é£Ÿç‰©ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ˜¾ç¤ºæ›´å¤šè¥å…»ä¿¡æ¯ï¼‰
      function updateMealRecorded(mealType) {
        var container = document.getElementById(mealType + "RecordedList");
        if (!container) return;

        container.innerHTML = "";
        var mealFoods = recordedFoods[mealType];

        if (mealFoods.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">æš‚æ— è®°å½•</p>';
          return;
        }

        mealFoods.forEach((food) => {
          var item = document.createElement("div");
          item.style =
            "background: white; padding: 10px; margin: 5px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;";

          var nutritionInfo =
            food.calories + " kcal | è›‹ç™½è´¨ " + food.protein + "g";
          if (food.fiber && food.fiber > 0) {
            nutritionInfo += " | çº¤ç»´ " + food.fiber + "g";
          }
          if (food.isEdamamAnalyzed) {
            nutritionInfo += " ğŸ”¬";
          }

          item.innerHTML =
            "<div>" +
            "<strong>" +
            food.name +
            "</strong>" +
            (food.quantity > 1 ? " x" + food.quantity : "") +
            '<div style="font-size: 0.9em; color: #666;">' +
            nutritionInfo +
            "</div>" +
            "</div>" +
            '<button onclick="deleteMealFood(' +
            food.recordId +
            ", '" +
            mealType +
            "')\" " +
            'style="background: #ff4757; color: white; border: none; padding: 5px 10px; ' +
            'border-radius: 5px; cursor: pointer;">åˆ é™¤</button>';
          container.appendChild(item);
        });
      }

      // åˆ é™¤é£Ÿç‰©
      function deleteMealFood(recordId, mealType) {
        recordedFoods[mealType] = recordedFoods[mealType].filter(
          (food) => food.recordId !== recordId
        );
        updateMealRecorded(mealType);
        updateNutritionTracking();
        saveUserData();
        showNotification("å·²åˆ é™¤", "success");
      }

      // è·å–å½“å‰è¥å…»æ‘„å…¥ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒæ›´å¤šè¥å…»ç´ ï¼‰
      function getCurrentNutrition() {
        var totals = {
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sugar: 0,
          sodium: 0,
        };

        Object.keys(recordedFoods).forEach((mealType) => {
          recordedFoods[mealType].forEach((food) => {
            totals.calories += food.calories || 0;
            totals.protein += food.protein || 0;
            totals.carbs += food.carbs || 0;
            totals.fat += food.fat || 0;
            totals.fiber += food.fiber || 0;
            totals.sugar += food.sugar || 0;
            totals.sodium += food.sodium || 0;
          });
        });

        return totals;
      }

      // æ›´æ–°è¥å…»è¿½è¸ªï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ˜¾ç¤ºæ›´å¤šè¥å…»ä¿¡æ¯ï¼‰
      function updateNutritionTracking() {
        var totals = getCurrentNutrition();
        var targets = nutritionPlan.targets || {
          calories: 2000,
          protein: 50,
          carbs: 250,
          fat: 65,
        };

        // æ›´æ–°åŸºç¡€è¥å…»ç´ æ˜¾ç¤º
        document.getElementById("calorieValue").textContent = Math.round(
          totals.calories
        );
        document.getElementById("proteinValue").textContent =
          totals.protein.toFixed(1) + "g";
        document.getElementById("carbValue").textContent =
          totals.carbs.toFixed(1) + "g";
        document.getElementById("fatValue").textContent =
          totals.fat.toFixed(1) + "g";

        document.getElementById("calorieTarget").textContent =
          "ç›®æ ‡: " + targets.calories;
        document.getElementById("proteinTarget").textContent =
          "ç›®æ ‡: " + targets.protein + "g";
        document.getElementById("carbTarget").textContent =
          "ç›®æ ‡: " + targets.carbs + "g";
        document.getElementById("fatTarget").textContent =
          "ç›®æ ‡: " + targets.fat + "g";

        // æ›´æ–°è¿›åº¦æ¡
        document.getElementById("calorieProgress").style.width =
          Math.min(100, (totals.calories / targets.calories) * 100) + "%";
        document.getElementById("proteinProgress").style.width =
          Math.min(100, (totals.protein / targets.protein) * 100) + "%";
        document.getElementById("carbProgress").style.width =
          Math.min(100, (totals.carbs / targets.carbs) * 100) + "%";
        document.getElementById("fatProgress").style.width =
          Math.min(100, (totals.fat / targets.fat) * 100) + "%";

        // å¦‚æœæœ‰é¢å¤–çš„è¥å…»ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸï¼Œæ›´æ–°å®ƒä»¬
        updateAdditionalNutritionInfo(totals);
      }

      // æ›´æ–°é¢å¤–è¥å…»ä¿¡æ¯
      function updateAdditionalNutritionInfo(totals) {
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é¢å¤–è¥å…»ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        var extraNutritionContainer = document.getElementById("extraNutrition");
        if (!extraNutritionContainer) {
          // å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ª
          var nutritionGrid = document.getElementById("nutritionGrid");
          if (nutritionGrid && (totals.fiber > 0 || totals.sodium > 0)) {
            if (totals.fiber > 0) {
              var fiberStat = document.createElement("div");
              fiberStat.className = "nutrition-stat";
              fiberStat.innerHTML =
                "<h4>ğŸŒ¾ è†³é£Ÿçº¤ç»´</h4>" +
                '<div class="nutrition-value">' +
                totals.fiber.toFixed(1) +
                "g</div>" +
                '<div class="nutrition-target">æ¨è: 25-35g</div>' +
                '<div class="progress-bar">' +
                '<div class="progress-fill" style="width: ' +
                Math.min(100, (totals.fiber / 25) * 100) +
                '%"></div>' +
                "</div>";
              nutritionGrid.appendChild(fiberStat);
            }

            if (totals.sodium > 0) {
              var sodiumStat = document.createElement("div");
              sodiumStat.className = "nutrition-stat";
              var sodiumMg = totals.sodium * 1000; // è½¬æ¢ä¸ºæ¯«å…‹
              sodiumStat.innerHTML =
                "<h4>ğŸ§‚ é’ </h4>" +
                '<div class="nutrition-value">' +
                Math.round(sodiumMg) +
                "mg</div>" +
                '<div class="nutrition-target">é™åˆ¶: <2300mg</div>' +
                '<div class="progress-bar">' +
                '<div class="progress-fill" style="width: ' +
                Math.min(100, (sodiumMg / 2300) * 100) +
                "%; background: " +
                (sodiumMg > 2300 ? "#ff4757" : "white") +
                '"></div>' +
                "</div>";
              nutritionGrid.appendChild(sodiumStat);
            }
          }
        }
      }

      // é¥®æ°´è¿½è¸ª
      function toggleWater(index) {
        waterGlasses[index] = !waterGlasses[index];
        updateWaterDisplay();
        saveUserData();
      }

      // æ›´æ–°é¥®æ°´æ˜¾ç¤º
      function updateWaterDisplay() {
        var glasses = document.querySelectorAll(".water-glass");
        var filledCount = 0;

        glasses.forEach((glass, index) => {
          if (waterGlasses[index]) {
            glass.classList.add("filled");
            filledCount++;
          } else {
            glass.classList.remove("filled");
          }
        });

        document.getElementById("waterCount").innerHTML =
          'å·²é¥®ç”¨: <span style="font-weight: bold; color: #2196F3;">' +
          filledCount +
          "</span> æ¯ " +
          '(<span style="font-weight: bold; color: #2196F3;">' +
          filledCount * 250 +
          "</span> ml)";
      }

      // åŠ è½½ä¸ªäººä¿¡æ¯
      function loadProfile() {
        if (userProfile.fullName) {
          document.getElementById("fullName").value =
            userProfile.fullName || "";
          document.getElementById("gender").value = userProfile.gender || "";
          document.getElementById("birthDate").value =
            userProfile.birthDate || "";
          document.getElementById("profileHeight").value =
            userProfile.height || "";
          document.getElementById("profileWeight").value =
            userProfile.weight || "";
          document.getElementById("targetWeight").value =
            userProfile.targetWeight || "";
          document.getElementById("activityLevel").value =
            userProfile.activityLevel || "";
          document.getElementById("phone").value = userProfile.phone || "";

          // åŠ è½½å¥åº·ç›®æ ‡
          if (userProfile.goals) {
            userProfile.goals.forEach((goal) => {
              var checkbox = document.getElementById("goal-" + goal);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
        }
      }

      // è®¡ç®—è¥å…»ç›®æ ‡
      function calculateNutritionTargets() {
        // å¦‚æœå·²æœ‰è¥å…»è®¡åˆ’ï¼Œç›´æ¥ä½¿ç”¨
        if (nutritionPlan.targets) {
          return nutritionPlan.targets;
        }

        // å¦‚æœæ²¡æœ‰ä¸ªäººä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if (!userProfile.height || !userProfile.weight) {
          return {
            calories: 2000,
            protein: 50,
            carbs: 250,
            fat: 65,
          };
        }

        // é‡æ–°ç”Ÿæˆè¥å…»è®¡åˆ’
        generateNutritionPlan();
        return (
          nutritionPlan.targets || {
            calories: 2000,
            protein: 50,
            carbs: 250,
            fat: 65,
          }
        );
      }

      // é¥®é£Ÿè®¡åˆ’ç”ŸæˆåŠŸèƒ½ - ä½¿ç”¨Spoonacular API
      var currentDietPlan = null;
      var savedDietPlans = [];

      // ç”Ÿæˆé¥®é£Ÿè®¡åˆ’ï¼ˆä¼˜åŒ–é…é¢ä¸è¶³å¤„ç†ï¼‰
      async function generateDietPlan() {
        if (!userProfile.height || !userProfile.weight) {
          showNotification("è¯·å…ˆå®Œå–„ä¸ªäººä¿¡æ¯ï¼", "warning");
          showProfilePage();
          return;
        }

        var generateBtn = document.querySelector(".generate-plan-btn");
        var originalText = generateBtn.innerHTML;

        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          generateBtn.disabled = true;
          generateBtn.innerHTML =
            '<span class="loading-spinner"></span> æ­£åœ¨ç”Ÿæˆé¥®é£Ÿè®¡åˆ’...';

          // è·å–è¡¨å•å‚æ•°
          var planParams = {
            duration: document.getElementById("planDuration").value,
            diet: document.getElementById("dietType").value,
            intolerances: getSelectedIntolerances(),
            exclude: document.getElementById("excludeIngredients").value.trim(),
          };

          // è®¡ç®—è¥å…»ç›®æ ‡
          var nutritionTargets = calculateNutritionTargets();

          console.log(
            "å¼€å§‹ç”Ÿæˆé¥®é£Ÿè®¡åˆ’ï¼Œå‚æ•°:",
            planParams,
            "è¥å…»ç›®æ ‡:",
            nutritionTargets
          );

          var dietPlan = null;
          var useSpoonacular = false; // ç”±äºé…é¢ä¸è¶³ï¼Œé»˜è®¤ä½¿ç”¨æœ¬åœ°æ–¹æ¡ˆ

          // æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯
          showNotification(
            "ğŸ’¡ Spoonacular APIé…é¢å·²ç”¨å®Œï¼Œä¸ºæ‚¨å¯ç”¨é«˜çº§æœ¬åœ°æ™ºèƒ½æ–¹æ¡ˆ",
            "info"
          );

          // ç›´æ¥ä½¿ç”¨å¢å¼ºçš„æœ¬åœ°æ–¹æ¡ˆ
          try {
            generateBtn.innerHTML =
              '<span class="loading-spinner"></span> ä½¿ç”¨AIæ™ºèƒ½æœ¬åœ°æ–¹æ¡ˆç”Ÿæˆ...';
            console.log("ä½¿ç”¨å¢å¼ºAIæœ¬åœ°æ–¹æ¡ˆ...");

            dietPlan = await generateEnhancedLocalPlan(
              planParams,
              nutritionTargets
            );
            console.log("AIæœ¬åœ°æ–¹æ¡ˆç”ŸæˆæˆåŠŸï¼");
          } catch (localError) {
            console.error("AIæœ¬åœ°æ–¹æ¡ˆå¤±è´¥:", localError);

            // æœ€åçš„ä¿é™©æ–¹æ¡ˆ
            generateBtn.innerHTML =
              '<span class="loading-spinner"></span> ä½¿ç”¨åŸºç¡€è¥å…»æ–¹æ¡ˆ...';
            dietPlan = generateBasicFallbackPlan(planParams, nutritionTargets);
            console.log("åŸºç¡€æ–¹æ¡ˆç”Ÿæˆå®Œæˆ");
          }

          if (dietPlan && dietPlan.days && dietPlan.days.length > 0) {
            currentDietPlan = dietPlan;
            displayDietPlan(dietPlan);

            // æ ¹æ®ç”Ÿæˆæ–¹å¼æ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
            var successMessage = "";
            if (dietPlan.isEnhancedLocal) {
              successMessage =
                "âœ… æ™ºèƒ½é¥®é£Ÿè®¡åˆ’ç”ŸæˆæˆåŠŸï¼ä½¿ç”¨AIæœ¬åœ°æ–¹æ¡ˆ + Edamamç²¾ç¡®è¥å…»åˆ†æ";
            } else if (dietPlan.days.some((day) => day.isEdamamAnalyzed)) {
              successMessage =
                "âœ… é¥®é£Ÿè®¡åˆ’ç”ŸæˆæˆåŠŸï¼ä½¿ç”¨æœ¬åœ°æ–¹æ¡ˆ + Edamamç²¾ç¡®è¥å…»åˆ†æ";
            } else {
              successMessage = "âœ… é¥®é£Ÿè®¡åˆ’ç”ŸæˆæˆåŠŸï¼ä½¿ç”¨åŸºç¡€è¥å…»ä¼°ç®—";
            }

            showNotification(successMessage, "success");
          } else {
            throw new Error("ç”Ÿæˆçš„é¥®é£Ÿè®¡åˆ’æ— æ•ˆ");
          }
        } catch (error) {
          console.error("ç”Ÿæˆé¥®é£Ÿè®¡åˆ’å®Œå…¨å¤±è´¥:", error);
          showNotification("âŒ ç”Ÿæˆé¥®é£Ÿè®¡åˆ’å¤±è´¥: " + error.message, "error");
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = originalText;
        }
      }

      // è°ƒç”¨Spoonacularé¥®é£Ÿè®¡åˆ’API
      async function callSpoonacularMealPlan(params, targets) {
        try {
          var timeFrame = params.duration === "week" ? "week" : "day";
          var targetCalories = targets.calories;

          console.log("è°ƒç”¨Spoonacular APIï¼Œå‚æ•°:", {
            timeFrame,
            targetCalories,
            params,
          });

          var url = `${SPOONACULAR_BASE_URL}/mealplanner/generate`;
          var queryParams = new URLSearchParams({
            apiKey: SPOONACULAR_API_KEY,
            timeFrame: timeFrame,
            targetCalories: targetCalories,
          });

          if (params.diet) queryParams.append("diet", params.diet);
          if (params.intolerances)
            queryParams.append("intolerances", params.intolerances);
          if (params.exclude) queryParams.append("exclude", params.exclude);

          var finalUrl = `${url}?${queryParams.toString()}`;
          console.log("APIè¯·æ±‚URL:", finalUrl);

          var response = await fetch(finalUrl);

          if (!response.ok) {
            console.error(
              "Spoonacular APIè¯·æ±‚å¤±è´¥:",
              response.status,
              response.statusText
            );
            throw new Error(`Spoonacular APIé”™è¯¯: ${response.status}`);
          }

          var data = await response.json();
          console.log("Spoonacular APIå“åº”:", data);

          // å¤„ç†APIå“åº”æ•°æ®
          var processedPlan = await processMealPlanData(data, params, targets);
          return processedPlan;
        } catch (error) {
          console.error("Spoonacular APIè°ƒç”¨å¤±è´¥:", error);
          showNotification("APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ç”Ÿæˆè®¡åˆ’", "warning");
          // ç”Ÿæˆæœ¬åœ°æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºfallback
          return generateFallbackPlan(params, targets);
        }
      }

      // å¤„ç†Spoonacularè¿”å›çš„é¥®é£Ÿè®¡åˆ’æ•°æ®ï¼Œä½¿ç”¨Edamamè¿›è¡Œè¥å…»è®¡ç®—
      async function processMealPlanDataWithEdamam(data, params, targets) {
        var plan = {
          id: "plan_" + Date.now(),
          name: `${
            params.duration === "week" ? "7å¤©" : "1å¤©"
          }æ™ºèƒ½é¥®é£Ÿè®¡åˆ’ (Spoonacular)`,
          createdAt: new Date().toISOString(),
          duration: params.duration,
          totalCalories: 0,
          totalProtein: 0,
          totalCarbs: 0,
          totalFat: 0,
          days: [],
        };

        console.log("å¤„ç†Spoonacularæ•°æ®ï¼Œä½¿ç”¨Edamamè®¡ç®—è¥å…»:", data);

        try {
          if (params.duration === "week" && data.week) {
            // å¤„ç†å‘¨è®¡åˆ’
            var dayKeys = Object.keys(data.week);
            console.log("å‘¨è®¡åˆ’åŒ…å«å¤©æ•°:", dayKeys);

            for (var i = 0; i < dayKeys.length; i++) {
              var dayKey = dayKeys[i];
              var dayData = data.week[dayKey];
              console.log(`å¤„ç†${dayKey}çš„æ•°æ®:`, dayData);

              var dayName =
                ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"][i] ||
                dayKey;
              var dayPlan = await processDayPlanWithEdamam(dayData, dayName);
              plan.days.push(dayPlan);

              plan.totalCalories += dayPlan.calories || 0;
              plan.totalProtein += dayPlan.protein || 0;
              plan.totalCarbs += dayPlan.carbs || 0;
              plan.totalFat += dayPlan.fat || 0;
            }
          } else if (data.meals && Array.isArray(data.meals)) {
            // å¤„ç†å•æ—¥è®¡åˆ’
            console.log("å¤„ç†å•æ—¥è®¡åˆ’:", data.meals);
            var dayPlan = await processDayPlanWithEdamam(data, "ä»Šæ—¥");
            plan.days.push(dayPlan);

            plan.totalCalories = dayPlan.calories || 0;
            plan.totalProtein = dayPlan.protein || 0;
            plan.totalCarbs = dayPlan.carbs || 0;
            plan.totalFat = dayPlan.fat || 0;
          } else {
            console.warn("Spoonacularå“åº”æ ¼å¼å¼‚å¸¸:", data);
            throw new Error("Spoonacularè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
          }

          console.log("Spoonacularè®¡åˆ’å¤„ç†å®Œæˆ:", plan);
          return plan;
        } catch (error) {
          console.error("å¤„ç†Spoonacularæ•°æ®å¤±è´¥:", error);
          throw error;
        }
      }

      // å¤„ç†å•æ—¥è®¡åˆ’æ•°æ®ï¼Œä½¿ç”¨Edamamè®¡ç®—è¥å…»ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
      async function processDayPlanWithEdamam(dayData, dayName) {
        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: {
            breakfast: [],
            lunch: [],
            dinner: [],
          },
        };

        console.log(`å¼€å§‹å¤„ç†${dayName}çš„é¤é£Ÿ:`, dayData);

        var dayIngredients = [];
        var mealDetails = [];

        try {
          if (dayData.meals && Array.isArray(dayData.meals)) {
            // è·å–æ¯ä¸ªé¤é£Ÿçš„è¯¦ç»†ä¿¡æ¯
            for (var i = 0; i < Math.min(dayData.meals.length, 3); i++) {
              // é™åˆ¶æœ€å¤š3é¤
              var meal = dayData.meals[i];
              var mealType = getMealType(meal.id, i);

              console.log(`è·å–é¤é£Ÿ ${meal.id} çš„è¯¦ç»†ä¿¡æ¯...`);

              try {
                var mealInfo = await getSpoonacularMealDetails(meal.id);

                if (mealInfo && mealInfo.title) {
                  console.log(`é¤é£Ÿä¿¡æ¯è·å–æˆåŠŸ:`, mealInfo);
                  dayPlan.meals[mealType].push(mealInfo);
                  mealDetails.push(mealInfo);

                  // æ·»åŠ åˆ°Edamamåˆ†æçš„é…æ–™åˆ—è¡¨
                  dayIngredients.push(`1 serving ${mealInfo.title}`);
                } else {
                  throw new Error("é¤é£Ÿä¿¡æ¯ä¸å®Œæ•´");
                }
              } catch (mealError) {
                console.warn(
                  `é¤é£Ÿ ${meal.id} è·å–å¤±è´¥:`,
                  mealError,
                  "ä½¿ç”¨å¤‡ç”¨æ•°æ®"
                );
                var fallbackMeal = generateFallbackMealItem(meal, mealType, i);
                dayPlan.meals[mealType].push(fallbackMeal);
                mealDetails.push(fallbackMeal);
                dayIngredients.push(`1 serving ${fallbackMeal.title}`);
              }

              // æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
              await new Promise((resolve) => setTimeout(resolve, 200));
            }
          }

          // ä½¿ç”¨Edamam APIè®¡ç®—æ•´æ—¥è¥å…»
          if (dayIngredients.length > 0) {
            console.log(`ä½¿ç”¨Edamamåˆ†æ${dayName}çš„è¥å…»:`, dayIngredients);

            try {
              var edamamNutrition = await calculateNutritionWithEdamam(
                dayIngredients
              );

              if (edamamNutrition && edamamNutrition.calories > 0) {
                console.log(`Edamamè¥å…»åˆ†ææˆåŠŸ:`, edamamNutrition);
                dayPlan.calories = edamamNutrition.calories;
                dayPlan.protein = edamamNutrition.protein;
                dayPlan.carbs = edamamNutrition.carbs;
                dayPlan.fat = edamamNutrition.fat;
                dayPlan.fiber = edamamNutrition.fiber || 0;
                dayPlan.sodium = edamamNutrition.sodium || 0;
                dayPlan.isEdamamAnalyzed = true;
              } else {
                throw new Error("Edamamè¿”å›çš„è¥å…»æ•°æ®æ— æ•ˆ");
              }
            } catch (edamamError) {
              console.warn("Edamamè¥å…»åˆ†æå¤±è´¥:", edamamError, "ä½¿ç”¨ä¼°ç®—å€¼");
              // å¦‚æœEdamamåˆ†æå¤±è´¥ï¼Œä½¿ç”¨ä¼°ç®—è¥å…»æ•°æ®
              var estimatedNutrition = calculateEstimatedNutrition(mealDetails);
              dayPlan.calories = estimatedNutrition.calories;
              dayPlan.protein = estimatedNutrition.protein;
              dayPlan.carbs = estimatedNutrition.carbs;
              dayPlan.fat = estimatedNutrition.fat;
              dayPlan.isEdamamAnalyzed = false;
            }
          } else {
            console.warn(`${dayName}æ²¡æœ‰æœ‰æ•ˆçš„é¤é£Ÿæ•°æ®`);
            // ä½¿ç”¨é»˜è®¤è¥å…»å€¼
            dayPlan.calories = 500;
            dayPlan.protein = 25;
            dayPlan.carbs = 60;
            dayPlan.fat = 15;
          }

          console.log(`${dayName}æœ€ç»ˆè¥å…»æ•°æ®:`, {
            calories: dayPlan.calories,
            protein: dayPlan.protein,
            carbs: dayPlan.carbs,
            fat: dayPlan.fat,
            isEdamamAnalyzed: dayPlan.isEdamamAnalyzed,
          });

          return dayPlan;
        } catch (error) {
          console.error(`å¤„ç†${dayName}å¤±è´¥:`, error);
          // è¿”å›åŸºç¡€è®¡åˆ’
          dayPlan.calories = 500;
          dayPlan.protein = 25;
          dayPlan.carbs = 60;
          dayPlan.fat = 15;
          return dayPlan;
        }
      }

      // è·å–Spoonacularé¤é£Ÿè¯¦ç»†ä¿¡æ¯ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
      async function getSpoonacularMealDetails(mealId) {
        try {
          var url = `${SPOONACULAR_BASE_URL}/recipes/${mealId}/information?includeNutrition=false&apiKey=${SPOONACULAR_API_KEY}`;
          console.log(`è¯·æ±‚Spoonacularé¤é£Ÿè¯¦æƒ…: ${url}`);

          var response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          var data = await response.json();
          console.log(`Spoonacularé¤é£Ÿ ${mealId} æ•°æ®:`, data);

          if (!data.title) {
            throw new Error("é¤é£Ÿæ ‡é¢˜ç¼ºå¤±");
          }

          return {
            id: data.id,
            title: data.title,
            image: data.image || null,
            readyInMinutes: data.readyInMinutes || 30,
            servings: data.servings || 1,
            sourceUrl: data.sourceUrl || null,
            // è¥å…»æ•°æ®å°†ç”±Edamamç»Ÿä¸€è®¡ç®—
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0,
          };
        } catch (error) {
          console.error(`è·å–é¤é£Ÿ ${mealId} ä¿¡æ¯å¤±è´¥:`, error);
          throw error;
        }
      }

      // è®¡ç®—ä¼°ç®—è¥å…»æ•°æ®ï¼ˆå½“Edamamå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      function calculateEstimatedNutrition(mealDetails) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0 };

        mealDetails.forEach((meal) => {
          // å¦‚æœæœ‰å…·ä½“è¥å…»æ•°æ®å°±ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨ä¼°ç®—å€¼
          if (meal.calories > 0) {
            total.calories += meal.calories;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
          } else {
            // åŸºäºé¤é£Ÿç±»å‹çš„ä¼°ç®—å€¼
            total.calories += 350; // å¹³å‡æ¯é¤350å¡è·¯é‡Œ
            total.protein += 20; // å¹³å‡æ¯é¤20gè›‹ç™½è´¨
            total.carbs += 30; // å¹³å‡æ¯é¤30gç¢³æ°´
            total.fat += 12; // å¹³å‡æ¯é¤12gè„‚è‚ª
          }
        });

        return total;
      }

      // è·å–è¥å…»ç´ æ•°å€¼ - å…¼å®¹Spoonacularæ ¼å¼
      function getNutrientValue(nutrients, name) {
        if (!nutrients || !Array.isArray(nutrients)) return 0;

        // å°è¯•å¤šç§å¯èƒ½çš„è¥å…»ç´ åç§°
        var possibleNames = {
          Calories: ["Calories", "Energy", "Kcal"],
          Protein: ["Protein"],
          Carbohydrates: ["Carbohydrates", "Total Carbohydrate", "Carbs"],
          Fat: ["Fat", "Total Fat", "Total Lipid"],
        };

        var names = possibleNames[name] || [name];

        for (var i = 0; i < names.length; i++) {
          var nutrientName = names[i];
          var nutrient = nutrients.find(function (n) {
            return (
              n.name === nutrientName ||
              n.title === nutrientName ||
              (n.name &&
                n.name.toLowerCase().includes(nutrientName.toLowerCase()))
            );
          });
          if (nutrient && nutrient.amount) {
            return nutrient.amount;
          }
        }

        return 0;
      }

      // ç”Ÿæˆå¤‡ç”¨é¤é£Ÿé¡¹ç›®
      function generateFallbackMealItem(meal, mealType, index) {
        var fallbackNutrition = {
          breakfast: { calories: 300, protein: 12, carbs: 40, fat: 8 },
          lunch: { calories: 450, protein: 25, carbs: 35, fat: 18 },
          dinner: { calories: 400, protein: 22, carbs: 30, fat: 15 },
        };

        var nutrition = fallbackNutrition[mealType] || fallbackNutrition.lunch;

        return {
          id: meal.id || "fallback_" + index,
          title: meal.title || `${mealType} é¤é£Ÿ`,
          image: meal.image || null,
          readyInMinutes: 30,
          servings: 1,
          calories: nutrition.calories,
          protein: nutrition.protein,
          carbs: nutrition.carbs,
          fat: nutrition.fat,
          sourceUrl: meal.sourceUrl || null,
        };
      }

      // è·å–é¤é£Ÿè¯¦ç»†ä¿¡æ¯
      async function getMealDetails(mealId) {
        try {
          var url = `${SPOONACULAR_BASE_URL}/recipes/${mealId}/information?includeNutrition=true&apiKey=${SPOONACULAR_API_KEY}`;
          var response = await fetch(url);

          if (!response.ok) {
            console.warn(`è·å–é¤é£Ÿ ${mealId} ä¿¡æ¯å¤±è´¥: ${response.status}`);
            return null;
          }

          var data = await response.json();

          // è·å–è¥å…»ä¿¡æ¯
          var nutrition = data.nutrition?.nutrients || [];
          var calories = getNutrientValue(nutrition, "Calories");
          var protein = getNutrientValue(nutrition, "Protein");
          var carbs = getNutrientValue(nutrition, "Carbohydrates");
          var fat = getNutrientValue(nutrition, "Fat");

          console.log(`é¤é£Ÿ ${data.title} è¥å…»ä¿¡æ¯:`, {
            calories,
            protein,
            carbs,
            fat,
          });

          return {
            id: data.id,
            title: data.title,
            image: data.image,
            readyInMinutes: data.readyInMinutes,
            servings: data.servings,
            calories: Math.round(calories || 0),
            protein: Math.round((protein || 0) * 10) / 10,
            carbs: Math.round((carbs || 0) * 10) / 10,
            fat: Math.round((fat || 0) * 10) / 10,
            sourceUrl: data.sourceUrl,
          };
        } catch (error) {
          console.error("è·å–é¤é£Ÿä¿¡æ¯å¤±è´¥:", error);
          return null;
        }
      }

      // ä½¿ç”¨Spoonacular APIç”Ÿæˆé¥®é£Ÿè®¡åˆ’ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
      async function callSpoonacularMealPlan(params, targets) {
        try {
          var timeFrame = params.duration === "week" ? "week" : "day";
          var targetCalories = Math.round(targets.calories);

          console.log("è°ƒç”¨Spoonacular APIç”Ÿæˆé¥®é£Ÿè®¡åˆ’ï¼Œå‚æ•°:", {
            timeFrame,
            targetCalories,
            params,
          });

          // æ„å»ºåŸºç¡€è¯·æ±‚å‚æ•°
          var queryParams = new URLSearchParams({
            apiKey: SPOONACULAR_API_KEY,
            timeFrame: timeFrame,
            targetCalories: targetCalories,
          });

          // æ·»åŠ å¯é€‰å‚æ•°ï¼ˆåªæœ‰å½“å€¼å­˜åœ¨ä¸”ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ ï¼‰
          if (params.diet && params.diet.trim()) {
            queryParams.append("diet", params.diet.trim());
          }
          if (params.intolerances && params.intolerances.trim()) {
            queryParams.append("intolerances", params.intolerances.trim());
          }
          if (params.exclude && params.exclude.trim()) {
            queryParams.append("exclude", params.exclude.trim());
          }

          var finalUrl = `${SPOONACULAR_BASE_URL}/mealplanner/generate?${queryParams.toString()}`;
          console.log("Spoonacular APIå®Œæ•´è¯·æ±‚URL:", finalUrl);

          // æ·»åŠ è¯·æ±‚å¤´å’Œè¶…æ—¶æ§åˆ¶
          var controller = new AbortController();
          var timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

          var response = await fetch(finalUrl, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "User-Agent": "HealthDietAssistant/1.0",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          console.log(
            "Spoonacular APIå“åº”çŠ¶æ€:",
            response.status,
            response.statusText
          );

          if (!response.ok) {
            var errorText = "";
            try {
              errorText = await response.text();
              console.error("Spoonacular APIé”™è¯¯å“åº”å†…å®¹:", errorText);
            } catch (e) {
              console.error("æ— æ³•è¯»å–é”™è¯¯å“åº”:", e);
            }

            // æ ¹æ®é”™è¯¯çŠ¶æ€ç æä¾›è¯¦ç»†ä¿¡æ¯
            var errorMessage = "";
            switch (response.status) {
              case 401:
                errorMessage = "APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ";
                break;
              case 402:
                errorMessage = "APIé…é¢ä¸è¶³";
                break;
              case 403:
                errorMessage = "APIè®¿é—®è¢«æ‹’ç»";
                break;
              case 404:
                errorMessage = "APIç«¯ç‚¹ä¸å­˜åœ¨";
                break;
              case 429:
                errorMessage = "APIè¯·æ±‚é¢‘ç‡é™åˆ¶";
                break;
              case 500:
                errorMessage = "SpoonacularæœåŠ¡å™¨å†…éƒ¨é”™è¯¯";
                break;
              default:
                errorMessage = `HTTPé”™è¯¯ ${response.status}: ${response.statusText}`;
            }

            throw new Error(`Spoonacular APIé”™è¯¯: ${errorMessage}`);
          }

          var data = await response.json();
          console.log("Spoonacular APIå“åº”æˆåŠŸï¼Œæ•°æ®ç»“æ„:", Object.keys(data));
          console.log("Spoonacular APIå®Œæ•´å“åº”:", data);

          // éªŒè¯å“åº”æ•°æ®æ ¼å¼
          if (
            !data ||
            (timeFrame === "week" &&
              !data.week &&
              timeFrame === "day" &&
              !data.meals)
          ) {
            console.error("Spoonacular APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:", data);
            throw new Error("APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
          }

          // å¤„ç†APIå“åº”æ•°æ®ï¼Œå¹¶ä½¿ç”¨Edamamè¿›è¡Œè¥å…»è®¡ç®—
          var processedPlan = await processMealPlanDataWithEdamam(
            data,
            params,
            targets
          );
          processedPlan.isSpoonacularGenerated = true; // æ ‡è®°ä¸ºSpoonacularç”Ÿæˆ
          return processedPlan;
        } catch (error) {
          if (error.name === "AbortError") {
            console.error("Spoonacular APIè¯·æ±‚è¶…æ—¶");
            throw new Error("APIè¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
          }
          console.error("Spoonacular APIè°ƒç”¨å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:", error);
          throw error;
        }
      }

      // æ ¹æ®é¤é£ŸIDå’Œç´¢å¼•åˆ¤æ–­é¤é£Ÿç±»å‹
      function getMealType(mealId, index) {
        // æ ¹æ®ç´¢å¼•åˆ†é…é¤é£Ÿç±»å‹
        if (index === 0) return "breakfast";
        if (index === 1) return "lunch";
        if (index === 2) return "dinner";

        // å¦‚æœè¶…è¿‡3ä¸ªé¤é£Ÿï¼Œå¾ªç¯åˆ†é…
        var types = ["breakfast", "lunch", "dinner"];
        return types[index % 3];
      }

      // å¢å¼ºçš„æœ¬åœ°é¥®é£Ÿè®¡åˆ’ç”Ÿæˆå™¨
      async function generateEnhancedLocalPlan(params, targets) {
        try {
          console.log("ä½¿ç”¨å¢å¼ºAIæœ¬åœ°æ–¹æ¡ˆç”Ÿæˆé¥®é£Ÿè®¡åˆ’");

          var plan = {
            id: "enhanced_" + Date.now(),
            name: `${params.duration === "week" ? "7å¤©" : "1å¤©"}AIæ™ºèƒ½é¥®é£Ÿè®¡åˆ’`,
            createdAt: new Date().toISOString(),
            duration: params.duration,
            totalCalories: 0,
            totalProtein: 0,
            totalCarbs: 0,
            totalFat: 0,
            days: [],
            isSpoonacularGenerated: false,
            isEnhancedLocal: true,
          };

          var daysCount = params.duration === "week" ? 7 : 1;
          var dailyCalories = Math.round(targets.calories);

          for (var i = 0; i < daysCount; i++) {
            var dayName =
              params.duration === "week"
                ? ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"][i]
                : "ä»Šæ—¥";

            console.log(`ç”Ÿæˆç¬¬${i + 1}å¤©AIè®¡åˆ’: ${dayName}`);
            var dayPlan = await generateEnhancedDayPlan(
              dayName,
              dailyCalories,
              targets,
              params,
              i
            );
            plan.days.push(dayPlan);

            plan.totalCalories += dayPlan.calories;
            plan.totalProtein += dayPlan.protein;
            plan.totalCarbs += dayPlan.carbs;
            plan.totalFat += dayPlan.fat;
          }

          console.log("å¢å¼ºAIæœ¬åœ°è®¡åˆ’ç”Ÿæˆå®Œæˆ:", plan);
          return plan;
        } catch (error) {
          console.error("å¢å¼ºæœ¬åœ°è®¡åˆ’ç”Ÿæˆå¤±è´¥:", error);
          throw error;
        }
      }

      // ç”Ÿæˆå¢å¼ºå•æ—¥è®¡åˆ’
      async function generateEnhancedDayPlan(
        dayName,
        targetCalories,
        targets,
        params,
        dayIndex
      ) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        // ç”Ÿæˆå¤šæ ·åŒ–çš„é¤é£Ÿï¼ˆæ ¹æ®æ—¥æœŸå˜åŒ–ï¼‰
        var meals = {
          breakfast: generateDiversifiedMeals(
            "breakfast",
            breakfastCal,
            params,
            dayIndex
          ),
          lunch: generateDiversifiedMeals("lunch", lunchCal, params, dayIndex),
          dinner: generateDiversifiedMeals(
            "dinner",
            dinnerCal,
            params,
            dayIndex
          ),
        };

        // æ”¶é›†æ‰€æœ‰é£Ÿæç”¨äºEdamamåˆ†æ
        var dayIngredients = [];
        Object.keys(meals).forEach((mealType) => {
          meals[mealType].forEach((meal) => {
            // ä¸ºEdamamæ„å»ºæ›´ç²¾ç¡®çš„é£Ÿææè¿°
            var ingredient = `${meal.portion || "1 serving"} ${meal.title}`;
            if (meal.ingredients && meal.ingredients.length > 0) {
              ingredient = meal.ingredients.join(", ");
            }
            dayIngredients.push(ingredient);
          });
        });

        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: meals,
          isEnhancedLocal: true,
        };

        // ä½¿ç”¨Edamamåˆ†æè¥å…»
        if (dayIngredients.length > 0) {
          console.log(`ä½¿ç”¨Edamamåˆ†æ${dayName}çš„AIè¥å…»:`, dayIngredients);
          var edamamNutrition = await calculateNutritionWithEdamam(
            dayIngredients
          );

          if (edamamNutrition && edamamNutrition.calories > 0) {
            console.log(`Edamam AIè¥å…»åˆ†æç»“æœ:`, edamamNutrition);
            dayPlan.calories = edamamNutrition.calories;
            dayPlan.protein = edamamNutrition.protein;
            dayPlan.carbs = edamamNutrition.carbs;
            dayPlan.fat = edamamNutrition.fat;
            dayPlan.fiber = edamamNutrition.fiber;
            dayPlan.sodium = edamamNutrition.sodium;
            dayPlan.isEdamamAnalyzed = true;
          } else {
            // å¦‚æœEdamamåˆ†æå¤±è´¥ï¼Œä½¿ç”¨é«˜è´¨é‡ä¼°ç®—å€¼
            console.log("Edamamåˆ†æå¤±è´¥ï¼Œä½¿ç”¨AIä¼°ç®—è¥å…»æ•°æ®");
            var aiNutrition = calculateAINutrition(meals, targetCalories);
            dayPlan.calories = aiNutrition.calories;
            dayPlan.protein = aiNutrition.protein;
            dayPlan.carbs = aiNutrition.carbs;
            dayPlan.fat = aiNutrition.fat;
            dayPlan.fiber = aiNutrition.fiber;
          }
        }

        return dayPlan;
      }

      // ç”Ÿæˆå¤šæ ·åŒ–é¤é£Ÿï¼ˆAIæ™ºèƒ½æ¨èï¼‰
      function generateDiversifiedMeals(
        mealType,
        targetCalories,
        params,
        dayIndex
      ) {
        var isVegetarian =
          params.diet === "vegetarian" || params.diet === "vegan";
        var isVegan = params.diet === "vegan";
        var isKeto = params.diet === "ketogenic";
        var isPaleo = params.diet === "paleo";
        var intolerances = (params.intolerances || "").toLowerCase();

        // æ‰©å±•çš„é«˜è´¨é‡é¤é£Ÿåº“
        var enhancedMealTemplates = {
          breakfast: [
            // ä¼ ç»Ÿå¥åº·æ—©é¤
            {
              name: "è“è“ç‡•éº¦ç²¥é…æ ¸æ¡ƒ",
              calories: 320,
              protein: 12,
              carbs: 55,
              fat: 8,
              fiber: 8,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup oatmeal",
                "1/2 cup blueberries",
                "1 oz walnuts",
                "1 tbsp honey",
              ],
              portion: "1 bowl",
            },
            {
              name: "ç‰›æ²¹æœåå¸é…ç…è›‹",
              calories: 380,
              protein: 18,
              carbs: 32,
              fat: 22,
              fiber: 12,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "2 slices whole grain bread",
                "1 medium avocado",
                "2 eggs",
                "salt and pepper",
              ],
              portion: "1 serving",
            },
            {
              name: "å¸Œè…Šé…¸å¥¶æµ†æœæ¯",
              calories: 280,
              protein: 20,
              carbs: 35,
              fat: 8,
              fiber: 6,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup greek yogurt",
                "1/2 cup mixed berries",
                "1 tbsp honey",
                "1 tbsp chia seeds",
              ],
              portion: "1 cup",
            },
            // ç”Ÿé…®æ—©é¤
            {
              name: "å¥¶æ²¹ç‚’è›‹é…åŸ¹æ ¹",
              calories: 420,
              protein: 25,
              carbs: 3,
              fat: 35,
              fiber: 0,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "3 eggs",
                "2 slices bacon",
                "1 tbsp butter",
                "herbs",
              ],
              portion: "1 serving",
            },
            {
              name: "æ¤°å­ç²‰æ¾é¥¼",
              calories: 300,
              protein: 8,
              carbs: 6,
              fat: 28,
              fiber: 4,
              vegetarian: true,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: ["2 coconut flour muffins", "1 tbsp almond butter"],
              portion: "2 muffins",
            },
            // ç´ é£Ÿæ—©é¤
            {
              name: "å¥‡äºšç±½å¸ƒä¸",
              calories: 290,
              protein: 10,
              carbs: 28,
              fat: 16,
              fiber: 12,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "3 tbsp chia seeds",
                "1 cup almond milk",
                "1 tbsp maple syrup",
                "1/4 cup berries",
              ],
              portion: "1 cup",
            },
          ],
          lunch: [
            // å¥åº·ä¸»é¤
            {
              name: "æŸ æª¬é¦™è‰çƒ¤é¸¡æ²™æ‹‰",
              calories: 450,
              protein: 35,
              carbs: 25,
              fat: 24,
              fiber: 8,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "4 oz grilled chicken breast",
                "2 cups mixed greens",
                "1/4 avocado",
                "olive oil dressing",
              ],
              portion: "1 large salad",
            },
            {
              name: "ä¸‰æ–‡é±¼è—œéº¦ç¢—",
              calories: 520,
              protein: 38,
              carbs: 45,
              fat: 22,
              fiber: 6,
              vegetarian: false,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "5 oz salmon fillet",
                "3/4 cup cooked quinoa",
                "1 cup roasted vegetables",
              ],
              portion: "1 bowl",
            },
            {
              name: "åœ°ä¸­æµ·é¹°å˜´è±†æ²™æ‹‰",
              calories: 380,
              protein: 15,
              carbs: 50,
              fat: 16,
              fiber: 12,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup chickpeas",
                "1 cup cucumber",
                "1/2 cup tomatoes",
                "2 tbsp olive oil",
                "feta cheese",
              ],
              portion: "1 large portion",
            },
            // ç”Ÿé…®åˆé¤
            {
              name: "æ¤°èœèŠ±é¥­é…ç‰›è‚‰",
              calories: 480,
              protein: 32,
              carbs: 12,
              fat: 36,
              fiber: 5,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "5 oz ground beef",
                "1.5 cups cauliflower rice",
                "2 tbsp coconut oil",
              ],
              portion: "1 serving",
            },
            // ç´ é£Ÿåˆé¤
            {
              name: "é»‘è±†çº¢è–¯æ±‰å ¡",
              calories: 420,
              protein: 18,
              carbs: 65,
              fat: 12,
              fiber: 15,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 black bean sweet potato burger",
                "1 whole grain bun",
                "lettuce and tomato",
              ],
              portion: "1 burger",
            },
          ],
          dinner: [
            // ç²¾è‡´æ™šé¤
            {
              name: "é¦™è‰çƒ¤é±¼é…è’¸è”¬èœ",
              calories: 420,
              protein: 40,
              carbs: 20,
              fat: 20,
              fiber: 6,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "6 oz white fish fillet",
                "1.5 cups steamed broccoli",
                "1 tbsp olive oil",
                "herbs",
              ],
              portion: "1 serving",
            },
            {
              name: "è˜‘è‡æ„é¢",
              calories: 480,
              protein: 18,
              carbs: 70,
              fat: 16,
              fiber: 8,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "1.5 cups whole wheat pasta",
                "1 cup mixed mushrooms",
                "2 tbsp parmesan",
                "olive oil",
              ],
              portion: "1 large serving",
            },
            {
              name: "æ³°å¼å’–å–±è±†è…",
              calories: 390,
              protein: 20,
              carbs: 35,
              fat: 22,
              fiber: 5,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "5 oz firm tofu",
                "1/2 cup coconut milk",
                "1 cup vegetables",
                "curry spices",
              ],
              portion: "1 serving",
            },
            // ç”Ÿé…®æ™šé¤
            {
              name: "é»„æ²¹è’œé¦™ç‰›æ’",
              calories: 550,
              protein: 45,
              carbs: 5,
              fat: 38,
              fiber: 2,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "6 oz beef steak",
                "2 tbsp butter",
                "garlic",
                "1 cup asparagus",
              ],
              portion: "1 steak",
            },
          ],
        };

        var templates = enhancedMealTemplates[mealType] || [];

        // æ™ºèƒ½è¿‡æ»¤ï¼ˆæ ¹æ®é¥®é£Ÿé™åˆ¶ï¼‰
        var filteredTemplates = templates.filter((meal) => {
          if (isVegan && !meal.vegan) return false;
          if (isVegetarian && !meal.vegetarian) return false;
          if (isKeto && !meal.keto) return false;
          if (isPaleo && !meal.paleo) return false;

          // è¿‡æ•åŸæ£€æŸ¥
          if (
            intolerances.includes("dairy") &&
            meal.ingredients.some(
              (ing) =>
                ing.includes("cheese") ||
                ing.includes("milk") ||
                ing.includes("yogurt")
            )
          )
            return false;
          if (
            intolerances.includes("egg") &&
            meal.ingredients.some((ing) => ing.includes("egg"))
          )
            return false;
          if (
            intolerances.includes("gluten") &&
            meal.ingredients.some(
              (ing) => ing.includes("bread") || ing.includes("pasta")
            )
          )
            return false;

          return true;
        });

        if (filteredTemplates.length === 0) {
          filteredTemplates = templates; // ä¿åº•æ–¹æ¡ˆ
        }

        // æ™ºèƒ½é€‰æ‹©ï¼ˆé¿å…é‡å¤ï¼Œå¢åŠ å¤šæ ·æ€§ï¼‰
        var baseIndex = dayIndex % filteredTemplates.length;
        var selectedMeal = { ...filteredTemplates[baseIndex] };

        selectedMeal.id = "enhanced_" + Date.now() + "_" + baseIndex;
        selectedMeal.title = selectedMeal.name;
        selectedMeal.image = null; // æœ¬åœ°æ–¹æ¡ˆæš‚æ— å›¾ç‰‡
        selectedMeal.readyInMinutes =
          mealType === "breakfast" ? 15 : mealType === "lunch" ? 25 : 35;

        return [selectedMeal];
      }

      // AIè¥å…»è®¡ç®—ï¼ˆå½“Edamamå¤±è´¥æ—¶çš„é«˜è´¨é‡ä¼°ç®—ï¼‰
      function calculateAINutrition(meals, targetCalories) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
        var mealCount = 0;

        Object.values(meals).forEach((mealList) => {
          mealList.forEach((meal) => {
            total.calories += meal.calories || 0;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
            total.fiber += meal.fiber || 0;
            mealCount++;
          });
        });

        // å¦‚æœæ€»çƒ­é‡åå·®å¤ªå¤§ï¼ŒæŒ‰æ¯”ä¾‹è°ƒæ•´
        if (Math.abs(total.calories - targetCalories) > 200) {
          var factor = targetCalories / total.calories;
          total.calories = Math.round(total.calories * factor);
          total.protein = Math.round(total.protein * factor);
          total.carbs = Math.round(total.carbs * factor);
          total.fat = Math.round(total.fat * factor);
          total.fiber = Math.round(total.fiber * factor);
        }

        return total;
      }

      // ç”Ÿæˆå•æ—¥fallbackè®¡åˆ’ï¼ˆä½¿ç”¨Edamamåˆ†æï¼‰
      async function generateFallbackDayPlanWithEdamam(
        dayName,
        targetCalories,
        targets,
        params
      ) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        // ç”Ÿæˆé€‚åˆçš„é¤é£Ÿ
        var meals = {
          breakfast: generateSmartFallbackMeals(
            "breakfast",
            breakfastCal,
            params
          ),
          lunch: generateSmartFallbackMeals("lunch", lunchCal, params),
          dinner: generateSmartFallbackMeals("dinner", dinnerCal, params),
        };

        // æ”¶é›†æ‰€æœ‰é£Ÿæç”¨äºEdamamåˆ†æ
        var dayIngredients = [];
        Object.keys(meals).forEach((mealType) => {
          meals[mealType].forEach((meal) => {
            dayIngredients.push(`1 serving ${meal.title}`);
          });
        });

        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: meals,
        };

        // ä½¿ç”¨Edamamåˆ†æè¥å…»
        if (dayIngredients.length > 0) {
          console.log(`ä½¿ç”¨Edamamåˆ†æ${dayName}çš„è¥å…»:`, dayIngredients);
          var edamamNutrition = await calculateNutritionWithEdamam(
            dayIngredients
          );

          if (edamamNutrition) {
            console.log(`Edamamè¥å…»åˆ†æç»“æœ:`, edamamNutrition);
            dayPlan.calories = edamamNutrition.calories;
            dayPlan.protein = edamamNutrition.protein;
            dayPlan.carbs = edamamNutrition.carbs;
            dayPlan.fat = edamamNutrition.fat;
            dayPlan.fiber = edamamNutrition.fiber;
            dayPlan.sodium = edamamNutrition.sodium;
            dayPlan.isEdamamAnalyzed = true;
          } else {
            // å¦‚æœEdamamåˆ†æå¤±è´¥ï¼Œä½¿ç”¨ä¼°ç®—å€¼
            var totalNutrition = calculateTotalNutrition(meals);
            dayPlan.calories = totalNutrition.calories;
            dayPlan.protein = totalNutrition.protein;
            dayPlan.carbs = totalNutrition.carbs;
            dayPlan.fat = totalNutrition.fat;
          }
        }

        return dayPlan;
      }

      // åŸºç¡€ä¿é™©æ–¹æ¡ˆï¼ˆå½“æ‰€æœ‰APIéƒ½å¤±è´¥æ—¶ï¼‰
      function generateBasicFallbackPlan(params, targets) {
        console.log("ä½¿ç”¨åŸºç¡€ä¿é™©æ–¹æ¡ˆç”Ÿæˆé¥®é£Ÿè®¡åˆ’");

        var plan = {
          id: "basic_" + Date.now(),
          name: `${params.duration === "week" ? "7å¤©" : "1å¤©"}åŸºç¡€å¥åº·é¥®é£Ÿè®¡åˆ’`,
          createdAt: new Date().toISOString(),
          duration: params.duration,
          totalCalories: 0,
          totalProtein: 0,
          totalCarbs: 0,
          totalFat: 0,
          days: [],
          isSpoonacularGenerated: false,
          isBasicPlan: true,
        };

        var daysCount = params.duration === "week" ? 7 : 1;
        var dailyCalories = Math.round(targets.calories);

        for (var i = 0; i < daysCount; i++) {
          var dayName =
            params.duration === "week"
              ? ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"][i]
              : "ä»Šæ—¥";

          var dayPlan = generateBasicDayPlan(
            dayName,
            dailyCalories,
            targets,
            params
          );
          plan.days.push(dayPlan);

          plan.totalCalories += dayPlan.calories;
          plan.totalProtein += dayPlan.protein;
          plan.totalCarbs += dayPlan.carbs;
          plan.totalFat += dayPlan.fat;
        }

        return plan;
      }

      // ç”ŸæˆåŸºç¡€å•æ—¥è®¡åˆ’
      function generateBasicDayPlan(dayName, targetCalories, targets, params) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        var meals = {
          breakfast: generateBasicMeals("breakfast", breakfastCal, params),
          lunch: generateBasicMeals("lunch", lunchCal, params),
          dinner: generateBasicMeals("dinner", dinnerCal, params),
        };

        var totalNutrition = calculateTotalNutrition(meals);

        return {
          name: dayName,
          calories: totalNutrition.calories,
          protein: totalNutrition.protein,
          carbs: totalNutrition.carbs,
          fat: totalNutrition.fat,
          meals: meals,
          isEdamamAnalyzed: false,
          isBasicPlan: true,
        };
      }

      // APIå¯†é’¥éªŒè¯å‡½æ•°
      async function testSpoonacularAPI() {
        try {
          console.log("æµ‹è¯•Spoonacular APIè¿æ¥...");
          var testUrl = `${SPOONACULAR_BASE_URL}/recipes/random?number=1&apiKey=${SPOONACULAR_API_KEY}`;

          var response = await fetch(testUrl);
          console.log("APIæµ‹è¯•å“åº”çŠ¶æ€:", response.status);

          if (response.ok) {
            var data = await response.json();
            console.log("APIæµ‹è¯•æˆåŠŸï¼Œè¿”å›æ•°æ®:", data);
            return true;
          } else {
            var errorText = await response.text();
            console.error("APIæµ‹è¯•å¤±è´¥:", response.status, errorText);
            return false;
          }
        } catch (error) {
          console.error("APIæµ‹è¯•å¼‚å¸¸:", error);
          return false;
        }
      }

      // æ™ºèƒ½ç”Ÿæˆfallbacké¤é£Ÿï¼ˆè€ƒè™‘é¥®é£Ÿé™åˆ¶ï¼‰
      function generateSmartFallbackMeals(mealType, targetCalories, params) {
        var isVegetarian =
          params.diet === "vegetarian" || params.diet === "vegan";
        var isKeto = params.diet === "ketogenic";
        var intolerances = (params.intolerances || "").toLowerCase();

        var mealTemplates = {
          breakfast: [
            {
              name: "ç‡•éº¦ç²¥é…è“è“",
              calories: 280,
              protein: 8,
              carbs: 45,
              fat: 6,
              vegetarian: true,
              keto: false,
            },
            {
              name: "å…¨éº¦åå¸é…ç‰›æ²¹æœ",
              calories: 320,
              protein: 15,
              carbs: 35,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "é¸¡è›‹å·é…è èœ",
              calories: 250,
              protein: 18,
              carbs: 8,
              fat: 16,
              vegetarian: true,
              keto: true,
            },
            {
              name: "å¸Œè…Šé…¸å¥¶é…åšæœ",
              calories: 300,
              protein: 20,
              carbs: 15,
              fat: 18,
              vegetarian: true,
              keto: false,
            },
          ],
          lunch: [
            {
              name: "é¸¡èƒ¸è‚‰æ²™æ‹‰",
              calories: 350,
              protein: 30,
              carbs: 20,
              fat: 15,
              vegetarian: false,
              keto: true,
            },
            {
              name: "ä¸‰æ–‡é±¼é…ç³™ç±³",
              calories: 420,
              protein: 35,
              carbs: 40,
              fat: 18,
              vegetarian: false,
              keto: false,
            },
            {
              name: "è±†è…è”¬èœæ±¤",
              calories: 280,
              protein: 18,
              carbs: 25,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "è—œéº¦è”¬èœæ²™æ‹‰",
              calories: 380,
              protein: 15,
              carbs: 45,
              fat: 16,
              vegetarian: true,
              keto: false,
            },
          ],
          dinner: [
            {
              name: "çƒ¤é¸¡è…¿é…è”¬èœ",
              calories: 400,
              protein: 32,
              carbs: 25,
              fat: 20,
              vegetarian: false,
              keto: true,
            },
            {
              name: "è’¸é±¼é…é’èœ",
              calories: 320,
              protein: 28,
              carbs: 15,
              fat: 15,
              vegetarian: false,
              keto: true,
            },
            {
              name: "ç´ é£Ÿæ„é¢",
              calories: 380,
              protein: 15,
              carbs: 55,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "è±†ç±»ç‚–èœ",
              calories: 350,
              protein: 20,
              carbs: 40,
              fat: 10,
              vegetarian: true,
              keto: false,
            },
          ],
        };

        var templates = mealTemplates[mealType] || [];

        // æ ¹æ®é¥®é£Ÿé™åˆ¶è¿‡æ»¤
        var filteredTemplates = templates.filter((meal) => {
          if (isVegetarian && !meal.vegetarian) return false;
          if (isKeto && !meal.keto) return false;
          if (intolerances.includes("dairy") && meal.name.includes("é…¸å¥¶"))
            return false;
          if (intolerances.includes("egg") && meal.name.includes("é¸¡è›‹"))
            return false;
          return true;
        });

        if (filteredTemplates.length === 0) {
          filteredTemplates = templates; // å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œä½¿ç”¨æ‰€æœ‰æ¨¡æ¿
        }

        // éšæœºé€‰æ‹©1-2ä¸ªé¤é£Ÿ
        var selectedMeals = [];
        var remainingCalories = targetCalories;

        while (
          selectedMeals.length < 2 &&
          remainingCalories > 100 &&
          filteredTemplates.length > 0
        ) {
          var randomIndex = Math.floor(
            Math.random() * filteredTemplates.length
          );
          var meal = { ...filteredTemplates[randomIndex] };

          if (meal.calories <= remainingCalories + 50) {
            // å…è®¸ä¸€å®šè¯¯å·®
            meal.id = "fallback_" + Date.now() + "_" + randomIndex;
            meal.title = meal.name;
            selectedMeals.push(meal);
            remainingCalories -= meal.calories;
            filteredTemplates.splice(randomIndex, 1); // é¿å…é‡å¤
          }

          if (filteredTemplates.length === 0) break;
        }

        return selectedMeals;
      }

      // ç”Ÿæˆfallbackå•æ—¥è®¡åˆ’
      function generateFallbackDayPlan(dayName, targetCalories, targets) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        var meals = {
          breakfast: generateFallbackMeals("breakfast", breakfastCal),
          lunch: generateFallbackMeals("lunch", lunchCal),
          dinner: generateFallbackMeals("dinner", dinnerCal),
        };

        var totalNutrition = calculateTotalNutrition(meals);

        return {
          name: dayName,
          calories: totalNutrition.calories,
          protein: totalNutrition.protein,
          carbs: totalNutrition.carbs,
          fat: totalNutrition.fat,
          meals: meals,
        };
      }

      // ç”Ÿæˆfallbacké¤é£Ÿ
      function generateFallbackMeals(mealType, targetCalories) {
        var mealTemplates = {
          breakfast: [
            {
              name: "ç‡•éº¦ç²¥é…è“è“",
              calories: 280,
              protein: 8,
              carbs: 45,
              fat: 6,
              image: null,
            },
            {
              name: "å…¨éº¦åå¸é…ç‰›æ²¹æœ",
              calories: 320,
              protein: 15,
              carbs: 35,
              fat: 12,
              image: null,
            },
          ],
          lunch: [
            {
              name: "é¸¡èƒ¸è‚‰æ²™æ‹‰",
              calories: 350,
              protein: 30,
              carbs: 20,
              fat: 15,
              image: null,
            },
            {
              name: "ä¸‰æ–‡é±¼é…ç³™ç±³",
              calories: 420,
              protein: 35,
              carbs: 40,
              fat: 18,
              image: null,
            },
          ],
          dinner: [
            {
              name: "çƒ¤é¸¡è…¿é…è”¬èœ",
              calories: 400,
              protein: 32,
              carbs: 25,
              fat: 20,
              image: null,
            },
            {
              name: "è’¸é±¼é…é’èœ",
              calories: 320,
              protein: 28,
              carbs: 15,
              fat: 15,
              image: null,
            },
          ],
        };

        var templates = mealTemplates[mealType] || [];
        // éšæœºé€‰æ‹©1-2ä¸ªé¤é£Ÿ
        var selectedMeals = [];
        var remainingCalories = targetCalories;

        while (
          selectedMeals.length < 2 &&
          remainingCalories > 100 &&
          templates.length > 0
        ) {
          var randomIndex = Math.floor(Math.random() * templates.length);
          var meal = { ...templates[randomIndex] };

          if (meal.calories <= remainingCalories + 50) {
            // å…è®¸ä¸€å®šè¯¯å·®
            meal.id = "fallback_" + Date.now() + "_" + randomIndex;
            meal.title = meal.name;
            selectedMeals.push(meal);
            remainingCalories -= meal.calories;
            templates.splice(randomIndex, 1); // é¿å…é‡å¤
          }

          if (templates.length === 0) break;
        }

        return selectedMeals;
      }

      // è®¡ç®—æ€»è¥å…»
      function calculateTotalNutrition(meals) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0 };

        Object.values(meals).forEach((mealList) => {
          mealList.forEach((meal) => {
            total.calories += meal.calories || 0;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
          });
        });

        return total;
      }

      // æ˜¾ç¤ºé¥®é£Ÿè®¡åˆ’ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ˜¾ç¤ºEdamamåˆ†æç»“æœï¼‰
      function displayDietPlan(plan) {
        document.getElementById("planDisplayArea").style.display = "block";

        // æ˜¾ç¤ºæ¦‚è§ˆç»Ÿè®¡
        var overviewStats = document.getElementById("overviewStats");
        var avgCalories =
          plan.days.length > 0
            ? Math.round(plan.totalCalories / plan.days.length)
            : 0;
        var avgProtein =
          plan.days.length > 0
            ? Math.round(plan.totalProtein / plan.days.length)
            : 0;
        var avgCarbs =
          plan.days.length > 0
            ? Math.round(plan.totalCarbs / plan.days.length)
            : 0;
        var avgFat =
          plan.days.length > 0
            ? Math.round(plan.totalFat / plan.days.length)
            : 0;

        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†Edamamåˆ†æ
        var hasEdamamAnalysis = plan.days.some((day) => day.isEdamamAnalyzed);
        var analysisLabel = hasEdamamAnalysis ? " ğŸ”¬ Edamamç²¾ç¡®åˆ†æ" : "";

        overviewStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avgCalories}</div>
                    <div class="stat-label">æ—¥å‡çƒ­é‡ (kcal)${analysisLabel}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgProtein}g</div>
                    <div class="stat-label">æ—¥å‡è›‹ç™½è´¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgCarbs}g</div>
                    <div class="stat-label">æ—¥å‡ç¢³æ°´</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgFat}g</div>
                    <div class="stat-label">æ—¥å‡è„‚è‚ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${plan.days.length}</div>
                    <div class="stat-label">è®¡åˆ’å¤©æ•°</div>
                </div>
            `;

        // æ˜¾ç¤ºæ¯æ—¥è®¡åˆ’
        var planContent = document.getElementById("planContent");
        planContent.innerHTML = plan.days
          .map((day) => {
            var analysisIcon = day.isEdamamAnalyzed ? " ğŸ”¬" : "";
            var fiberInfo =
              day.fiber && day.fiber > 0
                ? ` | çº¤ç»´ ${day.fiber.toFixed(1)}g`
                : "";
            var sodiumInfo =
              day.sodium && day.sodium > 0
                ? ` | é’  ${Math.round(day.sodium * 1000)}mg`
                : "";

            return `
                    <div class="day-plan">
                        <div class="day-header">
                            ğŸ“… ${day.name} - ${Math.round(
              day.calories
            )} kcal${analysisIcon}
                            ${
                              fiberInfo || sodiumInfo
                                ? `<br><small style="opacity: 0.8;">${fiberInfo}${sodiumInfo}</small>`
                                : ""
                            }
                        </div>
                        <div class="day-meals">
                            ${generateMealSectionHTML(
                              "ğŸŒ… æ—©é¤",
                              day.meals.breakfast
                            )}
                            ${generateMealSectionHTML(
                              "â˜€ï¸ åˆé¤",
                              day.meals.lunch
                            )}
                            ${generateMealSectionHTML(
                              "ğŸŒ™ æ™šé¤",
                              day.meals.dinner
                            )}
                        </div>
                    </div>
                `;
          })
          .join("");

        // æ»šåŠ¨åˆ°æ˜¾ç¤ºåŒºåŸŸ
        document.getElementById("planDisplayArea").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
      }

      // ç”Ÿæˆé¤é£ŸåŒºåŸŸHTMLï¼ˆå¢å¼ºç‰ˆæœ¬ï¼ŒåŒºåˆ†è¥å…»æ•°æ®æ¥æºï¼‰
      function generateMealSectionHTML(title, meals) {
        if (!meals || meals.length === 0) {
          return `
                    <div class="meal-section">
                        <div class="meal-title">${title}</div>
                        <div class="meal-items">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                æš‚æ— æ¨èé£Ÿç‰©
                            </div>
                        </div>
                    </div>
                `;
        }

        return `
                <div class="meal-section">
                    <div class="meal-title">${title}</div>
                    <div class="meal-items">
                        ${meals
                          .map((meal) => {
                            // å¦‚æœè¥å…»æ•°æ®ä¸º0ï¼Œè¯´æ˜å°†ç”±Edamamç»Ÿä¸€è®¡ç®—
                            var nutritionDisplay = "";
                            if (meal.calories > 0 || meal.protein > 0) {
                              nutritionDisplay = `
                                    ${Math.round(meal.calories || 0)} kcal | 
                                    è›‹ç™½è´¨ ${(meal.protein || 0).toFixed(1)}g | 
                                    ç¢³æ°´ ${(meal.carbs || 0).toFixed(1)}g | 
                                    è„‚è‚ª ${(meal.fat || 0).toFixed(1)}g
                                `;
                            } else {
                              nutritionDisplay = "è¥å…»æ•°æ®ç”±Edamamç²¾ç¡®è®¡ç®— ğŸ”¬";
                            }

                            var timeInfo = meal.readyInMinutes
                              ? ` | ${meal.readyInMinutes}åˆ†é’Ÿ`
                              : "";

                            return `
                                <div class="meal-item">
                                    <div class="item-info">
                                        <div class="item-name">${
                                          meal.title || meal.name
                                        }</div>
                                        <div class="item-nutrition">
                                            ${nutritionDisplay}${timeInfo}
                                        </div>
                                    </div>
                                    ${
                                      meal.image
                                        ? `<img src="${meal.image}" alt="${
                                            meal.title || meal.name
                                          }" class="item-image">`
                                        : ""
                                    }
                                </div>
                            `;
                          })
                          .join("")}
                    </div>
                </div>
            `;
      }

      // è·å–é€‰ä¸­çš„è¿‡æ•/ä¸è€å—é£Ÿç‰©
      function getSelectedIntolerances() {
        var checkboxes = document.querySelectorAll(
          '#intolerancesCheckboxes input[type="checkbox"]:checked'
        );
        return Array.from(checkboxes)
          .map((cb) => cb.value)
          .join(",");
      }

      // é‡ç½®è¡¨å•
      function resetPlanForm() {
        document.getElementById("planDuration").value = "week";
        document.getElementById("dietType").value = "";

        // é‡ç½®å¤é€‰æ¡†
        var checkboxes = document.querySelectorAll(
          '#intolerancesCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false));

        document.getElementById("excludeIngredients").value = "";
        document.getElementById("planDisplayArea").style.display = "none";
      }

      // ä¿å­˜é¥®é£Ÿè®¡åˆ’
      function saveDietPlan() {
        if (!currentDietPlan) {
          showNotification("æ²¡æœ‰å¯ä¿å­˜çš„é¥®é£Ÿè®¡åˆ’", "warning");
          return;
        }

        savedDietPlans.push({
          ...currentDietPlan,
          savedAt: new Date().toISOString(),
        });

        saveUserData();
        loadSavedPlans();
        showNotification("âœ… é¥®é£Ÿè®¡åˆ’å·²ä¿å­˜", "success");
      }

      // å¯¼å‡ºPDFï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
      function exportDietPlan() {
        if (!currentDietPlan) {
          showNotification("æ²¡æœ‰å¯å¯¼å‡ºçš„é¥®é£Ÿè®¡åˆ’", "warning");
          return;
        }

        showNotification("PDFå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...", "warning");
        // è¿™é‡Œå¯ä»¥é›†æˆPDFç”Ÿæˆåº“
      }

      // åº”ç”¨åˆ°ä»Šæ—¥
      function applyTodayPlan() {
        if (!currentDietPlan || !currentDietPlan.days.length) {
          showNotification("æ²¡æœ‰å¯åº”ç”¨çš„é¥®é£Ÿè®¡åˆ’", "warning");
          return;
        }

        var todayPlan = currentDietPlan.days[0];

        // æ¸…ç©ºä»Šæ—¥è®°å½•
        recordedFoods.breakfast = [];
        recordedFoods.lunch = [];
        recordedFoods.dinner = [];

        // åº”ç”¨è®¡åˆ’åˆ°ä»Šæ—¥è®°å½•
        Object.keys(todayPlan.meals).forEach((mealType) => {
          todayPlan.meals[mealType].forEach((meal) => {
            var foodRecord = {
              id: meal.id || Date.now() + Math.random(),
              name: meal.title || meal.name,
              calories: Math.round(meal.calories || 0),
              protein: Math.round((meal.protein || 0) * 10) / 10,
              carbs: Math.round((meal.carbs || 0) * 10) / 10,
              fat: Math.round((meal.fat || 0) * 10) / 10,
              recordId: Date.now() + Math.random(),
              quantity: 1,
              unit: "ä»½",
            };
            recordedFoods[mealType].push(foodRecord);
          });
        });

        updateNutritionTracking();
        updateAllMealRecorded();
        saveUserData();

        showNotification("âœ… é¥®é£Ÿè®¡åˆ’å·²åº”ç”¨åˆ°ä»Šæ—¥è®°å½•", "success");

        // è·³è½¬åˆ°ä¸»é¡µæ˜¾ç¤ºç»“æœ
        setTimeout(() => {
          showMainPage();
        }, 1500);
      }

      // åŠ è½½å·²ä¿å­˜çš„è®¡åˆ’
      function loadSavedPlans() {
        var container = document.getElementById("savedPlansList");

        if (savedDietPlans.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <p>æš‚æ— ä¿å­˜çš„é¥®é£Ÿè®¡åˆ’</p>
                        <small>ç”Ÿæˆå¹¶ä¿å­˜æ‚¨çš„ç¬¬ä¸€ä¸ªé¥®é£Ÿè®¡åˆ’å§ï¼</small>
                    </div>
                `;
          return;
        }

        container.innerHTML = savedDietPlans
          .map(
            (plan, index) => `
                <div class="saved-plan-item">
                    <div class="plan-item-header">
                        <div class="plan-item-title">${plan.name}</div>
                        <div class="plan-item-date">${new Date(
                          plan.savedAt
                        ).toLocaleDateString()}</div>
                    </div>
                    <div class="plan-item-stats">
                        <span>ğŸ“… ${plan.days.length}å¤©</span>
                        <span>ğŸ”¥ ${Math.round(
                          plan.totalCalories / plan.days.length
                        )} kcal/å¤©</span>
                        <span>ğŸ¥© ${Math.round(
                          plan.totalProtein / plan.days.length
                        )}g è›‹ç™½è´¨/å¤©</span>
                    </div>
                    <div class="plan-item-actions">
                        <button onclick="viewSavedPlan(${index})" style="background: #667eea; color: white;">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button onclick="applySavedPlan(${index})" style="background: #28a745; color: white;">åº”ç”¨è®¡åˆ’</button>
                        <button onclick="deleteSavedPlan(${index})" style="background: #dc3545; color: white;">åˆ é™¤</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // æŸ¥çœ‹ä¿å­˜çš„è®¡åˆ’
      function viewSavedPlan(index) {
        if (savedDietPlans[index]) {
          currentDietPlan = savedDietPlans[index];
          displayDietPlan(currentDietPlan);
          showNotification("å·²åŠ è½½ä¿å­˜çš„é¥®é£Ÿè®¡åˆ’", "success");
        }
      }

      // åº”ç”¨ä¿å­˜çš„è®¡åˆ’
      function applySavedPlan(index) {
        if (savedDietPlans[index]) {
          currentDietPlan = savedDietPlans[index];
          applyTodayPlan();
        }
      }

      // åˆ é™¤ä¿å­˜çš„è®¡åˆ’
      function deleteSavedPlan(index) {
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¥®é£Ÿè®¡åˆ’å—ï¼Ÿ")) {
          savedDietPlans.splice(index, 1);
          saveUserData();
          loadSavedPlans();
          showNotification("é¥®é£Ÿè®¡åˆ’å·²åˆ é™¤", "success");
        }
      }
      function initializeChatPageAI() {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        var messageInput = document.getElementById("chatPageMessageInput");
        var sendButton = document.getElementById("chatPageSendButton");

        chatPageAI = {
          messages: [], // å­˜å‚¨å¯¹è¯å†å²
          isStreaming: false, // é˜²æ­¢é‡å¤å‘é€
        };

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œæ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
        messageInput.addEventListener("input", function () {
          var hasContent = this.value.trim().length > 0;
          sendButton.disabled = !hasContent || chatPageAI.isStreaming;

          // åŠ¨æ€è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });

        // æ”¯æŒEnterå‘é€æ¶ˆæ¯ï¼ˆShift+Enteræ¢è¡Œï¼‰
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled) {
              sendChatPageMessage();
            }
          }
        });

        // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
        displayWelcomeMessage();
      }

      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
      function displayWelcomeMessage() {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ¤–</div>
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.5em;">æ¬¢è¿ä½¿ç”¨AIå¥åº·é¡¾é—®</h3>
                    <p style="margin-bottom: 10px; line-height: 1.6;">æˆ‘æ˜¯æ‚¨çš„ä¸“å±æ™ºèƒ½å¥åº·åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; text-align: left;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #667eea;">
                            <strong>ğŸ¥— ä¸ªæ€§åŒ–é¥®é£Ÿå»ºè®®</strong><br>
                            <small>æ ¹æ®æ‚¨çš„å¥åº·ç›®æ ‡åˆ¶å®šä¸“å±é¥®é£Ÿæ–¹æ¡ˆ</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #4CAF50;">
                            <strong>ğŸ“Š è¥å…»åˆ†æè§£è¯»</strong><br>
                            <small>è§£ææ‚¨çš„è¥å…»æ‘„å…¥æ•°æ®ï¼Œæä¾›æ”¹è¿›å»ºè®®</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #ff9800;">
                            <strong>ğŸ’ª è¿åŠ¨æŒ‡å¯¼æ–¹æ¡ˆ</strong><br>
                            <small>æ¨èé€‚åˆæ‚¨çš„è¿åŠ¨è®¡åˆ’å’Œå¥èº«å»ºè®®</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #e91e63;">
                            <strong>ğŸ¯ ç›®æ ‡è¾¾æˆæŒ‡å¯¼</strong><br>
                            <small>å¸®åŠ©æ‚¨åˆ¶å®šå’Œå®ç°å¥åº·ç›®æ ‡</small>
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.9em; margin-top: 20px;">è¯·éšæ—¶å‘æˆ‘æé—®ï¼Œå¼€å§‹æ‚¨çš„å¥åº·ä¹‹æ—…ï¼</p>
                </div>
            `;
      }

      // æ‹ç…§è¯†åˆ«åŠŸèƒ½ï¼ˆå®Œæ•´å®ç°ï¼‰
      function openPhotoRecognitionDialog(mealType) {
        currentMealType = mealType;
        document.getElementById("photoRecognitionDialog").style.display =
          "flex";

        // é‡ç½®ç•Œé¢
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("recognitionResults").style.display = "none";
        document.getElementById("recognitionLoading").style.display = "none";
        document.getElementById("photoInput").value = "";
        document.getElementById("recognizedFoodsList").innerHTML = "";
      }

      // å…³é—­æ‹ç…§è¯†åˆ«å¯¹è¯æ¡†
      function closePhotoRecognitionDialog() {
        document.getElementById("photoRecognitionDialog").style.display =
          "none";
        currentMealType = "";
      }

      // å¤„ç†å›¾ç‰‡é€‰æ‹©
      function handlePhotoSelection(event) {
        var file = event.target.files[0];
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith("image/")) {
          showNotification("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶", "warning");
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
          showNotification("å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡", "warning");
          return;
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        var reader = new FileReader();
        reader.onload = function (e) {
          var previewImage = document.getElementById("previewImage");
          previewImage.src = e.target.result;
          document.getElementById("photoPreview").style.display = "block";

          // å¼€å§‹è¯†åˆ«
          recognizeFood(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      // è°ƒç”¨ç™¾åº¦èœå“è¯†åˆ«APIï¼ˆé€šè¿‡Netlify Functionï¼‰
      async function recognizeFood(imageDataUrl) {
        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          document.getElementById("recognitionLoading").style.display = "block";
          document.getElementById("recognitionResults").style.display = "none";

          console.log("å¼€å§‹é£Ÿç‰©è¯†åˆ«...");

          // è°ƒç”¨Netlify Function
          var response = await fetch("/.netlify/functions/food-recognition", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: imageDataUrl,
              topNum: 5, // è¿”å›å‰5ä¸ªç»“æœ
              filterThreshold: 0.95, // ç½®ä¿¡åº¦é˜ˆå€¼
              baikeNum: 1, // è¿”å›ç™¾ç§‘ä¿¡æ¯
            }),
          });

          var data = await response.json();
          console.log("ç™¾åº¦APIè¿”å›ç»“æœ:", data);

          // éšè—åŠ è½½çŠ¶æ€
          document.getElementById("recognitionLoading").style.display = "none";

          if (data.success && data.results && data.results.length > 0) {
            displayRecognitionResults(data.results);
            showNotification(`æˆåŠŸè¯†åˆ«${data.results.length}ä¸ªèœå“`, "success");
          } else if (data.success && data.results.length === 0) {
            showNotification("æœªèƒ½è¯†åˆ«å‡ºèœå“ï¼Œè¯·å°è¯•æ›´æ¸…æ™°çš„å›¾ç‰‡", "warning");
            closePhotoRecognitionDialog();
          } else {
            showNotification(data.error || "è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
            closePhotoRecognitionDialog();
          }
        } catch (error) {
          console.error("é£Ÿç‰©è¯†åˆ«å¤±è´¥:", error);
          document.getElementById("recognitionLoading").style.display = "none";
          showNotification("é£Ÿç‰©è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
        }
      }

      // æ¨¡æ‹Ÿé£Ÿç‰©è¯†åˆ«ï¼ˆå®é™…é¡¹ç›®ä¸­å¯æ¥å…¥ç™¾åº¦AIã€è…¾è®¯AIç­‰æœåŠ¡ï¼‰
      async function simulateFoodRecognition(imageDataUrl) {
        // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
        await new Promise((resolve) => setTimeout(resolve, 2000));

        // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨çœŸå®çš„AIè¯†åˆ«APIï¼‰
        var mockResults = [
          {
            name: "è‹¹æœ",
            confidence: 0.95,
            calories: 52,
            protein: 0.3,
            carbs: 14,
            fat: 0.2,
            unit: "ä¸ª",
          },
          {
            name: "é¦™è•‰",
            confidence: 0.88,
            calories: 89,
            protein: 1.1,
            carbs: 23,
            fat: 0.3,
            unit: "æ ¹",
          },
          {
            name: "é¸¡èƒ¸è‚‰",
            confidence: 0.92,
            calories: 165,
            protein: 31,
            carbs: 0,
            fat: 3.6,
            unit: "100g",
          },
          {
            name: "è¥¿å…°èŠ±",
            confidence: 0.85,
            calories: 34,
            protein: 2.8,
            carbs: 7,
            fat: 0.4,
            unit: "100g",
          },
          {
            name: "ç±³é¥­",
            confidence: 0.9,
            calories: 130,
            protein: 2.7,
            carbs: 28,
            fat: 0.3,
            unit: "ç¢—",
          },
        ];

        // éšæœºè¿”å›1-3ä¸ªè¯†åˆ«ç»“æœ
        var resultCount = Math.floor(Math.random() * 3) + 1;
        return mockResults.slice(0, resultCount).map((result) => ({
          ...result,
          id: "recognized_" + Date.now() + Math.random(),
        }));
      }

      // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
      function displayRecognitionResults(results) {
        var container = document.getElementById("recognizedFoodsList");
        container.innerHTML = "";

        // æŒ‰ç½®ä¿¡åº¦æ’åº
        results.sort((a, b) => b.confidence - a.confidence);

        results.forEach((food) => {
          var resultItem = document.createElement("div");
          resultItem.className = "food-result-item";
          resultItem.style.margin = "10px 0";
          resultItem.style.padding = "15px";
          resultItem.style.background = "white";
          resultItem.style.borderRadius = "10px";
          resultItem.style.border = "2px solid #e9ecef";
          resultItem.style.transition = "all 0.3s ease";

          // æ ¹æ®ç½®ä¿¡åº¦è®¾ç½®è¾¹æ¡†é¢œè‰²
          if (food.confidence > 0.9) {
            resultItem.style.borderColor = "#4CAF50";
          } else if (food.confidence > 0.7) {
            resultItem.style.borderColor = "#FF9800";
          }

          // æ„å»ºHTMLå†…å®¹
          var baikeInfo = "";
          if (food.baike_info && food.baike_info.description) {
            var description = food.baike_info.description;
            if (description.length > 100) {
              description = description.substring(0, 100) + "...";
            }
            baikeInfo = `
                <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                    <small style="color: #666;">
                        <strong>ç™¾ç§‘ï¼š</strong>${description}
                        ${
                          food.baike_info.baike_url
                            ? `<a href="${food.baike_info.baike_url}" target="_blank" style="color: #667eea; margin-left: 5px;">æŸ¥çœ‹æ›´å¤š</a>`
                            : ""
                        }
                    </small>
                </div>
            `;
          }

          resultItem.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #333; font-size: 1.1em;">
                            ${food.name}
                        </span>
                        <span style="background: ${
                          food.confidence > 0.9
                            ? "#4CAF50"
                            : food.confidence > 0.7
                            ? "#FF9800"
                            : "#9E9E9E"
                        }; 
                                   color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">
                            ${(food.confidence * 100).toFixed(1)}%
                        </span>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                        <span class="nutrition-badge" style="background: #fff3cd; color: #856404;">
                            ğŸ”¥ ${food.calorie.toFixed(1)} kcal/100g
                        </span>
                        <span class="nutrition-badge" style="background: #d1ecf1; color: #0c5460;">
                            ä¼°ç®— ${food.estimatedWeight}g
                        </span>
                        <span class="nutrition-badge" style="background: #f8d7da; color: #721c24;">
                            æ€»çƒ­é‡ ${food.totalCalories} kcal
                        </span>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <small style="color: #666;">
                            è›‹ç™½è´¨: ${food.nutrition.protein}g | 
                            ç¢³æ°´: ${food.nutrition.carbs}g | 
                            è„‚è‚ª: ${food.nutrition.fat}g
                        </small>
                    </div>
                    
                    ${baikeInfo}
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="add-food-btn" 
                            onclick="addRecognizedFoodWithQuantity('${encodeURIComponent(
                              JSON.stringify(food)
                            )}')"
                            style="background: #28a745; color: white; border: none; 
                                   padding: 10px 20px; border-radius: 20px; cursor: pointer;
                                   font-size: 0.9em; font-weight: 500; white-space: nowrap;">
                        æ·»åŠ 
                    </button>
                    <button onclick="adjustFoodWeight('${encodeURIComponent(
                      JSON.stringify(food)
                    )}')"
                            style="background: #17a2b8; color: white; border: none; 
                                   padding: 8px 15px; border-radius: 15px; cursor: pointer;
                                   font-size: 0.85em; white-space: nowrap;">
                        è°ƒæ•´é‡é‡
                    </button>
                </div>
            </div>
        `;

          container.appendChild(resultItem);
        });

        document.getElementById("recognitionResults").style.display = "block";
      }

      // æ·»åŠ è¯†åˆ«çš„é£Ÿç‰©ï¼ˆå¸¦æ•°é‡ç¡®è®¤ï¼‰
      function addRecognizedFoodWithQuantity(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));

          // ä½¿ç”¨é»˜è®¤ä¼°ç®—é‡é‡æˆ–è®©ç”¨æˆ·è¾“å…¥
          var weight = prompt(
            `è¯·è¾“å…¥ "${food.name}" çš„é‡é‡ï¼ˆå…‹ï¼‰ï¼š`,
            food.estimatedWeight
          );

          if (weight && !isNaN(weight) && parseFloat(weight) > 0) {
            weight = parseFloat(weight);

            // æ ¹æ®å®é™…é‡é‡é‡æ–°è®¡ç®—è¥å…»ä¿¡æ¯
            var factor = weight / 100; // ç™¾åº¦APIè¿”å›çš„æ˜¯æ¯100gçš„æ•°æ®

            var foodRecord = {
              id: food.id,
              name: food.name,
              calories: Math.round(food.calorie * factor),
              protein:
                Math.round(
                  ((food.nutrition.protein * weight) / food.estimatedWeight) *
                    10
                ) / 10,
              carbs:
                Math.round(
                  ((food.nutrition.carbs * weight) / food.estimatedWeight) * 10
                ) / 10,
              fat:
                Math.round(
                  ((food.nutrition.fat * weight) / food.estimatedWeight) * 10
                ) / 10,
              recordId: Date.now(),
              quantity: 1,
              unit: weight + "g",
              isBaiduRecognized: true,
              confidence: food.confidence,
            };

            // æ·»åŠ åˆ°å½“å‰é¤é£Ÿè®°å½•
            addFoodRecord(foodRecord, currentMealType, 1);

            showNotification(`âœ… å·²æ·»åŠ  ${food.name} (${weight}g)`, "success");

            // å¦‚æœæ‰€æœ‰é£Ÿç‰©éƒ½å·²å¤„ç†ï¼Œå…³é—­å¯¹è¯æ¡†
            var remainingItems = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            if (remainingItems.length <= 1) {
              setTimeout(() => {
                closePhotoRecognitionDialog();
              }, 1000);
            }
          }
        } catch (error) {
          console.error("æ·»åŠ è¯†åˆ«é£Ÿç‰©å¤±è´¥:", error);
          showNotification("æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
        }
      }

      // è°ƒæ•´é£Ÿç‰©é‡é‡
      function adjustFoodWeight(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));

          var newWeight = prompt(
            `è°ƒæ•´ "${food.name}" çš„é‡é‡ï¼ˆå…‹ï¼‰ï¼š`,
            food.estimatedWeight
          );

          if (newWeight && !isNaN(newWeight) && parseFloat(newWeight) > 0) {
            newWeight = parseFloat(newWeight);

            // æ›´æ–°æ˜¾ç¤ºçš„é‡é‡å’Œè¥å…»ä¿¡æ¯
            food.estimatedWeight = newWeight;
            food.totalCalories = Math.round((food.calorie * newWeight) / 100);
            food.nutrition.calories = food.totalCalories;
            food.nutrition.protein = Math.round((food.totalCalories * 0.2) / 4);
            food.nutrition.carbs = Math.round((food.totalCalories * 0.5) / 4);
            food.nutrition.fat = Math.round((food.totalCalories * 0.3) / 9);
            food.nutrition.unit = `${newWeight}g`;

            // é‡æ–°æ˜¾ç¤ºç»“æœ
            var currentResults = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            var results = [];
            currentResults.forEach((item) => {
              // ä¿ç•™å…¶ä»–é¡¹ï¼Œæ›´æ–°å½“å‰é¡¹
              results.push(food);
            });

            displayRecognitionResults(results);
            showNotification(`å·²è°ƒæ•´é‡é‡ä¸º ${newWeight}g`, "success");
          }
        } catch (error) {
          console.error("è°ƒæ•´é‡é‡å¤±è´¥:", error);
          showNotification("è°ƒæ•´å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
        }
      }

      // å‘é€èŠå¤©æ¶ˆæ¯ï¼ˆæ”¯æŒSSEæµå¼è¾“å‡ºï¼‰
      async function sendChatPageMessage() {
        var messageInput = document.getElementById("chatPageMessageInput");
        var message = messageInput.value.trim();

        // éªŒè¯æ¶ˆæ¯å†…å®¹
        if (!message || chatPageAI.isStreaming) {
          return;
        }

        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶è®¾ç½®çŠ¶æ€
        messageInput.value = "";
        messageInput.style.height = "auto";
        document.getElementById("chatPageSendButton").disabled = true;
        chatPageAI.isStreaming = true;

        try {
          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
          addChatPageMessage(message, "user");

          // æ·»åŠ AIæ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼è¾“å‡ºï¼‰
          var aiMessageDiv = addChatPageMessage(
            "",
            "assistant",
            false,
            false,
            true
          );
          var aiMessageContent = aiMessageDiv.querySelector(
            ".chat-message-content"
          );

          // æ„å»ºè¯·æ±‚æ¶ˆæ¯å†å²
          var requestMessages = [
            {
              role: "system",
              content: buildSystemPrompt(),
            },
            ...chatPageAI.messages,
            {
              role: "user",
              content: message,
            },
          ];

          console.log("å¼€å§‹SSEæµå¼å¯¹è¯...");

          // è°ƒç”¨SSEæµå¼API
          var fullResponse = await streamChatCompletion(
            requestMessages,
            aiMessageContent
          );

          // ä¿å­˜å¯¹è¯å†å²
          chatPageAI.messages.push(
            { role: "user", content: message },
            { role: "assistant", content: fullResponse }
          );
        } catch (error) {
          console.error("AIèŠå¤©é”™è¯¯:", error);

          // ç§»é™¤ç©ºçš„AIæ¶ˆæ¯å®¹å™¨
          var emptyAiMessage = document.querySelector(
            ".chat-message.assistant .chat-message-content:empty"
          );
          if (emptyAiMessage) {
            emptyAiMessage.closest(".chat-message").remove();
          }

          addChatPageMessage(
            `æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤æ‚¨çš„é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`,
            "assistant",
            false,
            true
          );
        } finally {
          // æ¢å¤ç•Œé¢çŠ¶æ€
          chatPageAI.isStreaming = false;
          var messageInput = document.getElementById("chatPageMessageInput");
          var sendButton = document.getElementById("chatPageSendButton");
          sendButton.disabled = messageInput.value.trim().length === 0;
        }
      }

      // SSEæµå¼èŠå¤©å®Œæˆ
      async function streamChatCompletion(messages, targetElement) {
        return new Promise((resolve, reject) => {
          var fullResponse = "";
          var controller = new AbortController();
          var timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error("è¯·æ±‚è¶…æ—¶"));
          }, 60000); // 60ç§’è¶…æ—¶

          fetch(AI_API_CONFIG.endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: AI_API_CONFIG.headers.Authorization,
            },
            body: JSON.stringify({
              messages: messages,
              stream: true, // å¯ç”¨æµå¼è¾“å‡º
            }),
            signal: controller.signal,
          })
            .then((response) => {
              clearTimeout(timeoutId);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              if (!response.body) {
                throw new Error("å“åº”ä½“ä¸ºç©º");
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              function processStream() {
                return reader.read().then(({ done, value }) => {
                  if (done) {
                    console.log("SSEæµå¼è¾“å‡ºå®Œæˆ");
                    // ç§»é™¤å…‰æ ‡
                    var cursor =
                      targetElement.querySelector(".streaming-cursor");
                    if (cursor) cursor.remove();
                    resolve(fullResponse);
                    return;
                  }

                  const chunk = decoder.decode(value, { stream: true });
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      const data = line.slice(6).trim();

                      if (data === "[DONE]") {
                        // ç§»é™¤å…‰æ ‡
                        var cursor =
                          targetElement.querySelector(".streaming-cursor");
                        if (cursor) cursor.remove();
                        resolve(fullResponse);
                        return;
                      }

                      try {
                        const parsed = JSON.parse(data);
                        const content = parsed.choices?.[0]?.delta?.content;

                        if (content) {
                          fullResponse += content;
                          // å®æ—¶æ›´æ–°æ˜¾ç¤ºå†…å®¹
                          updateStreamingContent(targetElement, fullResponse);
                        }
                      } catch (e) {
                        console.warn("è§£æSSEæ•°æ®å¤±è´¥:", e, data);
                      }
                    }
                  }

                  return processStream();
                });
              }

              return processStream();
            })
            .catch((error) => {
              clearTimeout(timeoutId);
              console.error("SSEæµå¼è¯·æ±‚å¤±è´¥:", error);
              reject(error);
            });
        });
      }

      // æ›´æ–°æµå¼å†…å®¹æ˜¾ç¤º
      function updateStreamingContent(targetElement, content) {
        // å¤„ç†æ¢è¡Œå’Œæ ¼å¼åŒ–
        var formattedContent = content
          .replace(/\n/g, "<br>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        // æ·»åŠ æµå¼è¾“å‡ºå…‰æ ‡
        targetElement.innerHTML =
          formattedContent + '<span class="streaming-cursor"></span>';

        // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: "smooth",
        });
      }

      // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒæµå¼è¾“å‡ºï¼‰
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false,
        isStreaming = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // è®¾ç½®å¤´åƒ
        var avatar = role === "user" ? "ğŸ‘¤" : "ğŸ¤–";

        // è®¾ç½®æ¶ˆæ¯å†…å®¹
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else if (isStreaming) {
          messageContent = '<span class="streaming-cursor"></span>'; // åˆå§‹åªæ˜¾ç¤ºå…‰æ ‡
        } else {
          // å¤„ç†æ¢è¡Œå’Œæ ¼å¼åŒ–
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // å¹³æ»‘æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // SSEæµå¼èŠå¤©å®Œæˆ
      async function streamChatCompletion(messages, targetElement) {
        return new Promise((resolve, reject) => {
          var fullResponse = "";
          var controller = new AbortController();
          var timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error("è¯·æ±‚è¶…æ—¶"));
          }, 60000); // 60ç§’è¶…æ—¶

          fetch(AI_API_CONFIG.endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: AI_API_CONFIG.headers.Authorization,
            },
            body: JSON.stringify({
              messages: messages,
              stream: true, // å¯ç”¨æµå¼è¾“å‡º
            }),
            signal: controller.signal,
          })
            .then((response) => {
              clearTimeout(timeoutId);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              if (!response.body) {
                throw new Error("å“åº”ä½“ä¸ºç©º");
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              function processStream() {
                return reader.read().then(({ done, value }) => {
                  if (done) {
                    console.log("SSEæµå¼è¾“å‡ºå®Œæˆ");
                    resolve(fullResponse);
                    return;
                  }

                  const chunk = decoder.decode(value, { stream: true });
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      const data = line.slice(6).trim();

                      if (data === "[DONE]") {
                        resolve(fullResponse);
                        return;
                      }

                      try {
                        const parsed = JSON.parse(data);
                        const content = parsed.choices?.[0]?.delta?.content;

                        if (content) {
                          fullResponse += content;
                          // å®æ—¶æ›´æ–°æ˜¾ç¤ºå†…å®¹
                          updateStreamingContent(targetElement, fullResponse);
                        }
                      } catch (e) {
                        console.warn("è§£æSSEæ•°æ®å¤±è´¥:", e, data);
                      }
                    }
                  }

                  return processStream();
                });
              }

              return processStream();
            })
            .catch((error) => {
              clearTimeout(timeoutId);
              console.error("SSEæµå¼è¯·æ±‚å¤±è´¥:", error);
              reject(error);
            });
        });
      }

      // æ›´æ–°æµå¼å†…å®¹æ˜¾ç¤º
      function updateStreamingContent(targetElement, content) {
        // å¤„ç†æ¢è¡Œå’Œæ ¼å¼åŒ–
        var formattedContent = content
          .replace(/\n/g, "<br>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        // æ·»åŠ æµå¼è¾“å‡ºå…‰æ ‡
        targetElement.innerHTML =
          formattedContent + '<span class="streaming-cursor"></span>';

        // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: "smooth",
        });
      }

      // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒæµå¼è¾“å‡ºï¼‰
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false,
        isStreaming = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // è®¾ç½®å¤´åƒ
        var avatar = role === "user" ? "ğŸ‘¤" : "ğŸ¤–";

        // è®¾ç½®æ¶ˆæ¯å†…å®¹
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else if (isStreaming) {
          messageContent = '<span class="streaming-cursor"></span>'; // åˆå§‹åªæ˜¾ç¤ºå…‰æ ‡
        } else {
          // å¤„ç†æ¢è¡Œå’Œæ ¼å¼åŒ–
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // å¹³æ»‘æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // æ„å»ºç³»ç»Ÿæç¤ºè¯
      function buildSystemPrompt() {
        var systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIå¥åº·é¥®é£ŸåŠ©æ‰‹ï¼Œåå­—å«"å°å¥"ã€‚è¯·ç”¨æ¸©æš–ã€ä¸“ä¸šçš„è¯­æ°”ä¸ºç”¨æˆ·æä¾›ä¸ªæ€§åŒ–çš„å¥åº·å»ºè®®ã€‚

ä½ çš„ä¸“é•¿é¢†åŸŸåŒ…æ‹¬ï¼š
- è¥å…»å­¦å’Œé¥®é£Ÿæ­é…
- è¿åŠ¨å¥èº«æŒ‡å¯¼  
- å¥åº·ç”Ÿæ´»æ–¹å¼å»ºè®®
- ç–¾ç—…é¢„é˜²çŸ¥è¯†

è¯·æ³¨æ„ï¼š
1. å›ç­”è¦ä¸“ä¸šä½†æ˜“æ‡‚ï¼Œé¿å…è¿‡äºåŒ»å­¦åŒ–çš„æœ¯è¯­
2. æ ¹æ®ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯æä¾›ä¸ªæ€§åŒ–å»ºè®®
3. å¦‚æœæ¶‰åŠä¸¥é‡å¥åº·é—®é¢˜ï¼Œå»ºè®®ç”¨æˆ·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ
4. ä¿æŒç§¯ææ­£é¢çš„æ€åº¦ï¼Œé¼“åŠ±ç”¨æˆ·å…»æˆå¥åº·ä¹ æƒ¯`;

        // æ·»åŠ ç”¨æˆ·ä¸ªäººä¿¡æ¯
        if (userProfile.fullName) {
          systemPrompt += `\n\nğŸ“‹ ç”¨æˆ·ä¸ªäººæ¡£æ¡ˆï¼š
- å§“åï¼š${userProfile.fullName}
- æ€§åˆ«ï¼š${
            userProfile.gender === "male"
              ? "ç”·æ€§"
              : userProfile.gender === "female"
              ? "å¥³æ€§"
              : "æœªè®¾ç½®"
          }
- èº«é«˜ï¼š${userProfile.height || "æœªè®¾ç½®"}cm
- ä½“é‡ï¼š${userProfile.weight || "æœªè®¾ç½®"}kg`;

          if (userProfile.targetWeight) {
            systemPrompt += `\n- ç›®æ ‡ä½“é‡ï¼š${userProfile.targetWeight}kg`;
          }

          if (userProfile.activityLevel) {
            var activityLabels = {
              sedentary: "ä¹…åå°‘åŠ¨",
              light: "è½»åº¦è¿åŠ¨",
              moderate: "ä¸­åº¦è¿åŠ¨",
              active: "é«˜åº¦è¿åŠ¨",
              "very-active": "ä¸“ä¸šè¿åŠ¨å‘˜",
            };
            systemPrompt += `\n- è¿åŠ¨é¢‘ç‡ï¼š${
              activityLabels[userProfile.activityLevel] ||
              userProfile.activityLevel
            }`;
          }

          if (userProfile.goals && userProfile.goals.length > 0) {
            var goalLabels = {
              "weight-loss": "å‡é‡ç˜¦èº«",
              "muscle-gain": "å¢è‚Œå¡‘å½¢",
              "healthy-eating": "å¥åº·é¥®é£Ÿ",
              "disease-prevention": "ç–¾ç—…é¢„é˜²",
            };
            var goalsText = userProfile.goals
              .map((goal) => goalLabels[goal] || goal)
              .join("ã€");
            systemPrompt += `\n- å¥åº·ç›®æ ‡ï¼š${goalsText}`;
          }
        }

        // æ·»åŠ å½“å‰è¥å…»çŠ¶å†µ
        var currentNutrition = getCurrentNutrition();
        if (currentNutrition.calories > 0) {
          systemPrompt += `\n\nğŸ“Š ä»Šæ—¥è¥å…»æ‘„å…¥æƒ…å†µï¼š
- å·²æ‘„å…¥çƒ­é‡ï¼š${Math.round(currentNutrition.calories)} kcal
- è›‹ç™½è´¨ï¼š${currentNutrition.protein.toFixed(1)}g
- ç¢³æ°´åŒ–åˆç‰©ï¼š${currentNutrition.carbs.toFixed(1)}g  
- è„‚è‚ªï¼š${currentNutrition.fat.toFixed(1)}g`;

          if (nutritionPlan.targets) {
            systemPrompt += `\n\nğŸ¯ è¥å…»ç›®æ ‡ï¼š
- ç›®æ ‡çƒ­é‡ï¼š${nutritionPlan.targets.calories} kcal
- ç›®æ ‡è›‹ç™½è´¨ï¼š${nutritionPlan.targets.protein}g
- ç›®æ ‡ç¢³æ°´ï¼š${nutritionPlan.targets.carbs}g
- ç›®æ ‡è„‚è‚ªï¼š${nutritionPlan.targets.fat}g`;
          }
        }

        return systemPrompt;
      }

      // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // è®¾ç½®å¤´åƒ
        var avatar = role === "user" ? "ğŸ‘¤" : "ğŸ¤–";

        // è®¾ç½®æ¶ˆæ¯å†…å®¹
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else {
          // å¤„ç†æ¢è¡Œå’Œæ ¼å¼åŒ–
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // å¹³æ»‘æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // æ˜¾ç¤ºé€šçŸ¥ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒä¸åŒç±»å‹ï¼‰
      function showNotification(message, type = "success") {
        var notification = document.getElementById("notification");
        notification.innerHTML = message; // æ”¯æŒHTMLå†…å®¹
        notification.className = "notification " + type;
        notification.style.display = "block";

        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é—´
        var displayTime =
          type === "info" ? 4000 : type === "warning" ? 5000 : 3000;

        setTimeout(() => {
          notification.style.display = "none";
        }, displayTime);
      }

      // ä¿å­˜ç”¨æˆ·æ•°æ®
      function saveUserData() {
        var userData = {
          userProfile: userProfile,
          nutritionPlan: nutritionPlan,
          recordedFoods: recordedFoods,
          waterGlasses: waterGlasses,
          lastSaved: new Date().toISOString(),
        };

        try {
          // ç”±äºä¸èƒ½ä½¿ç”¨localStorageï¼Œæˆ‘ä»¬åªåœ¨å†…å­˜ä¸­ä¿å­˜
          console.log("æ•°æ®å·²ä¿å­˜åˆ°å†…å­˜:", userData);
        } catch (error) {
          console.error("ä¿å­˜æ•°æ®å¤±è´¥:", error);
        }
      }

      // åŠ è½½ç”¨æˆ·æ•°æ®
      function loadUserData() {
        try {
          // ç”±äºä¸èƒ½ä½¿ç”¨localStorageï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤æ•°æ®
          console.log("ä»å†…å­˜åŠ è½½æ•°æ®");
          updateNutritionTracking();
          updateWaterDisplay();
          updateAllMealRecorded();
        } catch (error) {
          console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
        }
      }

      // æ›´æ–°æ‰€æœ‰é¤é£Ÿè®°å½•æ˜¾ç¤º
      function updateAllMealRecorded() {
        ["breakfast", "lunch", "dinner"].forEach((mealType) => {
          updateMealRecorded(mealType);
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
      document.addEventListener("DOMContentLoaded", function () {
        var customDialog = document.getElementById("customFoodDialog");
        var photoDialog = document.getElementById("photoRecognitionDialog");

        // éªŒè¯æŒ‰é’®
        var customBtns = document.querySelectorAll(
          '[onclick*="openCustomFoodDialog"]'
        );
        var photoBtns = document.querySelectorAll(
          '[onclick*="openPhotoRecognitionDialog"]'
        );

        loadUserData();
        displayPersonalPlan();

        // è‡ªåŠ¨å±•å¼€ç¬¬ä¸€ä¸ªé¤é£ŸåŒºåŸŸ
        var firstMealSection = document.querySelector(".meal-time-section");
        if (firstMealSection) {
          firstMealSection.classList.add("expanded");
        }

        // æ·»åŠ å¯¹è¯æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
        if (customDialog) {
          customDialog.addEventListener("click", function (e) {
            if (e.target === this) {
              closeCustomFoodDialog();
            }
          });
        }

        if (photoDialog) {
          photoDialog.addEventListener("click", function (e) {
            if (e.target === this) {
              closePhotoRecognitionDialog();
            }
          });
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCustomFoodDialog();
            closePhotoRecognitionDialog();
          }

          // åœ¨è‡ªå®šä¹‰é£Ÿç‰©å¯¹è¯æ¡†ä¸­æ”¯æŒEnterå¿«æ·é”®
          if (e.key === "Enter" && e.ctrlKey) {
            var customDialog = document.getElementById("customFoodDialog");
            if (customDialog && customDialog.style.display === "flex") {
              var analyzeBtn = document.getElementById("analyzeNutritionBtn");
              var addBtn = document.getElementById("addAnalyzedFoodBtn");

              if (analyzeBtn && analyzeBtn.style.display !== "none") {
                analyzeCustomFood();
              } else if (addBtn && addBtn.style.display !== "none") {
                addAnalyzedFood();
              }
            }
          }
        });

        console.log("âœ… æ™ºèƒ½å¥åº·é¥®é£ŸåŠ©æ‰‹åŠ è½½å®Œæˆ");
        console.log("âœ… å…¨å±€å‡½æ•°å·²æ³¨å†Œåˆ°windowå¯¹è±¡");

        // æœ€åéªŒè¯ä¸€æ¬¡
        setTimeout(() => {
          console.log("ğŸ” æœ€ç»ˆéªŒè¯å‡½æ•°å¯è®¿é—®æ€§:");
          console.log(
            "- window.openCustomFoodDialog:",
            typeof window.openCustomFoodDialog
          );
          console.log(
            "- window.openPhotoRecognitionDialog:",
            typeof window.openPhotoRecognitionDialog
          );

          if (typeof window.openCustomFoodDialog === "function") {
            console.log("âœ… è‡ªå®šä¹‰é£Ÿç‰©åŠŸèƒ½å°±ç»ª");
          } else {
            console.error("âŒ è‡ªå®šä¹‰é£Ÿç‰©åŠŸèƒ½æœªå°±ç»ª");
          }
        }, 1000);
      });

      // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®ç”¨äºæ¼”ç¤º
      function addSampleData() {
        // æ·»åŠ ç¤ºä¾‹æ—©é¤
        addFoodRecord(foodDatabase[0], "breakfast", 1); // ç‡•éº¦ç²¥
        addFoodRecord(foodDatabase[2], "breakfast", 1); // ç…®é¸¡è›‹

        // æ·»åŠ ç¤ºä¾‹åˆé¤
        addFoodRecord(foodDatabase[4], "lunch", 1); // é¸¡èƒ¸è‚‰
        addFoodRecord(foodDatabase[5], "lunch", 1); // ç±³é¥­
        addFoodRecord(foodDatabase[6], "lunch", 1); // è¥¿å…°èŠ±

        // è®¾ç½®ä¸€äº›é¥®æ°´è®°å½•
        waterGlasses[0] = true;
        waterGlasses[1] = true;
        waterGlasses[2] = true;

        updateNutritionTracking();
        updateWaterDisplay();
        updateAllMealRecorded();

        showNotification("å·²æ·»åŠ ç¤ºä¾‹æ•°æ®ï¼", "success");
      }

      // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œå¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°
      // addSampleData();
    </script>
  </body>
</html>
