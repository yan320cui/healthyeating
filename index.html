<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="智能健康饮食助手" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='bg' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23667eea'/><stop offset='1' stop-color='%23764ba2'/></linearGradient></defs><rect width='64' height='64' rx='16' fill='url(%23bg)'/><ellipse cx='32' cy='32' rx='24' ry='24' fill='%23fff'/><ellipse cx='32' cy='32' rx='18' ry='16' fill='%2366bb6a' opacity='0.8'/><circle cx='24' cy='26' r='5' fill='%234caf50'/><circle cx='40' cy='26' r='5' fill='%234caf50'/><circle cx='22' cy='34' r='4.5' fill='%23f44336'/><circle cx='42' cy='34' r='4.5' fill='%23f44336'/></svg>" type="image/svg+xml">
    <meta
      name="description"
      content="专业的AI驱动健康饮食管理助手，提供个性化营养追踪和智能饮食建议"
    />
    <title>智能健康饮食助手 - AI驱动的个性化健康管理</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --text-primary: #333;
        --text-secondary: #666;
        --bg-light: #f8f9fa;
        --border-radius: 15px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        color: var(--text-primary);
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 119, 198, 0.3),
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(255, 119, 198, 0.3),
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 20%,
            rgba(255, 255, 255, 0.1),
            transparent 50%
          );
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) rotate(0deg);
        }
        33% {
          transform: translate(-20px, -20px) rotate(1deg);
        }
        66% {
          transform: translate(20px, -10px) rotate(-1deg);
        }
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: fadeInDown 0.8s ease-out;
      }

      .header h1 {
        font-size: 3.5em;
        margin-bottom: 15px;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        letter-spacing: 2px;
      }

      .header p {
        font-size: 1.3em;
        opacity: 0.95;
        font-weight: 300;
      }

      .nav-buttons {
        margin-top: 25px;
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 35px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .nav-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .nav-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .nav-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .nav-btn.active {
        background: white;
        color: #667eea;
        border-color: white;
        font-weight: 600;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin-bottom: 40px;
      }

      @media (min-width: 768px) {
        .main-content {
          grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
        animation: slideUp 0.6s ease-out;
        position: relative;
        overflow: hidden;
        grid-column: 1 / -1;
      }

      /* .card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(102, 126, 234, 0.05) 0%,
          transparent 70%
        );
        transform: rotate(45deg);
        transition: transform 0.6s;
      }

      .card:hover::before {
        transform: rotate(45deg) translate(10%, 10%);
      } */

      .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 2em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .meal-time-section {
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        border-left: 5px solid #667eea;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .meal-time-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: var(--transition);
        position: relative;
        z-index: 1;
      }

      .meal-time-header:hover {
        background: rgba(102, 126, 234, 0.1);
      }

      .meal-time-title {
        color: #667eea;
        font-size: 1.5em;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .meal-expand-arrow {
        color: #667eea;
        font-size: 1.2em;
        transition: transform 0.3s ease;
      }

      .meal-time-section.expanded .meal-expand-arrow {
        transform: rotate(180deg);
      }

      .meal-content {
        padding: 0 25px 25px;
        display: none;
        position: relative;
        z-index: 1;
      }

      .meal-time-section.expanded .meal-content {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .meal-search-container {
        position: relative;
        margin-bottom: 15px;
      }

      .meal-search-input {
        width: 100%;
        padding: 12px 50px 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 15px;
        transition: var(--transition);
        background: white;
      }

      .meal-search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .search-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--primary-gradient);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        font-size: 18px;
      }

      .search-btn:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .nutrition-tracker {
        background: var(--secondary-gradient);
        color: white;
        padding: 30px;
        border-radius: 25px;
        margin-top: 25px;
        position: relative;
        overflow: hidden;
      }

      .nutrition-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 20px;
        margin-top: 25px;
        position: relative;
        z-index: 1;
      }

      .nutrition-stat {
        background: rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
      }

      .nutrition-stat:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.25);
      }

      .nutrition-value {
        font-size: 2.2em;
        font-weight: bold;
        margin-bottom: 8px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .progress-bar {
        background: rgba(255, 255, 255, 0.3);
        height: 10px;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
        background: white;
        position: relative;
        overflow: hidden;
      }

      .water-glass {
        font-size: 2.5em;
        cursor: pointer;
        transition: var(--transition);
        display: inline-block;
        filter: grayscale(100%);
        opacity: 0.5;
      }

      .water-glass.filled {
        filter: grayscale(0%);
        opacity: 1;
        animation: fillWater 0.5s ease;
      }

      @keyframes fillWater {
        0% {
          transform: scale(1) rotate(0deg);
        }
        50% {
          transform: scale(1.2) rotate(-10deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      .water-glass:hover {
        transform: scale(1.15) rotate(-5deg);
      }

      .profile-page,
      .chat-page,
      .diet-plan-page {
        display: none;
      }

      .profile-container,
      .chat-page-container,
      .diet-plan-container {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 30px;
        padding: 40px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        max-width: 1200px;
        margin: 0 auto;
        animation: slideUp 0.6s ease-out;
      }

      .chat-page-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
      }

      .chat-main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid #e9ecef;
      }

      .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .input-container {
        padding: 15px;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .message-input {
        flex: 1;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        padding: 10px 15px;
        font-size: 14px;
        outline: none;
        resize: none;
        min-height: 40px;
        max-height: 100px;
        font-family: inherit;
      }

      .send-button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chat-message {
        margin-bottom: 20px;
        display: flex;
        animation: messageSlideIn 0.3s ease-out;
      }

      .chat-message.user {
        justify-content: flex-end;
      }

      .chat-message.assistant {
        justify-content: flex-start;
      }

      .chat-message-content {
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 20px;
        word-wrap: break-word;
        line-height: 1.6;
      }

      .chat-message.user .chat-message-content {
        background: var(--primary-gradient);
        color: white;
        border-bottom-right-radius: 5px;
      }

      .chat-message.assistant .chat-message-content {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .chat-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin: 0 10px;
        flex-shrink: 0;
      }

      .chat-message.user .chat-avatar {
        background: var(--primary-gradient);
        color: white;
        order: 2;
      }

      .chat-message.assistant .chat-avatar {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
        animation: slideInRight 0.5s ease;
        z-index: 1000;
        max-width: 350px;
      }

      .notification.success {
        border-left: 5px solid var(--success-color);
      }

      .notification.warning {
        border-left: 5px solid var(--warning-color);
      }

      .notification.info {
        border-left: 5px solid #2196f3;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 2.2em;
        }

        .header p {
          font-size: 1.1em;
        }

        .nav-buttons {
          flex-direction: column;
          width: 100%;
        }

        .nav-btn {
          width: 100%;
          max-width: 300px;
          margin: 5px auto;
        }

        .card {
          padding: 20px;
        }

        .nutrition-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.8em;
        }

        .nutrition-grid {
          grid-template-columns: 1fr;
        }

        .water-glass {
          font-size: 2em;
        }

        .chat-message-content {
          max-width: 85%;
        }
      }

      /* 其他必要样式 */
      button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin: 5px;
      }

      button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #667eea;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        transition: var(--transition);
        background: #f8f9fa;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }

      .bmi-calculator {
        background: var(--primary-gradient);
        color: white;
        padding: 25px;
        border-radius: 20px;
        margin-top: 20px;
        text-align: center;
      }

      .bmi-display {
        font-size: 3em;
        font-weight: bold;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .bmi-status {
        font-size: 1.2em;
        padding: 10px 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        display: inline-block;
        margin-top: 10px;
      }

      .water-tracker {
        text-align: center;
        margin-top: 20px;
      }

      .water-glasses {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .meal-search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
      }

      .food-result-item {
        background: white;
        padding: 15px;
        margin: 8px 0;
        border-radius: 15px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid transparent;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .food-result-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      }

      .nutrition-badge {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin: 0 2px;
      }

      .add-food-btn {
        background: var(--success-color);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: var(--transition);
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
      }

      .add-food-btn:hover {
        background: #45a049;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      /* 流式输出光标效果 */
      .streaming-cursor {
        display: inline-block;
        width: 2px;
        height: 1.2em;
        background: #667eea;
        animation: blink 1s infinite;
        vertical-align: baseline;
        margin-left: 2px;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      /* 加载动画 */
      .chat-typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .chat-typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.4s infinite ease-in-out;
      }

      .chat-typing-indicator span:nth-child(1) {
        animation-delay: 0ms;
      }
      .chat-typing-indicator span:nth-child(2) {
        animation-delay: 200ms;
      }
      .chat-typing-indicator span:nth-child(3) {
        animation-delay: 400ms;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-8px);
          opacity: 1;
        }
      }

      /* 自定义复选框样式 */
      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px solid #e9ecef;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 12px;
        border-radius: 8px;
        transition: var(--transition);
        background: white;
        border: 2px solid transparent;
        position: relative;
        user-select: none;
      }

      .checkbox-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .checkbox-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .checkbox-custom {
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-radius: 4px;
        position: relative;
        transition: var(--transition);
        flex-shrink: 0;
      }

      .checkbox-item input[type="checkbox"]:checked + .checkbox-custom {
        background: var(--primary-gradient);
        border-color: #667eea;
      }

      .checkbox-item input[type="checkbox"]:checked + .checkbox-custom::after {
        content: "✓";
        position: absolute;
        color: white;
        font-size: 14px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .checkbox-label {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        flex: 1;
      }

      .checkbox-item input[type="checkbox"]:checked ~ .checkbox-label {
        color: #667eea;
        font-weight: 600;
      }

      /* 移动端优化 */
      @media (max-width: 768px) {
        .checkbox-group {
          grid-template-columns: 1fr 1fr;
          gap: 8px;
          padding: 12px;
        }

        .checkbox-item {
          padding: 8px 10px;
          font-size: 14px;
        }

        .checkbox-custom {
          width: 18px;
          height: 18px;
        }

        .checkbox-label {
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        .checkbox-group {
          grid-template-columns: 1fr;
        }
      }
      .plan-generator-panel {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 2px solid #e9ecef;
      }

      .generator-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .generator-header h3 {
        color: #667eea;
        font-size: 1.8em;
        margin-bottom: 10px;
      }

      .generator-header p {
        color: #666;
        font-size: 1.1em;
      }

      .generate-actions {
        text-align: center;
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .generate-plan-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .generate-plan-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .generate-plan-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .reset-btn,
      .save-plan-btn,
      .export-btn,
      .apply-btn {
        border: none;
        padding: 12px 25px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
      }

      .plan-display-area {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.6s ease-out;
      }

      .plan-overview {
        margin-bottom: 30px;
        padding: 20px;
        background: var(--primary-gradient);
        color: white;
        border-radius: 15px;
      }

      .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .plan-content {
        margin-bottom: 30px;
      }

      .day-plan {
        margin-bottom: 25px;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        background: white;
      }

      .day-header {
        background: var(--secondary-gradient);
        color: white;
        padding: 15px 25px;
        font-weight: 600;
        font-size: 1.2em;
      }

      .day-meals {
        padding: 20px;
      }

      .meal-section {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 12px;
        background: #f8f9fa;
        border-left: 4px solid #667eea;
      }

      .meal-title {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .meal-items {
        display: grid;
        gap: 10px;
      }

      .meal-item {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      .meal-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
      }

      .item-info {
        flex: 1;
      }

      .item-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
      }

      .item-nutrition {
        font-size: 0.85em;
        color: #666;
      }

      .item-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        object-fit: cover;
        margin-left: 15px;
      }

      .plan-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
      }

      .saved-plans-section {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .saved-plans-section h3 {
        color: #667eea;
        margin-bottom: 20px;
        text-align: center;
      }

      .saved-plan-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        transition: var(--transition);
      }

      .saved-plan-item:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .plan-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .plan-item-title {
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
      }

      .plan-item-date {
        color: #666;
        font-size: 0.9em;
      }

      .plan-item-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        font-size: 0.9em;
      }

      .plan-item-actions {
        display: flex;
        gap: 10px;
      }

      .plan-item-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.85em;
        transition: var(--transition);
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .custom-food-dialog,
      .photo-recognition-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .custom-food-dialog-content,
      .photo-dialog-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        animation: slideUp 0.3s ease;
        width: 90%;
      }
    </style>

    <!-- Markdown解析库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🥗 智能健康饮食助手</h1>
        <p>您的专属营养管理专家 - AI驱动的健康生活</p>
        <div class="nav-buttons">
          <button onclick="showMainPage()" class="nav-btn active" id="mainBtn">
            <span style="position: relative; z-index: 1">🏠 主页</span>
          </button>
          <button onclick="showProfilePage()" class="nav-btn" id="profileBtn">
            <span style="position: relative; z-index: 1">👤 个人中心</span>
          </button>
          <button onclick="showChatPage()" class="nav-btn" id="chatBtn">
            <span style="position: relative; z-index: 1">🤖 智能问答</span>
          </button>
          <button onclick="showDietPlanPage()" class="nav-btn" id="dietPlanBtn">
            <span style="position: relative; z-index: 1">📋 饮食计划</span>
          </button>
        </div>
      </div>

      <!-- 主页内容 -->
      <div class="main-content" id="mainContent">
        <div class="card">
          <h2>📋 我的健康计划</h2>
          <div id="personalPlanDisplay"></div>
          <div class="bmi-calculator" id="bmiCalculator" style="display: none">
            <h3>BMI 身体质量指数</h3>
            <div class="bmi-display" id="bmiValue">--</div>
            <div class="bmi-status" id="bmiStatus">请先完善个人信息</div>
          </div>
        </div>

        <div class="card">
          <h2>🍽️ 今日饮食记录</h2>
          <div id="mealSuggestions">
            <!-- 早餐 -->
            <div class="meal-time-section" id="breakfastSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('breakfast')"
              >
                <h3 class="meal-time-title">🌅 早餐</h3>
                <span class="meal-expand-arrow">▼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>记录早餐</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="breakfastSearchInput"
                      placeholder="搜索早餐食物..."
                      onkeyup="handleSearchKeyUp(event, 'breakfast')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('breakfast')"
                    >
                      🔍
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-breakfast"
                      onclick="openCustomFoodDialog('breakfast')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ➕ 自定义食物
                    </button>
                    <button
                      id="photoRecognitionBtn-breakfast"
                      onclick="openPhotoRecognitionDialog('breakfast')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      📷 拍照识别
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="breakfastSearchResults"
                  ></div>
                  <div class="meal-recorded" id="breakfastRecorded">
                    <h5>已记录：</h5>
                    <div id="breakfastRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 午餐 -->
            <div class="meal-time-section" id="lunchSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('lunch')"
              >
                <h3 class="meal-time-title">☀️ 午餐</h3>
                <span class="meal-expand-arrow">▼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>记录午餐</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="lunchSearchInput"
                      placeholder="搜索午餐食物..."
                      onkeyup="handleSearchKeyUp(event, 'lunch')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('lunch')"
                    >
                      🔍
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-lunch"
                      onclick="openCustomFoodDialog('lunch')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ➕ 自定义食物
                    </button>
                    <button
                      id="photoRecognitionBtn-lunch"
                      onclick="window.openPhotoRecognitionDialog('lunch')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      📷 拍照识别
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="lunchSearchResults"
                  ></div>
                  <div class="meal-recorded" id="lunchRecorded">
                    <h5>已记录：</h5>
                    <div id="lunchRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 晚餐 -->
            <div class="meal-time-section" id="dinnerSection">
              <div
                class="meal-time-header"
                onclick="toggleMealSection('dinner')"
              >
                <h3 class="meal-time-title">🌙 晚餐</h3>
                <span class="meal-expand-arrow">▼</span>
              </div>
              <div class="meal-content">
                <div class="meal-record-section">
                  <h4>记录晚餐</h4>
                  <div class="meal-search-container">
                    <input
                      type="text"
                      class="meal-search-input"
                      id="dinnerSearchInput"
                      placeholder="搜索晚餐食物..."
                      onkeyup="handleSearchKeyUp(event, 'dinner')"
                    />
                    <button
                      class="search-btn"
                      onclick="searchMealFood('dinner')"
                    >
                      🔍
                    </button>
                  </div>
                  <div
                    class="quick-add-buttons"
                    style="
                      margin: 10px 0;
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <button
                      id="customFoodBtn-dinner"
                      onclick="openCustomFoodDialog('dinner')"
                      style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      ➕ 自定义食物
                    </button>
                    <button
                      id="photoRecognitionBtn-dinner"
                      onclick="openPhotoRecognitionDialog('dinner')"
                      style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 15px;
                        font-size: 0.85em;
                        cursor: pointer;
                      "
                    >
                      📷 拍照识别
                    </button>
                  </div>
                  <div
                    class="meal-search-results"
                    id="dinnerSearchResults"
                  ></div>
                  <div class="meal-recorded" id="dinnerRecorded">
                    <h5>已记录：</h5>
                    <div id="dinnerRecordedList"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>📊 营养追踪</h2>
          <div class="nutrition-tracker">
            <h3>今日营养摄入情况</h3>
            <div class="nutrition-grid" id="nutritionGrid">
              <div class="nutrition-stat">
                <h4>🔥 卡路里</h4>
                <div class="nutrition-value" id="calorieValue">0</div>
                <div class="nutrition-target" id="calorieTarget">
                  目标: 2000
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="calorieProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>🥩 蛋白质</h4>
                <div class="nutrition-value" id="proteinValue">0g</div>
                <div class="nutrition-target" id="proteinTarget">目标: 50g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="proteinProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>🌾 碳水化合物</h4>
                <div class="nutrition-value" id="carbValue">0g</div>
                <div class="nutrition-target" id="carbTarget">目标: 250g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="carbProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="nutrition-stat">
                <h4>🥑 脂肪</h4>
                <div class="nutrition-value" id="fatValue">0g</div>
                <div class="nutrition-target" id="fatTarget">目标: 65g</div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="fatProgress"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="water-tracker">
            <h3>💧 今日饮水量</h3>
            <div class="water-glasses" id="waterGlasses">
              <span class="water-glass" onclick="toggleWater(0)">🥤</span>
              <span class="water-glass" onclick="toggleWater(1)">🥤</span>
              <span class="water-glass" onclick="toggleWater(2)">🥤</span>
              <span class="water-glass" onclick="toggleWater(3)">🥤</span>
              <span class="water-glass" onclick="toggleWater(4)">🥤</span>
              <span class="water-glass" onclick="toggleWater(5)">🥤</span>
              <span class="water-glass" onclick="toggleWater(6)">🥤</span>
              <span class="water-glass" onclick="toggleWater(7)">🥤</span>
            </div>
            <p id="waterCount" style="margin-top: 15px; font-size: 1.1em">
              已饮用:
              <span style="font-weight: bold; color: #2196f3">0</span> 杯 (<span
                style="font-weight: bold; color: #2196f3"
                >0</span
              >
              ml)
            </p>
            <p style="margin-top: 10px; opacity: 0.8">
              建议每日饮水 8 杯 (2000ml)
            </p>
          </div>
        </div>
      </div>

      <!-- 个人中心页面 -->
      <div class="profile-page" id="profilePage">
        <div class="profile-container">
          <div class="profile-header">
            <h2 style="color: #667eea; text-align: center">👤 个人健康档案</h2>
            <p style="text-align: center; color: #666">
              完善您的个人信息，获得更精准的健康建议
            </p>
          </div>

          <div class="profile-form" id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="fullName">姓名 *</label>
                <input
                  type="text"
                  id="fullName"
                  required
                  placeholder="请输入您的姓名"
                />
              </div>
              <div class="form-group">
                <label for="gender">性别 *</label>
                <select id="gender" required>
                  <option value="">请选择</option>
                  <option value="male">男</option>
                  <option value="female">女</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="birthDate">出生日期 *</label>
                <input type="date" id="birthDate" required />
              </div>
              <div class="form-group">
                <label for="phone">联系电话</label>
                <input type="tel" id="phone" placeholder="请输入手机号" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="profileHeight">身高 (cm) *</label>
                <input
                  type="number"
                  id="profileHeight"
                  step="0.1"
                  required
                  min="50"
                  max="250"
                  placeholder="170"
                />
              </div>
              <div class="form-group">
                <label for="profileWeight">体重 (kg) *</label>
                <input
                  type="number"
                  id="profileWeight"
                  step="0.1"
                  required
                  min="20"
                  max="300"
                  placeholder="65"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="targetWeight">目标体重 (kg)</label>
                <input
                  type="number"
                  id="targetWeight"
                  step="0.1"
                  min="20"
                  max="300"
                  placeholder="60"
                />
              </div>
              <div class="form-group">
                <label for="activityLevel">运动频率 *</label>
                <select id="activityLevel" required>
                  <option value="">请选择</option>
                  <option value="sedentary">久坐少动</option>
                  <option value="light">轻度运动 (1-2天/周)</option>
                  <option value="moderate">中度运动 (3-4天/周)</option>
                  <option value="active">高度运动 (5-6天/周)</option>
                  <option value="very-active">专业运动员</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>健康目标 *</label>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 15px;
                  margin-top: 10px;
                "
              >
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-weight-loss"
                    value="weight-loss"
                  />
                  减重瘦身
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-muscle-gain"
                    value="muscle-gain"
                  />
                  增肌塑形
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-healthy-eating"
                    value="healthy-eating"
                  />
                  健康饮食
                </label>
                <label style="display: flex; align-items: center; gap: 5px">
                  <input
                    type="checkbox"
                    id="goal-disease-prevention"
                    value="disease-prevention"
                  />
                  疾病预防
                </label>
              </div>
            </div>

            <button
              type="button"
              onclick="saveProfile()"
              style="display: block; margin: 30px auto"
            >
              保存个人信息
            </button>
          </div>
        </div>
      </div>

      <!-- 饮食计划页面 -->
      <div class="diet-plan-page" id="dietPlanPage">
        <div class="diet-plan-container">
          <div class="diet-plan-header">
            <h2 style="color: #667eea; text-align: center">📋 智能饮食计划</h2>
            <p style="text-align: center; color: #666">
              基于您的身体数据和健康目标，AI为您制定专属饮食方案
            </p>
          </div>

          <!-- 计划生成控制面板 -->
          <div class="plan-generator-panel">
            <div class="generator-header">
              <h3>🎯 计划生成参数</h3>
              <p>请设置您的饮食偏好，系统将为您生成最适合的饮食计划</p>
            </div>

            <div class="generator-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="planDuration">计划周期</label>
                  <select id="planDuration">
                    <option value="day">单日计划</option>
                    <option value="week" selected>一周计划</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="dietType">饮食类型</label>
                  <select id="dietType">
                    <option value="">无特殊要求</option>
                    <option value="vegetarian">素食主义</option>
                    <option value="vegan">纯素食</option>
                    <option value="ketogenic">生酮饮食</option>
                    <option value="paleo">原始饮食</option>
                    <option value="whole30">Whole30</option>
                    <option value="gluten free">无麸质</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="intolerances">食物过敏/不耐受</label>
                  <div class="checkbox-group" id="intolerancesCheckboxes">
                    <label class="checkbox-item">
                      <input type="checkbox" value="dairy" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🥛 乳制品</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="egg" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🥚 鸡蛋</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="gluten" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🌾 麸质</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="grain" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🌾 谷物</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="peanut" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🥜 花生</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="seafood" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🐟 海鲜</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="shellfish" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🐚 贝类</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="soy" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🫘 大豆</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" value="tree nut" />
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-label">🌰 坚果</span>
                    </label>
                  </div>
                  <small
                    style="
                      color: #666;
                      font-size: 0.85em;
                      margin-top: 8px;
                      display: block;
                    "
                  >
                    💡 点击选择您需要避免的食物类型
                  </small>
                </div>
                <div class="form-group">
                  <label for="excludeIngredients">排除食材</label>
                  <textarea
                    id="excludeIngredients"
                    placeholder="请输入要排除的食材，用逗号分隔，如：洋葱,大蒜,辣椒"
                    rows="3"
                  ></textarea>
                </div>
              </div>

              <div class="generate-actions">
                <button onclick="generateDietPlan()" class="generate-plan-btn">
                  🚀 生成智能饮食计划
                </button>
                <button
                  onclick="resetPlanForm()"
                  class="reset-btn"
                  style="background: #6c757d"
                >
                  🔄 重置参数
                </button>
              </div>
            </div>
          </div>

          <!-- 计划展示区域 -->
          <div
            class="plan-display-area"
            id="planDisplayArea"
            style="display: none"
          >
            <div class="plan-overview">
              <h3>📊 计划概览</h3>
              <div class="overview-stats" id="overviewStats">
                <!-- 动态生成营养统计 -->
              </div>
            </div>

            <div class="plan-content" id="planContent">
              <!-- 动态生成饮食计划内容 -->
            </div>

            <div class="plan-actions">
              <button onclick="saveDietPlan()" class="save-plan-btn">
                💾 保存计划
              </button>
              <button
                onclick="exportDietPlan()"
                class="export-btn"
                style="background: #28a745"
              >
                📄 导出PDF
              </button>
              <button
                onclick="applyTodayPlan()"
                class="apply-btn"
                style="background: #17a2b8"
              >
                ✅ 应用到今日
              </button>
            </div>
          </div>

          <!-- 已保存的计划列表 -->
          <div class="saved-plans-section">
            <h3>📚 我的饮食计划</h3>
            <div class="saved-plans-list" id="savedPlansList">
              <div style="text-align: center; padding: 20px; color: #999">
                <p>暂无保存的饮食计划</p>
                <small>生成并保存您的第一个饮食计划吧！</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-page" id="chatPage">
        <div class="chat-page-container">
          <div class="chat-page-header">
            <h2 style="color: #667eea; text-align: center">🤖 AI健康顾问</h2>
            <p style="text-align: center; color: #666">
              您的专属智能健康助手，随时为您答疑解惑
            </p>
          </div>

          <div class="chat-main-container">
            <div class="messages-container" id="chatPageMessagesContainer">
              <!-- 消息将通过JavaScript动态添加 -->
            </div>

            <div class="input-container">
              <textarea
                class="message-input"
                id="chatPageMessageInput"
                placeholder="输入您的健康问题... (Enter发送，Shift+Enter换行)"
                rows="1"
              ></textarea>
              <button
                class="send-button"
                id="chatPageSendButton"
                onclick="sendChatPageMessage()"
                disabled
              >
                ➤
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- 自定义食物对话框（简化版本） -->
    <div class="custom-food-dialog" id="customFoodDialog">
      <div class="custom-food-dialog-content">
        <h3 style="color: #667eea; margin-bottom: 20px">➕ 添加自定义食物</h3>

        <div class="form-group">
          <label for="customFoodName">食物名称 *</label>
          <input
            type="text"
            id="customFoodName"
            placeholder="例如：西红柿炒鸡蛋"
          />
        </div>

        <div class="form-group">
          <label for="customFoodDescription">食物描述 *</label>
          <textarea
            id="customFoodDescription"
            placeholder="请详细描述食物，例如：&#10;鸡蛋 2个&#10;西红柿 200g"
            rows="4"
          ></textarea>
          <small
            style="
              color: #666;
              font-size: 0.85em;
              margin-top: 5px;
              display: block;
            "
          >
            💡 请尽量详细描述食材和重量，这样营养分析会更准确
          </small>
        </div>

        <div
          id="nutritionAnalysisLoading"
          style="display: none; text-align: center; padding: 20px"
        >
          <div class="chat-typing-indicator" style="display: inline-flex">
            <span></span><span></span><span></span>
          </div>
          <p style="margin-top: 15px; color: #666">正在分析营养成分...</p>
          <small style="color: #999">使用Edamam API进行精确计算</small>
        </div>

        <div id="nutritionAnalysisResult" style="display: none">
          <h4 style="color: #667eea; margin: 20px 0 10px 0">🔬 营养分析结果</h4>
          <div
            id="analysisResultContent"
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <!-- 营养分析结果将显示在这里 -->
          </div>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
          "
        >
          <button
            onclick="closeCustomFoodDialog()"
            style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            取消
          </button>
          <button
            id="analyzeNutritionBtn"
            onclick="analyzeCustomFood()"
            style="
              background: #28a745;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            🔬 分析营养
          </button>
          <button
            id="addAnalyzedFoodBtn"
            onclick="addAnalyzedFood()"
            style="
              background: #667eea;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              display: none;
            "
          >
            ✅ 添加食物
          </button>
        </div>
      </div>
    </div>

    <!-- 拍照识别对话框 -->
    <div class="photo-recognition-dialog" id="photoRecognitionDialog">
      <div class="photo-dialog-content">
        <h3 style="color: #667eea; margin-bottom: 20px">📷 拍照识别食物</h3>

        <div style="text-align: center; margin-bottom: 20px">
          <div id="photoPreview" style="display: none; margin-bottom: 15px">
            <img
              id="previewImage"
              style="
                max-width: 100%;
                max-height: 300px;
                border-radius: 10px;
                border: 2px solid #e9ecef;
              "
            />
          </div>

          <input
            type="file"
            id="photoInput"
            accept="image/*"
            capture="environment"
            style="display: none"
            onchange="handlePhotoSelection(event)"
          />

          <button
            onclick="document.getElementById('photoInput').click()"
            style="
              background: var(--primary-gradient);
              color: white;
              border: none;
              padding: 15px 30px;
              border-radius: 25px;
              font-size: 16px;
              cursor: pointer;
              margin: 5px;
            "
          >
            📷 拍照 / 选择图片
          </button>
        </div>

        <div id="recognitionResults" style="display: none">
          <h4 style="color: #667eea; margin-bottom: 15px">识别结果：</h4>
          <div id="recognizedFoodsList"></div>
        </div>

        <div
          id="recognitionLoading"
          style="display: none; text-align: center; padding: 20px"
        >
          <div class="chat-typing-indicator" style="display: inline-flex">
            <span></span><span></span><span></span>
          </div>
          <p style="margin-top: 15px; color: #666">正在识别食物...</p>
          <small style="color: #999">请稍候，AI正在分析您的图片</small>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
          "
        >
          <button
            onclick="closePhotoRecognitionDialog()"
            style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <script>
      // 继续使用之前完整的JavaScript代码
      // 全局变量（添加分析结果存储）
      var recordedFoods = {
        breakfast: [],
        lunch: [],
        dinner: [],
        snack: [],
      };
      var waterGlasses = new Array(8).fill(false);
      var userProfile = {};
      var nutritionPlan = {};
      var chatPageAI = null;
      var currentMealType = ""; // 用于跟踪当前操作的餐食类型
      var currentAnalysisResult = null; // 存储当前营养分析结果

      // API配置
      var EDAMAM_API_ID = "dc898717";
      var EDAMAM_API_KEY = "b477cf9e5553f71d75f64d086ea37188";
      var EDAMAM_BASE_URL = "https://api.edamam.com/api/food-database/v2";

      // Spoonacular API配置（用于生成饮食计划）
      var SPOONACULAR_API_KEY = "e26fdd72dfc249abac89fc085c020a67";
      var SPOONACULAR_BASE_URL = "https://api.spoonacular.com";

      // 2Brain AI API配置
      var AI_API_CONFIG = {
        endpoint: "https://ai.2brain.cn/api/bot/chat/v1/chat/completions",
        token: "2B-WnYnyfZVPKJ39ACEnk8kiGLW5Dya8HRaxDtCL4LjkEmFbhP4Ec",
        headers: {
          "Content-Type": "application/json",
          Authorization:
            "Bearer 2B-WnYnyfZVPKJ39ACEnk8kiGLW5Dya8HRaxDtCL4LjkEmFbhP4Ec",
        },
      };

      // 本地食物数据库（作为备用）
      var localFoodDatabase = [
        {
          id: 1,
          name: "燕麦粥",
          brand: "营养早餐",
          calories: 150,
          protein: 5,
          carbs: 27,
          fat: 3,
          unit: "碗",
        },
        {
          id: 2,
          name: "全麦面包",
          brand: "主食",
          calories: 80,
          protein: 4,
          carbs: 14,
          fat: 1,
          unit: "片",
        },
        {
          id: 3,
          name: "煮鸡蛋",
          brand: "蛋白质",
          calories: 78,
          protein: 6,
          carbs: 0.6,
          fat: 5,
          unit: "个",
        },
        {
          id: 4,
          name: "牛奶",
          brand: "乳制品",
          calories: 83,
          protein: 8,
          carbs: 12,
          fat: 0.2,
          unit: "杯",
        },
        {
          id: 5,
          name: "鸡胸肉",
          brand: "蛋白质",
          calories: 165,
          protein: 31,
          carbs: 0,
          fat: 3.6,
          unit: "100g",
        },
        {
          id: 6,
          name: "米饭",
          brand: "主食",
          calories: 116,
          protein: 2.6,
          carbs: 26,
          fat: 0.3,
          unit: "100g",
        },
        {
          id: 7,
          name: "西兰花",
          brand: "蔬菜",
          calories: 34,
          protein: 2.8,
          carbs: 7,
          fat: 0.4,
          unit: "100g",
        },
        {
          id: 8,
          name: "苹果",
          brand: "水果",
          calories: 52,
          protein: 0.2,
          carbs: 14,
          fat: 0.2,
          unit: "100g",
        },
        {
          id: 9,
          name: "三文鱼",
          brand: "蛋白质",
          calories: 208,
          protein: 20,
          carbs: 0,
          fat: 13,
          unit: "100g",
        },
        {
          id: 10,
          name: "香蕉",
          brand: "水果",
          calories: 89,
          protein: 1.1,
          carbs: 23,
          fat: 0.3,
          unit: "根",
        },
      ];

      // === 核心功能函数 ===

      // 打开自定义食物对话框
      function openCustomFoodDialog(mealType) {
        currentMealType = mealType;
        document.getElementById("customFoodDialog").style.display = "flex";

        // 重置界面
        document.getElementById("customFoodName").value = "";
        document.getElementById("customFoodDescription").value = "";
        document.getElementById("nutritionAnalysisLoading").style.display =
          "none";
        document.getElementById("nutritionAnalysisResult").style.display =
          "none";
        document.getElementById("analyzeNutritionBtn").style.display =
          "inline-block";
        document.getElementById("addAnalyzedFoodBtn").style.display = "none";
        currentAnalysisResult = null;
      }

      // 关闭自定义食物对话框
      function closeCustomFoodDialog() {
        document.getElementById("customFoodDialog").style.display = "none";
        currentMealType = "";
        currentAnalysisResult = null;
      }

      // 分析自定义食物营养
      async function analyzeCustomFood() {
        var foodName = document.getElementById("customFoodName").value.trim();
        var foodDescription = document
          .getElementById("customFoodDescription")
          .value.trim();

        if (!foodName || !foodDescription) {
          showNotification("请填写食物名称和描述", "warning");
          return;
        }

        // 显示加载状态
        document.getElementById("nutritionAnalysisLoading").style.display =
          "block";
        document.getElementById("nutritionAnalysisResult").style.display =
          "none";
        document.getElementById("analyzeNutritionBtn").style.display = "none";

        try {
          // 将描述转换为食材列表
          var ingredients = foodDescription
            .split("\n")
            .filter((line) => line.trim());

          // 使用Edamam API分析营养
          var nutritionData = await calculateNutritionWithEdamam(ingredients);

          if (nutritionData) {
            // 保存分析结果
            currentAnalysisResult = {
              name: foodName,
              nutrition: nutritionData,
              ingredients: ingredients,
            };

            // 显示分析结果
            displayNutritionAnalysisResult(nutritionData);

            // 更新按钮状态
            document.getElementById("nutritionAnalysisLoading").style.display =
              "none";
            document.getElementById("nutritionAnalysisResult").style.display =
              "block";
            document.getElementById("analyzeNutritionBtn").style.display =
              "none";
            document.getElementById("addAnalyzedFoodBtn").style.display =
              "inline-block";
          } else {
            throw new Error("营养分析失败");
          }
        } catch (error) {
          console.error("营养分析错误:", error);
          document.getElementById("nutritionAnalysisLoading").style.display =
            "none";
          document.getElementById("analyzeNutritionBtn").style.display =
            "inline-block";
          showNotification("营养分析失败，请检查食材描述格式", "error");
        }
      }

      // 显示营养分析结果
      function displayNutritionAnalysisResult(nutritionData) {
        var resultContent = document.getElementById("analysisResultContent");
        resultContent.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>🔥 总热量</span>
                        <strong>${nutritionData.calories} kcal</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>🥩 蛋白质</span>
                        <strong>${nutritionData.protein}g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>🌾 碳水化合物</span>
                        <strong>${nutritionData.carbs}g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>🥑 脂肪</span>
                        <strong>${nutritionData.fat}g</strong>
                    </div>
                    ${
                      nutritionData.fiber
                        ? `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span>🌾 纤维</span>
                        <strong>${nutritionData.fiber}g</strong>
                    </div>`
                        : ""
                    }
                </div>
            `;
      }

      // 添加分析后的食物
      function addAnalyzedFood() {
        if (!currentAnalysisResult || !currentMealType) {
          showNotification("请先完成营养分析", "warning");
          return;
        }

        var food = {
          id: "custom_" + Date.now(),
          name: currentAnalysisResult.name,
          calories: currentAnalysisResult.nutrition.calories,
          protein: currentAnalysisResult.nutrition.protein,
          carbs: currentAnalysisResult.nutrition.carbs,
          fat: currentAnalysisResult.nutrition.fat,
          fiber: currentAnalysisResult.nutrition.fiber || 0,
          unit: "份",
          isCustom: true,
          isEdamamAnalyzed: true,
        };

        addFoodRecord(food, currentMealType, 1);
        closeCustomFoodDialog();
        showNotification("✅ 自定义食物已添加", "success");
      }

      // 添加识别后的食物
      function addRecognizedFood(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));
          var quantity = prompt(
            "请输入数量（" + (food.unit || "份") + "）:",
            "1"
          );

          if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
            addFoodRecord(food, currentMealType, parseFloat(quantity));
            showNotification("✅ 已添加 " + food.name, "success");

            // 如果还有其他识别结果，保持对话框打开
            var remainingItems = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            if (remainingItems.length <= 1) {
              closePhotoRecognitionDialog();
            }
          }
        } catch (error) {
          console.error("添加识别食物失败:", error);
          showNotification("添加失败，请重试", "error");
        }
      }

      // 使用Edamam API搜索食物
      async function searchFoodWithEdamam(query) {
        try {
          var url = `${EDAMAM_BASE_URL}/parser?app_id=${EDAMAM_API_ID}&app_key=${EDAMAM_API_KEY}&ingr=${encodeURIComponent(
            query
          )}&nutrition-type=cooking`;
          var response = await fetch(url);

          if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
          }

          var data = await response.json();

          if (!data.hints || data.hints.length === 0) {
            console.log("Edamam API未找到结果，使用本地数据库");
            return searchLocalFood(query);
          }

          return data.hints.slice(0, 5).map((hint) => {
            var food = hint.food;
            var nutrients = food.nutrients || {};

            return {
              id: "edamam_" + food.foodId,
              name: food.label,
              brand: food.brand || "Edamam Database",
              calories: Math.round(nutrients.ENERC_KCAL || 0),
              protein: Math.round((nutrients.PROCNT || 0) * 10) / 10,
              carbs: Math.round((nutrients.CHOCDF || 0) * 10) / 10,
              fat: Math.round((nutrients.FAT || 0) * 10) / 10,
              fiber: Math.round((nutrients.FIBTG || 0) * 10) / 10,
              sugar: Math.round((nutrients.SUGAR || 0) * 10) / 10,
              sodium: Math.round((nutrients.NA || 0) * 10) / 10,
              unit: "100g",
              image: food.image,
              foodId: food.foodId,
              measureURI:
                hint.measures && hint.measures[0] ? hint.measures[0].uri : null,
            };
          });
        } catch (error) {
          console.error("Edamam API调用失败，使用本地数据库:", error);
          return searchLocalFood(query);
        }
      }

      // 使用Edamam Nutrition Analysis API计算精确营养数据
      async function calculateNutritionWithEdamam(ingredients) {
        try {
          var url = `https://api.edamam.com/api/nutrition-details?app_id=${EDAMAM_API_ID}&app_key=${EDAMAM_API_KEY}`;

          var requestBody = {
            title: "User Meal Analysis",
            ingr: ingredients,
          };

          var response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(`营养分析API请求失败: ${response.status}`);
          }

          var data = await response.json();

          return {
            calories: Math.round(data.calories || 0),
            protein:
              Math.round((data.totalNutrients.PROCNT?.quantity || 0) * 10) / 10,
            carbs:
              Math.round((data.totalNutrients.CHOCDF?.quantity || 0) * 10) / 10,
            fat: Math.round((data.totalNutrients.FAT?.quantity || 0) * 10) / 10,
            fiber:
              Math.round((data.totalNutrients.FIBTG?.quantity || 0) * 10) / 10,
            sugar:
              Math.round((data.totalNutrients.SUGAR?.quantity || 0) * 10) / 10,
            sodium:
              Math.round((data.totalNutrients.NA?.quantity || 0) * 10) / 10,
            potassium:
              Math.round((data.totalNutrients.K?.quantity || 0) * 10) / 10,
            vitaminC:
              Math.round((data.totalNutrients.VITC?.quantity || 0) * 10) / 10,
            calcium:
              Math.round((data.totalNutrients.CA?.quantity || 0) * 10) / 10,
            iron: Math.round((data.totalNutrients.FE?.quantity || 0) * 10) / 10,
            weight: Math.round((data.totalWeight || 0) * 10) / 10,
          };
        } catch (error) {
          console.error("Edamam营养分析失败:", error);
          return null;
        }
      }

      // 获取营养素数值
      function getNutrientValue(nutrients, name) {
        var nutrient = nutrients.find((n) => n.name === name);
        return nutrient ? nutrient.amount : 0;
      }

      // 搜索本地食物数据库
      function searchLocalFood(query) {
        var searchTerm = query.toLowerCase().trim();
        return localFoodDatabase.filter(
          (food) =>
            food.name.toLowerCase().includes(searchTerm) ||
            food.brand.toLowerCase().includes(searchTerm)
        );
      }

      // 页面切换函数
      function showMainPage() {
        document.getElementById("mainContent").style.display = "grid";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("mainBtn").classList.add("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");
        displayPersonalPlan();
      }

      function showProfilePage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "block";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("profileBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");
        loadProfile();
      }

      function showChatPage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "block";
        document.getElementById("dietPlanPage").style.display = "none";
        document.getElementById("chatBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("dietPlanBtn").classList.remove("active");

        if (!chatPageAI) {
          initializeChatPageAI();
        }
      }

      function showDietPlanPage() {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("profilePage").style.display = "none";
        document.getElementById("chatPage").style.display = "none";
        document.getElementById("dietPlanPage").style.display = "block";
        document.getElementById("dietPlanBtn").classList.add("active");
        document.getElementById("mainBtn").classList.remove("active");
        document.getElementById("profileBtn").classList.remove("active");
        document.getElementById("chatBtn").classList.remove("active");

        loadSavedPlans();
      }

      // 保存个人信息
      function saveProfile() {
        var fullName = document.getElementById("fullName").value.trim();
        var gender = document.getElementById("gender").value;
        var birthDate = document.getElementById("birthDate").value;
        var height = document.getElementById("profileHeight").value;
        var weight = document.getElementById("profileWeight").value;
        var activityLevel = document.getElementById("activityLevel").value;

        if (
          !fullName ||
          !gender ||
          !birthDate ||
          !height ||
          !weight ||
          !activityLevel
        ) {
          showNotification("请填写所有必填字段！", "warning");
          return;
        }

        var checkedGoals = document.querySelectorAll(
          'input[type="checkbox"]:checked'
        );
        if (checkedGoals.length === 0) {
          showNotification("请选择至少一个健康目标！", "warning");
          return;
        }

        userProfile = {
          fullName: fullName,
          gender: gender,
          birthDate: birthDate,
          height: parseFloat(height),
          weight: parseFloat(weight),
          targetWeight:
            parseFloat(document.getElementById("targetWeight").value) || null,
          activityLevel: activityLevel,
          goals: Array.from(checkedGoals).map((cb) => cb.value),
        };

        generateNutritionPlan();
        saveUserData();
        showNotification("✅ 个人信息已保存！", "success");

        setTimeout(() => {
          showMainPage();
        }, 1500);
      }

      // 生成营养计划
      function generateNutritionPlan() {
        if (!userProfile.height || !userProfile.weight) {
          console.log("缺少身体数据，使用默认营养目标");
          nutritionPlan = {
            bmi: 0,
            bmr: 0,
            targets: {
              calories: 2000,
              protein: 50,
              carbs: 250,
              fat: 65,
            },
          };
          updateNutritionTracking();
          return;
        }

        var bmi = userProfile.weight / Math.pow(userProfile.height / 100, 2);
        var age = getAge();
        var bmr;

        if (userProfile.gender === "male") {
          bmr =
            88.362 +
            13.397 * userProfile.weight +
            4.799 * userProfile.height -
            5.677 * age;
        } else {
          bmr =
            447.593 +
            9.247 * userProfile.weight +
            3.098 * userProfile.height -
            4.33 * age;
        }

        var activityMultipliers = {
          sedentary: 1.2,
          light: 1.375,
          moderate: 1.55,
          active: 1.725,
          "very-active": 1.9,
        };

        var multiplier = activityMultipliers[userProfile.activityLevel] || 1.2;
        var dailyCalories = Math.round(bmr * multiplier);

        if (userProfile.goals && userProfile.goals.includes("weight-loss")) {
          dailyCalories = Math.round(dailyCalories * 0.85);
        } else if (
          userProfile.goals &&
          userProfile.goals.includes("muscle-gain")
        ) {
          dailyCalories = Math.round(dailyCalories * 1.1);
        }

        nutritionPlan = {
          bmi: bmi,
          bmr: bmr,
          targets: {
            calories: dailyCalories,
            protein: Math.round((dailyCalories * 0.25) / 4),
            carbs: Math.round((dailyCalories * 0.45) / 4),
            fat: Math.round((dailyCalories * 0.3) / 9),
          },
        };

        updateNutritionTracking();
      }

      // 计算年龄
      function getAge() {
        if (!userProfile.birthDate) return 30;
        var birth = new Date(userProfile.birthDate);
        var today = new Date();
        var age = today.getFullYear() - birth.getFullYear();
        if (
          today.getMonth() < birth.getMonth() ||
          (today.getMonth() === birth.getMonth() &&
            today.getDate() < birth.getDate())
        ) {
          age--;
        }
        return age;
      }

      // 显示个人计划
      function displayPersonalPlan() {
        var container = document.getElementById("personalPlanDisplay");

        if (!userProfile.fullName || !nutritionPlan.targets) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; background: #f0f0f0; border-radius: 15px;">' +
            '<p style="color: #666;">尚未设置个人健康计划</p>' +
            '<button onclick="showProfilePage()" style="margin-top: 15px;">立即设置</button>' +
            "</div>";
          document.getElementById("bmiCalculator").style.display = "none";
          return;
        }

        container.innerHTML =
          '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">' +
          "<h3>👋 " +
          userProfile.fullName +
          " 的专属计划</h3>" +
          '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px;">' +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.calories +
          "</div>" +
          '<div style="font-size: 0.9em;">每日热量</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.protein +
          "g</div>" +
          '<div style="font-size: 0.9em;">蛋白质</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.carbs +
          "g</div>" +
          '<div style="font-size: 0.9em;">碳水</div>' +
          "</div>" +
          '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">' +
          '<div style="font-size: 1.5em; font-weight: bold;">' +
          nutritionPlan.targets.fat +
          "g</div>" +
          '<div style="font-size: 0.9em;">脂肪</div>' +
          "</div>" +
          "</div>" +
          "</div>";

        document.getElementById("bmiCalculator").style.display = "block";
        document.getElementById("bmiValue").textContent =
          nutritionPlan.bmi.toFixed(1);
        document.getElementById("bmiStatus").textContent = getBMIStatus(
          nutritionPlan.bmi
        );
      }

      // 获取BMI状态
      function getBMIStatus(bmi) {
        if (bmi < 18.5) return "偏瘦";
        if (bmi < 24) return "正常";
        if (bmi < 28) return "偏胖";
        return "肥胖";
      }

      // 切换餐食区域
      function toggleMealSection(mealType) {
        var section = document.getElementById(mealType + "Section");
        if (section) {
          section.classList.toggle("expanded");
        }
      }

      // 搜索处理（更新为异步）
      async function handleSearchKeyUp(event, mealType) {
        if (event.key === "Enter") {
          await searchMealFood(mealType);
        }
      }

      // 搜索食物（更新为使用Edamam API）
      async function searchMealFood(mealType) {
        var searchInput = document.getElementById(mealType + "SearchInput");
        var searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          showNotification("请输入要搜索的食物名称", "warning");
          return;
        }

        // 显示加载状态
        var resultsContainer = document.getElementById(
          mealType + "SearchResults"
        );
        resultsContainer.innerHTML =
          '<div style="text-align: center; padding: 20px;"><div class="chat-typing-indicator"><span></span><span></span><span></span></div><p style="margin-top: 10px;">正在搜索食物...</p></div>';

        try {
          var results = await searchFoodWithEdamam(searchTerm);
          displayMealSearchResults(
            results.filter((r) => r !== null),
            mealType
          );
        } catch (error) {
          console.error("搜索食物失败:", error);
          resultsContainer.innerHTML =
            '<p style="text-align: center; color: #ff4757;">搜索失败，请重试</p>';
        }
      }

      // 显示搜索结果（增强版本，支持更多营养信息）
      function displayMealSearchResults(results, mealType) {
        var resultsContainer = document.getElementById(
          mealType + "SearchResults"
        );
        resultsContainer.innerHTML = "";

        if (results.length === 0) {
          resultsContainer.innerHTML =
            '<p style="text-align: center; color: #999;">未找到相关食物</p>';
          return;
        }

        results.forEach((food) => {
          var resultItem = document.createElement("div");
          resultItem.className = "food-result-item";

          var imageHtml = "";
          if (food.image) {
            imageHtml = `<img src="${food.image}" 
                                style="width: 40px; height: 40px; border-radius: 8px; margin-right: 10px;" 
                                alt="${food.name}">`;
          }

          resultItem.innerHTML =
            '<div style="display: flex; align-items: center;">' +
            imageHtml +
            "<div>" +
            '<div style="font-weight: bold;">' +
            food.name +
            "</div>" +
            '<div style="font-size: 0.9em; color: #666;">' +
            food.brand +
            "</div>" +
            '<div style="margin-top: 5px;">' +
            '<span class="nutrition-badge">🔥 ' +
            food.calories +
            " kcal</span>" +
            '<span class="nutrition-badge">🥩 ' +
            food.protein +
            "g</span>" +
            '<span class="nutrition-badge">🌾 ' +
            food.carbs +
            "g</span>" +
            '<span class="nutrition-badge">🥑 ' +
            food.fat +
            "g</span>" +
            (food.fiber
              ? '<span class="nutrition-badge">🌾 ' +
                food.fiber +
                "g 纤维</span>"
              : "") +
            "</div>" +
            "</div>" +
            "</div>" +
            '<button class="add-food-btn" onclick="addMealFoodFromSearch(\'' +
            encodeURIComponent(JSON.stringify(food)) +
            "', '" +
            mealType +
            "')\">添加</button>";
          resultsContainer.appendChild(resultItem);
        });
      }

      // 添加食物（从搜索结果）- 更新为异步函数
      async function addMealFoodFromSearch(encodedFood, mealType) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));
          var quantity = prompt("请输入数量（" + food.unit + "）:", "1");
          if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
            await addFoodRecord(food, mealType, parseFloat(quantity));
          }
        } catch (error) {
          console.error("添加食物失败:", error);
          showNotification("添加食物失败", "error");
        }
      }

      // 添加食物（兼容旧版本）
      function addMealFood(foodId, mealType) {
        var food = localFoodDatabase.find((f) => f.id === foodId);
        if (!food) return;

        var quantity = prompt("请输入数量（" + food.unit + "）:", "1");
        if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
          addFoodRecord(food, mealType, parseFloat(quantity));
        }
      }

      // 添加食物记录（增强版本，支持Edamam精确营养计算）
      async function addFoodRecord(food, mealType, quantity) {
        try {
          // 如果是Edamam食物，使用精确的营养分析
          var nutritionData;
          if (food.id && food.id.startsWith("edamam_") && food.foodId) {
            var ingredient = `${quantity * 100}g ${food.name}`;
            nutritionData = await calculateNutritionWithEdamam([ingredient]);
          }

          // 使用精确营养数据或原始数据
          var recordedFood = {
            id: food.id,
            name: food.name,
            calories: nutritionData
              ? nutritionData.calories
              : Math.round(food.calories * quantity),
            protein: nutritionData
              ? nutritionData.protein
              : Math.round(food.protein * quantity * 10) / 10,
            carbs: nutritionData
              ? nutritionData.carbs
              : Math.round(food.carbs * quantity * 10) / 10,
            fat: nutritionData
              ? nutritionData.fat
              : Math.round(food.fat * quantity * 10) / 10,
            fiber: nutritionData
              ? nutritionData.fiber
              : food.fiber
              ? Math.round(food.fiber * quantity * 10) / 10
              : 0,
            sugar: nutritionData
              ? nutritionData.sugar
              : food.sugar
              ? Math.round(food.sugar * quantity * 10) / 10
              : 0,
            sodium: nutritionData
              ? nutritionData.sodium
              : food.sodium
              ? Math.round(food.sodium * quantity * 10) / 10
              : 0,
            recordId: Date.now(),
            quantity: quantity,
            unit: food.unit,
            isEdamamAnalyzed: !!nutritionData,
          };

          recordedFoods[mealType].push(recordedFood);
          updateMealRecorded(mealType);
          updateNutritionTracking();
          saveUserData();

          document.getElementById(mealType + "SearchInput").value = "";
          document.getElementById(mealType + "SearchResults").innerHTML = "";

          var message = nutritionData
            ? "✅ 已添加 " + food.name + " (使用Edamam精确分析)"
            : "✅ 已添加 " + food.name;
          showNotification(message, "success");
        } catch (error) {
          console.error("添加食物失败:", error);
          // 如果精确分析失败，使用基础数据
          var recordedFood = {
            id: food.id,
            name: food.name,
            calories: Math.round(food.calories * quantity),
            protein: Math.round(food.protein * quantity * 10) / 10,
            carbs: Math.round(food.carbs * quantity * 10) / 10,
            fat: Math.round(food.fat * quantity * 10) / 10,
            recordId: Date.now(),
            quantity: quantity,
            unit: food.unit,
          };

          recordedFoods[mealType].push(recordedFood);
          updateMealRecorded(mealType);
          updateNutritionTracking();
          saveUserData();

          showNotification("✅ 已添加 " + food.name, "success");
        }
      }

      // 更新已记录食物（增强版本，显示更多营养信息）
      function updateMealRecorded(mealType) {
        var container = document.getElementById(mealType + "RecordedList");
        if (!container) return;

        container.innerHTML = "";
        var mealFoods = recordedFoods[mealType];

        if (mealFoods.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">暂无记录</p>';
          return;
        }

        mealFoods.forEach((food) => {
          var item = document.createElement("div");
          item.style =
            "background: white; padding: 10px; margin: 5px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;";

          var nutritionInfo =
            food.calories + " kcal | 蛋白质 " + food.protein + "g";
          if (food.fiber && food.fiber > 0) {
            nutritionInfo += " | 纤维 " + food.fiber + "g";
          }
          if (food.isEdamamAnalyzed) {
            nutritionInfo += " 🔬";
          }

          item.innerHTML =
            "<div>" +
            "<strong>" +
            food.name +
            "</strong>" +
            (food.quantity > 1 ? " x" + food.quantity : "") +
            '<div style="font-size: 0.9em; color: #666;">' +
            nutritionInfo +
            "</div>" +
            "</div>" +
            '<button onclick="deleteMealFood(' +
            food.recordId +
            ", '" +
            mealType +
            "')\" " +
            'style="background: #ff4757; color: white; border: none; padding: 5px 10px; ' +
            'border-radius: 5px; cursor: pointer;">删除</button>';
          container.appendChild(item);
        });
      }

      // 删除食物
      function deleteMealFood(recordId, mealType) {
        recordedFoods[mealType] = recordedFoods[mealType].filter(
          (food) => food.recordId !== recordId
        );
        updateMealRecorded(mealType);
        updateNutritionTracking();
        saveUserData();
        showNotification("已删除", "success");
      }

      // 获取当前营养摄入（增强版本，支持更多营养素）
      function getCurrentNutrition() {
        var totals = {
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sugar: 0,
          sodium: 0,
        };

        Object.keys(recordedFoods).forEach((mealType) => {
          recordedFoods[mealType].forEach((food) => {
            totals.calories += food.calories || 0;
            totals.protein += food.protein || 0;
            totals.carbs += food.carbs || 0;
            totals.fat += food.fat || 0;
            totals.fiber += food.fiber || 0;
            totals.sugar += food.sugar || 0;
            totals.sodium += food.sodium || 0;
          });
        });

        return totals;
      }

      // 更新营养追踪（增强版本，显示更多营养信息）
      function updateNutritionTracking() {
        var totals = getCurrentNutrition();
        var targets = nutritionPlan.targets || {
          calories: 2000,
          protein: 50,
          carbs: 250,
          fat: 65,
        };

        // 更新基础营养素显示
        document.getElementById("calorieValue").textContent = Math.round(
          totals.calories
        );
        document.getElementById("proteinValue").textContent =
          totals.protein.toFixed(1) + "g";
        document.getElementById("carbValue").textContent =
          totals.carbs.toFixed(1) + "g";
        document.getElementById("fatValue").textContent =
          totals.fat.toFixed(1) + "g";

        document.getElementById("calorieTarget").textContent =
          "目标: " + targets.calories;
        document.getElementById("proteinTarget").textContent =
          "目标: " + targets.protein + "g";
        document.getElementById("carbTarget").textContent =
          "目标: " + targets.carbs + "g";
        document.getElementById("fatTarget").textContent =
          "目标: " + targets.fat + "g";

        // 更新进度条
        document.getElementById("calorieProgress").style.width =
          Math.min(100, (totals.calories / targets.calories) * 100) + "%";
        document.getElementById("proteinProgress").style.width =
          Math.min(100, (totals.protein / targets.protein) * 100) + "%";
        document.getElementById("carbProgress").style.width =
          Math.min(100, (totals.carbs / targets.carbs) * 100) + "%";
        document.getElementById("fatProgress").style.width =
          Math.min(100, (totals.fat / targets.fat) * 100) + "%";

        // 如果有额外的营养信息显示区域，更新它们
        updateAdditionalNutritionInfo(totals);
      }

      // 更新额外营养信息
      function updateAdditionalNutritionInfo(totals) {
        // 检查是否存在额外营养信息显示区域
        var extraNutritionContainer = document.getElementById("extraNutrition");
        if (!extraNutritionContainer) {
          // 如果没有，创建一个
          var nutritionGrid = document.getElementById("nutritionGrid");
          if (nutritionGrid && (totals.fiber > 0 || totals.sodium > 0)) {
            if (totals.fiber > 0) {
              var fiberStat = document.createElement("div");
              fiberStat.className = "nutrition-stat";
              fiberStat.innerHTML =
                "<h4>🌾 膳食纤维</h4>" +
                '<div class="nutrition-value">' +
                totals.fiber.toFixed(1) +
                "g</div>" +
                '<div class="nutrition-target">推荐: 25-35g</div>' +
                '<div class="progress-bar">' +
                '<div class="progress-fill" style="width: ' +
                Math.min(100, (totals.fiber / 25) * 100) +
                '%"></div>' +
                "</div>";
              nutritionGrid.appendChild(fiberStat);
            }

            if (totals.sodium > 0) {
              var sodiumStat = document.createElement("div");
              sodiumStat.className = "nutrition-stat";
              var sodiumMg = totals.sodium * 1000; // 转换为毫克
              sodiumStat.innerHTML =
                "<h4>🧂 钠</h4>" +
                '<div class="nutrition-value">' +
                Math.round(sodiumMg) +
                "mg</div>" +
                '<div class="nutrition-target">限制: <2300mg</div>' +
                '<div class="progress-bar">' +
                '<div class="progress-fill" style="width: ' +
                Math.min(100, (sodiumMg / 2300) * 100) +
                "%; background: " +
                (sodiumMg > 2300 ? "#ff4757" : "white") +
                '"></div>' +
                "</div>";
              nutritionGrid.appendChild(sodiumStat);
            }
          }
        }
      }

      // 饮水追踪
      function toggleWater(index) {
        waterGlasses[index] = !waterGlasses[index];
        updateWaterDisplay();
        saveUserData();
      }

      // 更新饮水显示
      function updateWaterDisplay() {
        var glasses = document.querySelectorAll(".water-glass");
        var filledCount = 0;

        glasses.forEach((glass, index) => {
          if (waterGlasses[index]) {
            glass.classList.add("filled");
            filledCount++;
          } else {
            glass.classList.remove("filled");
          }
        });

        document.getElementById("waterCount").innerHTML =
          '已饮用: <span style="font-weight: bold; color: #2196F3;">' +
          filledCount +
          "</span> 杯 " +
          '(<span style="font-weight: bold; color: #2196F3;">' +
          filledCount * 250 +
          "</span> ml)";
      }

      // 加载个人信息
      function loadProfile() {
        if (userProfile.fullName) {
          document.getElementById("fullName").value =
            userProfile.fullName || "";
          document.getElementById("gender").value = userProfile.gender || "";
          document.getElementById("birthDate").value =
            userProfile.birthDate || "";
          document.getElementById("profileHeight").value =
            userProfile.height || "";
          document.getElementById("profileWeight").value =
            userProfile.weight || "";
          document.getElementById("targetWeight").value =
            userProfile.targetWeight || "";
          document.getElementById("activityLevel").value =
            userProfile.activityLevel || "";
          document.getElementById("phone").value = userProfile.phone || "";

          // 加载健康目标
          if (userProfile.goals) {
            userProfile.goals.forEach((goal) => {
              var checkbox = document.getElementById("goal-" + goal);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
        }
      }

      // 计算营养目标
      function calculateNutritionTargets() {
        // 如果已有营养计划，直接使用
        if (nutritionPlan.targets) {
          return nutritionPlan.targets;
        }

        // 如果没有个人信息，使用默认值
        if (!userProfile.height || !userProfile.weight) {
          return {
            calories: 2000,
            protein: 50,
            carbs: 250,
            fat: 65,
          };
        }

        // 重新生成营养计划
        generateNutritionPlan();
        return (
          nutritionPlan.targets || {
            calories: 2000,
            protein: 50,
            carbs: 250,
            fat: 65,
          }
        );
      }

      // 饮食计划生成功能 - 使用Spoonacular API
      var currentDietPlan = null;
      var savedDietPlans = [];

      // 生成饮食计划（优化配额不足处理）
      async function generateDietPlan() {
        if (!userProfile.height || !userProfile.weight) {
          showNotification("请先完善个人信息！", "warning");
          showProfilePage();
          return;
        }

        var generateBtn = document.querySelector(".generate-plan-btn");
        var originalText = generateBtn.innerHTML;

        try {
          // 显示加载状态
          generateBtn.disabled = true;
          generateBtn.innerHTML =
            '<span class="loading-spinner"></span> 正在生成饮食计划...';

          // 获取表单参数
          var planParams = {
            duration: document.getElementById("planDuration").value,
            diet: document.getElementById("dietType").value,
            intolerances: getSelectedIntolerances(),
            exclude: document.getElementById("excludeIngredients").value.trim(),
          };

          // 计算营养目标
          var nutritionTargets = calculateNutritionTargets();

          console.log(
            "开始生成饮食计划，参数:",
            planParams,
            "营养目标:",
            nutritionTargets
          );

          var dietPlan = null;
          var useSpoonacular = false; // 由于配额不足，默认使用本地方案

          // 显示友好的提示信息
          showNotification(
            "💡 Spoonacular API配额已用完，为您启用高级本地智能方案",
            "info"
          );

          // 直接使用增强的本地方案
          try {
            generateBtn.innerHTML =
              '<span class="loading-spinner"></span> 使用AI智能本地方案生成...';
            console.log("使用增强AI本地方案...");

            dietPlan = await generateEnhancedLocalPlan(
              planParams,
              nutritionTargets
            );
            console.log("AI本地方案生成成功！");
          } catch (localError) {
            console.error("AI本地方案失败:", localError);

            // 最后的保险方案
            generateBtn.innerHTML =
              '<span class="loading-spinner"></span> 使用基础营养方案...';
            dietPlan = generateBasicFallbackPlan(planParams, nutritionTargets);
            console.log("基础方案生成完成");
          }

          if (dietPlan && dietPlan.days && dietPlan.days.length > 0) {
            currentDietPlan = dietPlan;
            displayDietPlan(dietPlan);

            // 根据生成方式显示不同的成功消息
            var successMessage = "";
            if (dietPlan.isEnhancedLocal) {
              successMessage =
                "✅ 智能饮食计划生成成功！使用AI本地方案 + Edamam精确营养分析";
            } else if (dietPlan.days.some((day) => day.isEdamamAnalyzed)) {
              successMessage =
                "✅ 饮食计划生成成功！使用本地方案 + Edamam精确营养分析";
            } else {
              successMessage = "✅ 饮食计划生成成功！使用基础营养估算";
            }

            showNotification(successMessage, "success");
          } else {
            throw new Error("生成的饮食计划无效");
          }
        } catch (error) {
          console.error("生成饮食计划完全失败:", error);
          showNotification("❌ 生成饮食计划失败: " + error.message, "error");
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = originalText;
        }
      }

      // 调用Spoonacular饮食计划API
      async function callSpoonacularMealPlan(params, targets) {
        try {
          var timeFrame = params.duration === "week" ? "week" : "day";
          var targetCalories = targets.calories;

          console.log("调用Spoonacular API，参数:", {
            timeFrame,
            targetCalories,
            params,
          });

          var url = `${SPOONACULAR_BASE_URL}/mealplanner/generate`;
          var queryParams = new URLSearchParams({
            apiKey: SPOONACULAR_API_KEY,
            timeFrame: timeFrame,
            targetCalories: targetCalories,
          });

          if (params.diet) queryParams.append("diet", params.diet);
          if (params.intolerances)
            queryParams.append("intolerances", params.intolerances);
          if (params.exclude) queryParams.append("exclude", params.exclude);

          var finalUrl = `${url}?${queryParams.toString()}`;
          console.log("API请求URL:", finalUrl);

          var response = await fetch(finalUrl);

          if (!response.ok) {
            console.error(
              "Spoonacular API请求失败:",
              response.status,
              response.statusText
            );
            throw new Error(`Spoonacular API错误: ${response.status}`);
          }

          var data = await response.json();
          console.log("Spoonacular API响应:", data);

          // 处理API响应数据
          var processedPlan = await processMealPlanData(data, params, targets);
          return processedPlan;
        } catch (error) {
          console.error("Spoonacular API调用失败:", error);
          showNotification("API调用失败，使用本地数据生成计划", "warning");
          // 生成本地模拟数据作为fallback
          return generateFallbackPlan(params, targets);
        }
      }

      // 处理Spoonacular返回的饮食计划数据，使用Edamam进行营养计算
      async function processMealPlanDataWithEdamam(data, params, targets) {
        var plan = {
          id: "plan_" + Date.now(),
          name: `${
            params.duration === "week" ? "7天" : "1天"
          }智能饮食计划 (Spoonacular)`,
          createdAt: new Date().toISOString(),
          duration: params.duration,
          totalCalories: 0,
          totalProtein: 0,
          totalCarbs: 0,
          totalFat: 0,
          days: [],
        };

        console.log("处理Spoonacular数据，使用Edamam计算营养:", data);

        try {
          if (params.duration === "week" && data.week) {
            // 处理周计划
            var dayKeys = Object.keys(data.week);
            console.log("周计划包含天数:", dayKeys);

            for (var i = 0; i < dayKeys.length; i++) {
              var dayKey = dayKeys[i];
              var dayData = data.week[dayKey];
              console.log(`处理${dayKey}的数据:`, dayData);

              var dayName =
                ["周一", "周二", "周三", "周四", "周五", "周六", "周日"][i] ||
                dayKey;
              var dayPlan = await processDayPlanWithEdamam(dayData, dayName);
              plan.days.push(dayPlan);

              plan.totalCalories += dayPlan.calories || 0;
              plan.totalProtein += dayPlan.protein || 0;
              plan.totalCarbs += dayPlan.carbs || 0;
              plan.totalFat += dayPlan.fat || 0;
            }
          } else if (data.meals && Array.isArray(data.meals)) {
            // 处理单日计划
            console.log("处理单日计划:", data.meals);
            var dayPlan = await processDayPlanWithEdamam(data, "今日");
            plan.days.push(dayPlan);

            plan.totalCalories = dayPlan.calories || 0;
            plan.totalProtein = dayPlan.protein || 0;
            plan.totalCarbs = dayPlan.carbs || 0;
            plan.totalFat = dayPlan.fat || 0;
          } else {
            console.warn("Spoonacular响应格式异常:", data);
            throw new Error("Spoonacular返回的数据格式不正确");
          }

          console.log("Spoonacular计划处理完成:", plan);
          return plan;
        } catch (error) {
          console.error("处理Spoonacular数据失败:", error);
          throw error;
        }
      }

      // 处理单日计划数据，使用Edamam计算营养（增强版本）
      async function processDayPlanWithEdamam(dayData, dayName) {
        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: {
            breakfast: [],
            lunch: [],
            dinner: [],
          },
        };

        console.log(`开始处理${dayName}的餐食:`, dayData);

        var dayIngredients = [];
        var mealDetails = [];

        try {
          if (dayData.meals && Array.isArray(dayData.meals)) {
            // 获取每个餐食的详细信息
            for (var i = 0; i < Math.min(dayData.meals.length, 3); i++) {
              // 限制最多3餐
              var meal = dayData.meals[i];
              var mealType = getMealType(meal.id, i);

              console.log(`获取餐食 ${meal.id} 的详细信息...`);

              try {
                var mealInfo = await getSpoonacularMealDetails(meal.id);

                if (mealInfo && mealInfo.title) {
                  console.log(`餐食信息获取成功:`, mealInfo);
                  dayPlan.meals[mealType].push(mealInfo);
                  mealDetails.push(mealInfo);

                  // 添加到Edamam分析的配料列表
                  dayIngredients.push(`1 serving ${mealInfo.title}`);
                } else {
                  throw new Error("餐食信息不完整");
                }
              } catch (mealError) {
                console.warn(
                  `餐食 ${meal.id} 获取失败:`,
                  mealError,
                  "使用备用数据"
                );
                var fallbackMeal = generateFallbackMealItem(meal, mealType, i);
                dayPlan.meals[mealType].push(fallbackMeal);
                mealDetails.push(fallbackMeal);
                dayIngredients.push(`1 serving ${fallbackMeal.title}`);
              }

              // 添加延迟避免API限制
              await new Promise((resolve) => setTimeout(resolve, 200));
            }
          }

          // 使用Edamam API计算整日营养
          if (dayIngredients.length > 0) {
            console.log(`使用Edamam分析${dayName}的营养:`, dayIngredients);

            try {
              var edamamNutrition = await calculateNutritionWithEdamam(
                dayIngredients
              );

              if (edamamNutrition && edamamNutrition.calories > 0) {
                console.log(`Edamam营养分析成功:`, edamamNutrition);
                dayPlan.calories = edamamNutrition.calories;
                dayPlan.protein = edamamNutrition.protein;
                dayPlan.carbs = edamamNutrition.carbs;
                dayPlan.fat = edamamNutrition.fat;
                dayPlan.fiber = edamamNutrition.fiber || 0;
                dayPlan.sodium = edamamNutrition.sodium || 0;
                dayPlan.isEdamamAnalyzed = true;
              } else {
                throw new Error("Edamam返回的营养数据无效");
              }
            } catch (edamamError) {
              console.warn("Edamam营养分析失败:", edamamError, "使用估算值");
              // 如果Edamam分析失败，使用估算营养数据
              var estimatedNutrition = calculateEstimatedNutrition(mealDetails);
              dayPlan.calories = estimatedNutrition.calories;
              dayPlan.protein = estimatedNutrition.protein;
              dayPlan.carbs = estimatedNutrition.carbs;
              dayPlan.fat = estimatedNutrition.fat;
              dayPlan.isEdamamAnalyzed = false;
            }
          } else {
            console.warn(`${dayName}没有有效的餐食数据`);
            // 使用默认营养值
            dayPlan.calories = 500;
            dayPlan.protein = 25;
            dayPlan.carbs = 60;
            dayPlan.fat = 15;
          }

          console.log(`${dayName}最终营养数据:`, {
            calories: dayPlan.calories,
            protein: dayPlan.protein,
            carbs: dayPlan.carbs,
            fat: dayPlan.fat,
            isEdamamAnalyzed: dayPlan.isEdamamAnalyzed,
          });

          return dayPlan;
        } catch (error) {
          console.error(`处理${dayName}失败:`, error);
          // 返回基础计划
          dayPlan.calories = 500;
          dayPlan.protein = 25;
          dayPlan.carbs = 60;
          dayPlan.fat = 15;
          return dayPlan;
        }
      }

      // 获取Spoonacular餐食详细信息（增强版本）
      async function getSpoonacularMealDetails(mealId) {
        try {
          var url = `${SPOONACULAR_BASE_URL}/recipes/${mealId}/information?includeNutrition=false&apiKey=${SPOONACULAR_API_KEY}`;
          console.log(`请求Spoonacular餐食详情: ${url}`);

          var response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          var data = await response.json();
          console.log(`Spoonacular餐食 ${mealId} 数据:`, data);

          if (!data.title) {
            throw new Error("餐食标题缺失");
          }

          return {
            id: data.id,
            title: data.title,
            image: data.image || null,
            readyInMinutes: data.readyInMinutes || 30,
            servings: data.servings || 1,
            sourceUrl: data.sourceUrl || null,
            // 营养数据将由Edamam统一计算
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0,
          };
        } catch (error) {
          console.error(`获取餐食 ${mealId} 信息失败:`, error);
          throw error;
        }
      }

      // 计算估算营养数据（当Edamam失败时使用）
      function calculateEstimatedNutrition(mealDetails) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0 };

        mealDetails.forEach((meal) => {
          // 如果有具体营养数据就使用，否则使用估算值
          if (meal.calories > 0) {
            total.calories += meal.calories;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
          } else {
            // 基于餐食类型的估算值
            total.calories += 350; // 平均每餐350卡路里
            total.protein += 20; // 平均每餐20g蛋白质
            total.carbs += 30; // 平均每餐30g碳水
            total.fat += 12; // 平均每餐12g脂肪
          }
        });

        return total;
      }

      // 获取营养素数值 - 兼容Spoonacular格式
      function getNutrientValue(nutrients, name) {
        if (!nutrients || !Array.isArray(nutrients)) return 0;

        // 尝试多种可能的营养素名称
        var possibleNames = {
          Calories: ["Calories", "Energy", "Kcal"],
          Protein: ["Protein"],
          Carbohydrates: ["Carbohydrates", "Total Carbohydrate", "Carbs"],
          Fat: ["Fat", "Total Fat", "Total Lipid"],
        };

        var names = possibleNames[name] || [name];

        for (var i = 0; i < names.length; i++) {
          var nutrientName = names[i];
          var nutrient = nutrients.find(function (n) {
            return (
              n.name === nutrientName ||
              n.title === nutrientName ||
              (n.name &&
                n.name.toLowerCase().includes(nutrientName.toLowerCase()))
            );
          });
          if (nutrient && nutrient.amount) {
            return nutrient.amount;
          }
        }

        return 0;
      }

      // 生成备用餐食项目
      function generateFallbackMealItem(meal, mealType, index) {
        var fallbackNutrition = {
          breakfast: { calories: 300, protein: 12, carbs: 40, fat: 8 },
          lunch: { calories: 450, protein: 25, carbs: 35, fat: 18 },
          dinner: { calories: 400, protein: 22, carbs: 30, fat: 15 },
        };

        var nutrition = fallbackNutrition[mealType] || fallbackNutrition.lunch;

        return {
          id: meal.id || "fallback_" + index,
          title: meal.title || `${mealType} 餐食`,
          image: meal.image || null,
          readyInMinutes: 30,
          servings: 1,
          calories: nutrition.calories,
          protein: nutrition.protein,
          carbs: nutrition.carbs,
          fat: nutrition.fat,
          sourceUrl: meal.sourceUrl || null,
        };
      }

      // 获取餐食详细信息
      async function getMealDetails(mealId) {
        try {
          var url = `${SPOONACULAR_BASE_URL}/recipes/${mealId}/information?includeNutrition=true&apiKey=${SPOONACULAR_API_KEY}`;
          var response = await fetch(url);

          if (!response.ok) {
            console.warn(`获取餐食 ${mealId} 信息失败: ${response.status}`);
            return null;
          }

          var data = await response.json();

          // 获取营养信息
          var nutrition = data.nutrition?.nutrients || [];
          var calories = getNutrientValue(nutrition, "Calories");
          var protein = getNutrientValue(nutrition, "Protein");
          var carbs = getNutrientValue(nutrition, "Carbohydrates");
          var fat = getNutrientValue(nutrition, "Fat");

          console.log(`餐食 ${data.title} 营养信息:`, {
            calories,
            protein,
            carbs,
            fat,
          });

          return {
            id: data.id,
            title: data.title,
            image: data.image,
            readyInMinutes: data.readyInMinutes,
            servings: data.servings,
            calories: Math.round(calories || 0),
            protein: Math.round((protein || 0) * 10) / 10,
            carbs: Math.round((carbs || 0) * 10) / 10,
            fat: Math.round((fat || 0) * 10) / 10,
            sourceUrl: data.sourceUrl,
          };
        } catch (error) {
          console.error("获取餐食信息失败:", error);
          return null;
        }
      }

      // 使用Spoonacular API生成饮食计划（修复版本）
      async function callSpoonacularMealPlan(params, targets) {
        try {
          var timeFrame = params.duration === "week" ? "week" : "day";
          var targetCalories = Math.round(targets.calories);

          console.log("调用Spoonacular API生成饮食计划，参数:", {
            timeFrame,
            targetCalories,
            params,
          });

          // 构建基础请求参数
          var queryParams = new URLSearchParams({
            apiKey: SPOONACULAR_API_KEY,
            timeFrame: timeFrame,
            targetCalories: targetCalories,
          });

          // 添加可选参数（只有当值存在且不为空时才添加）
          if (params.diet && params.diet.trim()) {
            queryParams.append("diet", params.diet.trim());
          }
          if (params.intolerances && params.intolerances.trim()) {
            queryParams.append("intolerances", params.intolerances.trim());
          }
          if (params.exclude && params.exclude.trim()) {
            queryParams.append("exclude", params.exclude.trim());
          }

          var finalUrl = `${SPOONACULAR_BASE_URL}/mealplanner/generate?${queryParams.toString()}`;
          console.log("Spoonacular API完整请求URL:", finalUrl);

          // 添加请求头和超时控制
          var controller = new AbortController();
          var timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒超时

          var response = await fetch(finalUrl, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "User-Agent": "HealthDietAssistant/1.0",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          console.log(
            "Spoonacular API响应状态:",
            response.status,
            response.statusText
          );

          if (!response.ok) {
            var errorText = "";
            try {
              errorText = await response.text();
              console.error("Spoonacular API错误响应内容:", errorText);
            } catch (e) {
              console.error("无法读取错误响应:", e);
            }

            // 根据错误状态码提供详细信息
            var errorMessage = "";
            switch (response.status) {
              case 401:
                errorMessage = "API密钥无效或已过期";
                break;
              case 402:
                errorMessage = "API配额不足";
                break;
              case 403:
                errorMessage = "API访问被拒绝";
                break;
              case 404:
                errorMessage = "API端点不存在";
                break;
              case 429:
                errorMessage = "API请求频率限制";
                break;
              case 500:
                errorMessage = "Spoonacular服务器内部错误";
                break;
              default:
                errorMessage = `HTTP错误 ${response.status}: ${response.statusText}`;
            }

            throw new Error(`Spoonacular API错误: ${errorMessage}`);
          }

          var data = await response.json();
          console.log("Spoonacular API响应成功，数据结构:", Object.keys(data));
          console.log("Spoonacular API完整响应:", data);

          // 验证响应数据格式
          if (
            !data ||
            (timeFrame === "week" &&
              !data.week &&
              timeFrame === "day" &&
              !data.meals)
          ) {
            console.error("Spoonacular API返回数据格式异常:", data);
            throw new Error("API返回的数据格式不正确");
          }

          // 处理API响应数据，并使用Edamam进行营养计算
          var processedPlan = await processMealPlanDataWithEdamam(
            data,
            params,
            targets
          );
          processedPlan.isSpoonacularGenerated = true; // 标记为Spoonacular生成
          return processedPlan;
        } catch (error) {
          if (error.name === "AbortError") {
            console.error("Spoonacular API请求超时");
            throw new Error("API请求超时，请稍后重试");
          }
          console.error("Spoonacular API调用失败，详细错误:", error);
          throw error;
        }
      }

      // 根据餐食ID和索引判断餐食类型
      function getMealType(mealId, index) {
        // 根据索引分配餐食类型
        if (index === 0) return "breakfast";
        if (index === 1) return "lunch";
        if (index === 2) return "dinner";

        // 如果超过3个餐食，循环分配
        var types = ["breakfast", "lunch", "dinner"];
        return types[index % 3];
      }

      // 增强的本地饮食计划生成器
      async function generateEnhancedLocalPlan(params, targets) {
        try {
          console.log("使用增强AI本地方案生成饮食计划");

          var plan = {
            id: "enhanced_" + Date.now(),
            name: `${params.duration === "week" ? "7天" : "1天"}AI智能饮食计划`,
            createdAt: new Date().toISOString(),
            duration: params.duration,
            totalCalories: 0,
            totalProtein: 0,
            totalCarbs: 0,
            totalFat: 0,
            days: [],
            isSpoonacularGenerated: false,
            isEnhancedLocal: true,
          };

          var daysCount = params.duration === "week" ? 7 : 1;
          var dailyCalories = Math.round(targets.calories);

          for (var i = 0; i < daysCount; i++) {
            var dayName =
              params.duration === "week"
                ? ["周一", "周二", "周三", "周四", "周五", "周六", "周日"][i]
                : "今日";

            console.log(`生成第${i + 1}天AI计划: ${dayName}`);
            var dayPlan = await generateEnhancedDayPlan(
              dayName,
              dailyCalories,
              targets,
              params,
              i
            );
            plan.days.push(dayPlan);

            plan.totalCalories += dayPlan.calories;
            plan.totalProtein += dayPlan.protein;
            plan.totalCarbs += dayPlan.carbs;
            plan.totalFat += dayPlan.fat;
          }

          console.log("增强AI本地计划生成完成:", plan);
          return plan;
        } catch (error) {
          console.error("增强本地计划生成失败:", error);
          throw error;
        }
      }

      // 生成增强单日计划
      async function generateEnhancedDayPlan(
        dayName,
        targetCalories,
        targets,
        params,
        dayIndex
      ) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        // 生成多样化的餐食（根据日期变化）
        var meals = {
          breakfast: generateDiversifiedMeals(
            "breakfast",
            breakfastCal,
            params,
            dayIndex
          ),
          lunch: generateDiversifiedMeals("lunch", lunchCal, params, dayIndex),
          dinner: generateDiversifiedMeals(
            "dinner",
            dinnerCal,
            params,
            dayIndex
          ),
        };

        // 收集所有食材用于Edamam分析
        var dayIngredients = [];
        Object.keys(meals).forEach((mealType) => {
          meals[mealType].forEach((meal) => {
            // 为Edamam构建更精确的食材描述
            var ingredient = `${meal.portion || "1 serving"} ${meal.title}`;
            if (meal.ingredients && meal.ingredients.length > 0) {
              ingredient = meal.ingredients.join(", ");
            }
            dayIngredients.push(ingredient);
          });
        });

        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: meals,
          isEnhancedLocal: true,
        };

        // 使用Edamam分析营养
        if (dayIngredients.length > 0) {
          console.log(`使用Edamam分析${dayName}的AI营养:`, dayIngredients);
          var edamamNutrition = await calculateNutritionWithEdamam(
            dayIngredients
          );

          if (edamamNutrition && edamamNutrition.calories > 0) {
            console.log(`Edamam AI营养分析结果:`, edamamNutrition);
            dayPlan.calories = edamamNutrition.calories;
            dayPlan.protein = edamamNutrition.protein;
            dayPlan.carbs = edamamNutrition.carbs;
            dayPlan.fat = edamamNutrition.fat;
            dayPlan.fiber = edamamNutrition.fiber;
            dayPlan.sodium = edamamNutrition.sodium;
            dayPlan.isEdamamAnalyzed = true;
          } else {
            // 如果Edamam分析失败，使用高质量估算值
            console.log("Edamam分析失败，使用AI估算营养数据");
            var aiNutrition = calculateAINutrition(meals, targetCalories);
            dayPlan.calories = aiNutrition.calories;
            dayPlan.protein = aiNutrition.protein;
            dayPlan.carbs = aiNutrition.carbs;
            dayPlan.fat = aiNutrition.fat;
            dayPlan.fiber = aiNutrition.fiber;
          }
        }

        return dayPlan;
      }

      // 生成多样化餐食（AI智能推荐）
      function generateDiversifiedMeals(
        mealType,
        targetCalories,
        params,
        dayIndex
      ) {
        var isVegetarian =
          params.diet === "vegetarian" || params.diet === "vegan";
        var isVegan = params.diet === "vegan";
        var isKeto = params.diet === "ketogenic";
        var isPaleo = params.diet === "paleo";
        var intolerances = (params.intolerances || "").toLowerCase();

        // 扩展的高质量餐食库
        var enhancedMealTemplates = {
          breakfast: [
            // 传统健康早餐
            {
              name: "蓝莓燕麦粥配核桃",
              calories: 320,
              protein: 12,
              carbs: 55,
              fat: 8,
              fiber: 8,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup oatmeal",
                "1/2 cup blueberries",
                "1 oz walnuts",
                "1 tbsp honey",
              ],
              portion: "1 bowl",
            },
            {
              name: "牛油果吐司配煎蛋",
              calories: 380,
              protein: 18,
              carbs: 32,
              fat: 22,
              fiber: 12,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "2 slices whole grain bread",
                "1 medium avocado",
                "2 eggs",
                "salt and pepper",
              ],
              portion: "1 serving",
            },
            {
              name: "希腊酸奶浆果杯",
              calories: 280,
              protein: 20,
              carbs: 35,
              fat: 8,
              fiber: 6,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup greek yogurt",
                "1/2 cup mixed berries",
                "1 tbsp honey",
                "1 tbsp chia seeds",
              ],
              portion: "1 cup",
            },
            // 生酮早餐
            {
              name: "奶油炒蛋配培根",
              calories: 420,
              protein: 25,
              carbs: 3,
              fat: 35,
              fiber: 0,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "3 eggs",
                "2 slices bacon",
                "1 tbsp butter",
                "herbs",
              ],
              portion: "1 serving",
            },
            {
              name: "椰子粉松饼",
              calories: 300,
              protein: 8,
              carbs: 6,
              fat: 28,
              fiber: 4,
              vegetarian: true,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: ["2 coconut flour muffins", "1 tbsp almond butter"],
              portion: "2 muffins",
            },
            // 素食早餐
            {
              name: "奇亚籽布丁",
              calories: 290,
              protein: 10,
              carbs: 28,
              fat: 16,
              fiber: 12,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "3 tbsp chia seeds",
                "1 cup almond milk",
                "1 tbsp maple syrup",
                "1/4 cup berries",
              ],
              portion: "1 cup",
            },
          ],
          lunch: [
            // 健康主餐
            {
              name: "柠檬香草烤鸡沙拉",
              calories: 450,
              protein: 35,
              carbs: 25,
              fat: 24,
              fiber: 8,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "4 oz grilled chicken breast",
                "2 cups mixed greens",
                "1/4 avocado",
                "olive oil dressing",
              ],
              portion: "1 large salad",
            },
            {
              name: "三文鱼藜麦碗",
              calories: 520,
              protein: 38,
              carbs: 45,
              fat: 22,
              fiber: 6,
              vegetarian: false,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "5 oz salmon fillet",
                "3/4 cup cooked quinoa",
                "1 cup roasted vegetables",
              ],
              portion: "1 bowl",
            },
            {
              name: "地中海鹰嘴豆沙拉",
              calories: 380,
              protein: 15,
              carbs: 50,
              fat: 16,
              fiber: 12,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 cup chickpeas",
                "1 cup cucumber",
                "1/2 cup tomatoes",
                "2 tbsp olive oil",
                "feta cheese",
              ],
              portion: "1 large portion",
            },
            // 生酮午餐
            {
              name: "椰菜花饭配牛肉",
              calories: 480,
              protein: 32,
              carbs: 12,
              fat: 36,
              fiber: 5,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "5 oz ground beef",
                "1.5 cups cauliflower rice",
                "2 tbsp coconut oil",
              ],
              portion: "1 serving",
            },
            // 素食午餐
            {
              name: "黑豆红薯汉堡",
              calories: 420,
              protein: 18,
              carbs: 65,
              fat: 12,
              fiber: 15,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "1 black bean sweet potato burger",
                "1 whole grain bun",
                "lettuce and tomato",
              ],
              portion: "1 burger",
            },
          ],
          dinner: [
            // 精致晚餐
            {
              name: "香草烤鱼配蒸蔬菜",
              calories: 420,
              protein: 40,
              carbs: 20,
              fat: 20,
              fiber: 6,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "6 oz white fish fillet",
                "1.5 cups steamed broccoli",
                "1 tbsp olive oil",
                "herbs",
              ],
              portion: "1 serving",
            },
            {
              name: "蘑菇意面",
              calories: 480,
              protein: 18,
              carbs: 70,
              fat: 16,
              fiber: 8,
              vegetarian: true,
              vegan: false,
              keto: false,
              paleo: false,
              ingredients: [
                "1.5 cups whole wheat pasta",
                "1 cup mixed mushrooms",
                "2 tbsp parmesan",
                "olive oil",
              ],
              portion: "1 large serving",
            },
            {
              name: "泰式咖喱豆腐",
              calories: 390,
              protein: 20,
              carbs: 35,
              fat: 22,
              fiber: 5,
              vegetarian: true,
              vegan: true,
              keto: false,
              paleo: false,
              ingredients: [
                "5 oz firm tofu",
                "1/2 cup coconut milk",
                "1 cup vegetables",
                "curry spices",
              ],
              portion: "1 serving",
            },
            // 生酮晚餐
            {
              name: "黄油蒜香牛排",
              calories: 550,
              protein: 45,
              carbs: 5,
              fat: 38,
              fiber: 2,
              vegetarian: false,
              vegan: false,
              keto: true,
              paleo: true,
              ingredients: [
                "6 oz beef steak",
                "2 tbsp butter",
                "garlic",
                "1 cup asparagus",
              ],
              portion: "1 steak",
            },
          ],
        };

        var templates = enhancedMealTemplates[mealType] || [];

        // 智能过滤（根据饮食限制）
        var filteredTemplates = templates.filter((meal) => {
          if (isVegan && !meal.vegan) return false;
          if (isVegetarian && !meal.vegetarian) return false;
          if (isKeto && !meal.keto) return false;
          if (isPaleo && !meal.paleo) return false;

          // 过敏原检查
          if (
            intolerances.includes("dairy") &&
            meal.ingredients.some(
              (ing) =>
                ing.includes("cheese") ||
                ing.includes("milk") ||
                ing.includes("yogurt")
            )
          )
            return false;
          if (
            intolerances.includes("egg") &&
            meal.ingredients.some((ing) => ing.includes("egg"))
          )
            return false;
          if (
            intolerances.includes("gluten") &&
            meal.ingredients.some(
              (ing) => ing.includes("bread") || ing.includes("pasta")
            )
          )
            return false;

          return true;
        });

        if (filteredTemplates.length === 0) {
          filteredTemplates = templates; // 保底方案
        }

        // 智能选择（避免重复，增加多样性）
        var baseIndex = dayIndex % filteredTemplates.length;
        var selectedMeal = { ...filteredTemplates[baseIndex] };

        selectedMeal.id = "enhanced_" + Date.now() + "_" + baseIndex;
        selectedMeal.title = selectedMeal.name;
        selectedMeal.image = null; // 本地方案暂无图片
        selectedMeal.readyInMinutes =
          mealType === "breakfast" ? 15 : mealType === "lunch" ? 25 : 35;

        return [selectedMeal];
      }

      // AI营养计算（当Edamam失败时的高质量估算）
      function calculateAINutrition(meals, targetCalories) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
        var mealCount = 0;

        Object.values(meals).forEach((mealList) => {
          mealList.forEach((meal) => {
            total.calories += meal.calories || 0;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
            total.fiber += meal.fiber || 0;
            mealCount++;
          });
        });

        // 如果总热量偏差太大，按比例调整
        if (Math.abs(total.calories - targetCalories) > 200) {
          var factor = targetCalories / total.calories;
          total.calories = Math.round(total.calories * factor);
          total.protein = Math.round(total.protein * factor);
          total.carbs = Math.round(total.carbs * factor);
          total.fat = Math.round(total.fat * factor);
          total.fiber = Math.round(total.fiber * factor);
        }

        return total;
      }

      // 生成单日fallback计划（使用Edamam分析）
      async function generateFallbackDayPlanWithEdamam(
        dayName,
        targetCalories,
        targets,
        params
      ) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        // 生成适合的餐食
        var meals = {
          breakfast: generateSmartFallbackMeals(
            "breakfast",
            breakfastCal,
            params
          ),
          lunch: generateSmartFallbackMeals("lunch", lunchCal, params),
          dinner: generateSmartFallbackMeals("dinner", dinnerCal, params),
        };

        // 收集所有食材用于Edamam分析
        var dayIngredients = [];
        Object.keys(meals).forEach((mealType) => {
          meals[mealType].forEach((meal) => {
            dayIngredients.push(`1 serving ${meal.title}`);
          });
        });

        var dayPlan = {
          name: dayName,
          calories: 0,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          sodium: 0,
          meals: meals,
        };

        // 使用Edamam分析营养
        if (dayIngredients.length > 0) {
          console.log(`使用Edamam分析${dayName}的营养:`, dayIngredients);
          var edamamNutrition = await calculateNutritionWithEdamam(
            dayIngredients
          );

          if (edamamNutrition) {
            console.log(`Edamam营养分析结果:`, edamamNutrition);
            dayPlan.calories = edamamNutrition.calories;
            dayPlan.protein = edamamNutrition.protein;
            dayPlan.carbs = edamamNutrition.carbs;
            dayPlan.fat = edamamNutrition.fat;
            dayPlan.fiber = edamamNutrition.fiber;
            dayPlan.sodium = edamamNutrition.sodium;
            dayPlan.isEdamamAnalyzed = true;
          } else {
            // 如果Edamam分析失败，使用估算值
            var totalNutrition = calculateTotalNutrition(meals);
            dayPlan.calories = totalNutrition.calories;
            dayPlan.protein = totalNutrition.protein;
            dayPlan.carbs = totalNutrition.carbs;
            dayPlan.fat = totalNutrition.fat;
          }
        }

        return dayPlan;
      }

      // 基础保险方案（当所有API都失败时）
      function generateBasicFallbackPlan(params, targets) {
        console.log("使用基础保险方案生成饮食计划");

        var plan = {
          id: "basic_" + Date.now(),
          name: `${params.duration === "week" ? "7天" : "1天"}基础健康饮食计划`,
          createdAt: new Date().toISOString(),
          duration: params.duration,
          totalCalories: 0,
          totalProtein: 0,
          totalCarbs: 0,
          totalFat: 0,
          days: [],
          isSpoonacularGenerated: false,
          isBasicPlan: true,
        };

        var daysCount = params.duration === "week" ? 7 : 1;
        var dailyCalories = Math.round(targets.calories);

        for (var i = 0; i < daysCount; i++) {
          var dayName =
            params.duration === "week"
              ? ["周一", "周二", "周三", "周四", "周五", "周六", "周日"][i]
              : "今日";

          var dayPlan = generateBasicDayPlan(
            dayName,
            dailyCalories,
            targets,
            params
          );
          plan.days.push(dayPlan);

          plan.totalCalories += dayPlan.calories;
          plan.totalProtein += dayPlan.protein;
          plan.totalCarbs += dayPlan.carbs;
          plan.totalFat += dayPlan.fat;
        }

        return plan;
      }

      // 生成基础单日计划
      function generateBasicDayPlan(dayName, targetCalories, targets, params) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        var meals = {
          breakfast: generateBasicMeals("breakfast", breakfastCal, params),
          lunch: generateBasicMeals("lunch", lunchCal, params),
          dinner: generateBasicMeals("dinner", dinnerCal, params),
        };

        var totalNutrition = calculateTotalNutrition(meals);

        return {
          name: dayName,
          calories: totalNutrition.calories,
          protein: totalNutrition.protein,
          carbs: totalNutrition.carbs,
          fat: totalNutrition.fat,
          meals: meals,
          isEdamamAnalyzed: false,
          isBasicPlan: true,
        };
      }

      // API密钥验证函数
      async function testSpoonacularAPI() {
        try {
          console.log("测试Spoonacular API连接...");
          var testUrl = `${SPOONACULAR_BASE_URL}/recipes/random?number=1&apiKey=${SPOONACULAR_API_KEY}`;

          var response = await fetch(testUrl);
          console.log("API测试响应状态:", response.status);

          if (response.ok) {
            var data = await response.json();
            console.log("API测试成功，返回数据:", data);
            return true;
          } else {
            var errorText = await response.text();
            console.error("API测试失败:", response.status, errorText);
            return false;
          }
        } catch (error) {
          console.error("API测试异常:", error);
          return false;
        }
      }

      // 智能生成fallback餐食（考虑饮食限制）
      function generateSmartFallbackMeals(mealType, targetCalories, params) {
        var isVegetarian =
          params.diet === "vegetarian" || params.diet === "vegan";
        var isKeto = params.diet === "ketogenic";
        var intolerances = (params.intolerances || "").toLowerCase();

        var mealTemplates = {
          breakfast: [
            {
              name: "燕麦粥配蓝莓",
              calories: 280,
              protein: 8,
              carbs: 45,
              fat: 6,
              vegetarian: true,
              keto: false,
            },
            {
              name: "全麦吐司配牛油果",
              calories: 320,
              protein: 15,
              carbs: 35,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "鸡蛋卷配菠菜",
              calories: 250,
              protein: 18,
              carbs: 8,
              fat: 16,
              vegetarian: true,
              keto: true,
            },
            {
              name: "希腊酸奶配坚果",
              calories: 300,
              protein: 20,
              carbs: 15,
              fat: 18,
              vegetarian: true,
              keto: false,
            },
          ],
          lunch: [
            {
              name: "鸡胸肉沙拉",
              calories: 350,
              protein: 30,
              carbs: 20,
              fat: 15,
              vegetarian: false,
              keto: true,
            },
            {
              name: "三文鱼配糙米",
              calories: 420,
              protein: 35,
              carbs: 40,
              fat: 18,
              vegetarian: false,
              keto: false,
            },
            {
              name: "豆腐蔬菜汤",
              calories: 280,
              protein: 18,
              carbs: 25,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "藜麦蔬菜沙拉",
              calories: 380,
              protein: 15,
              carbs: 45,
              fat: 16,
              vegetarian: true,
              keto: false,
            },
          ],
          dinner: [
            {
              name: "烤鸡腿配蔬菜",
              calories: 400,
              protein: 32,
              carbs: 25,
              fat: 20,
              vegetarian: false,
              keto: true,
            },
            {
              name: "蒸鱼配青菜",
              calories: 320,
              protein: 28,
              carbs: 15,
              fat: 15,
              vegetarian: false,
              keto: true,
            },
            {
              name: "素食意面",
              calories: 380,
              protein: 15,
              carbs: 55,
              fat: 12,
              vegetarian: true,
              keto: false,
            },
            {
              name: "豆类炖菜",
              calories: 350,
              protein: 20,
              carbs: 40,
              fat: 10,
              vegetarian: true,
              keto: false,
            },
          ],
        };

        var templates = mealTemplates[mealType] || [];

        // 根据饮食限制过滤
        var filteredTemplates = templates.filter((meal) => {
          if (isVegetarian && !meal.vegetarian) return false;
          if (isKeto && !meal.keto) return false;
          if (intolerances.includes("dairy") && meal.name.includes("酸奶"))
            return false;
          if (intolerances.includes("egg") && meal.name.includes("鸡蛋"))
            return false;
          return true;
        });

        if (filteredTemplates.length === 0) {
          filteredTemplates = templates; // 如果没有符合条件的，使用所有模板
        }

        // 随机选择1-2个餐食
        var selectedMeals = [];
        var remainingCalories = targetCalories;

        while (
          selectedMeals.length < 2 &&
          remainingCalories > 100 &&
          filteredTemplates.length > 0
        ) {
          var randomIndex = Math.floor(
            Math.random() * filteredTemplates.length
          );
          var meal = { ...filteredTemplates[randomIndex] };

          if (meal.calories <= remainingCalories + 50) {
            // 允许一定误差
            meal.id = "fallback_" + Date.now() + "_" + randomIndex;
            meal.title = meal.name;
            selectedMeals.push(meal);
            remainingCalories -= meal.calories;
            filteredTemplates.splice(randomIndex, 1); // 避免重复
          }

          if (filteredTemplates.length === 0) break;
        }

        return selectedMeals;
      }

      // 生成fallback单日计划
      function generateFallbackDayPlan(dayName, targetCalories, targets) {
        var breakfastCal = Math.round(targetCalories * 0.25);
        var lunchCal = Math.round(targetCalories * 0.4);
        var dinnerCal = Math.round(targetCalories * 0.35);

        var meals = {
          breakfast: generateFallbackMeals("breakfast", breakfastCal),
          lunch: generateFallbackMeals("lunch", lunchCal),
          dinner: generateFallbackMeals("dinner", dinnerCal),
        };

        var totalNutrition = calculateTotalNutrition(meals);

        return {
          name: dayName,
          calories: totalNutrition.calories,
          protein: totalNutrition.protein,
          carbs: totalNutrition.carbs,
          fat: totalNutrition.fat,
          meals: meals,
        };
      }

      // 生成fallback餐食
      function generateFallbackMeals(mealType, targetCalories) {
        var mealTemplates = {
          breakfast: [
            {
              name: "燕麦粥配蓝莓",
              calories: 280,
              protein: 8,
              carbs: 45,
              fat: 6,
              image: null,
            },
            {
              name: "全麦吐司配牛油果",
              calories: 320,
              protein: 15,
              carbs: 35,
              fat: 12,
              image: null,
            },
          ],
          lunch: [
            {
              name: "鸡胸肉沙拉",
              calories: 350,
              protein: 30,
              carbs: 20,
              fat: 15,
              image: null,
            },
            {
              name: "三文鱼配糙米",
              calories: 420,
              protein: 35,
              carbs: 40,
              fat: 18,
              image: null,
            },
          ],
          dinner: [
            {
              name: "烤鸡腿配蔬菜",
              calories: 400,
              protein: 32,
              carbs: 25,
              fat: 20,
              image: null,
            },
            {
              name: "蒸鱼配青菜",
              calories: 320,
              protein: 28,
              carbs: 15,
              fat: 15,
              image: null,
            },
          ],
        };

        var templates = mealTemplates[mealType] || [];
        // 随机选择1-2个餐食
        var selectedMeals = [];
        var remainingCalories = targetCalories;

        while (
          selectedMeals.length < 2 &&
          remainingCalories > 100 &&
          templates.length > 0
        ) {
          var randomIndex = Math.floor(Math.random() * templates.length);
          var meal = { ...templates[randomIndex] };

          if (meal.calories <= remainingCalories + 50) {
            // 允许一定误差
            meal.id = "fallback_" + Date.now() + "_" + randomIndex;
            meal.title = meal.name;
            selectedMeals.push(meal);
            remainingCalories -= meal.calories;
            templates.splice(randomIndex, 1); // 避免重复
          }

          if (templates.length === 0) break;
        }

        return selectedMeals;
      }

      // 计算总营养
      function calculateTotalNutrition(meals) {
        var total = { calories: 0, protein: 0, carbs: 0, fat: 0 };

        Object.values(meals).forEach((mealList) => {
          mealList.forEach((meal) => {
            total.calories += meal.calories || 0;
            total.protein += meal.protein || 0;
            total.carbs += meal.carbs || 0;
            total.fat += meal.fat || 0;
          });
        });

        return total;
      }

      // 显示饮食计划（增强版本，显示Edamam分析结果）
      function displayDietPlan(plan) {
        document.getElementById("planDisplayArea").style.display = "block";

        // 显示概览统计
        var overviewStats = document.getElementById("overviewStats");
        var avgCalories =
          plan.days.length > 0
            ? Math.round(plan.totalCalories / plan.days.length)
            : 0;
        var avgProtein =
          plan.days.length > 0
            ? Math.round(plan.totalProtein / plan.days.length)
            : 0;
        var avgCarbs =
          plan.days.length > 0
            ? Math.round(plan.totalCarbs / plan.days.length)
            : 0;
        var avgFat =
          plan.days.length > 0
            ? Math.round(plan.totalFat / plan.days.length)
            : 0;

        // 检查是否使用了Edamam分析
        var hasEdamamAnalysis = plan.days.some((day) => day.isEdamamAnalyzed);
        var analysisLabel = hasEdamamAnalysis ? " 🔬 Edamam精确分析" : "";

        overviewStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avgCalories}</div>
                    <div class="stat-label">日均热量 (kcal)${analysisLabel}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgProtein}g</div>
                    <div class="stat-label">日均蛋白质</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgCarbs}g</div>
                    <div class="stat-label">日均碳水</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgFat}g</div>
                    <div class="stat-label">日均脂肪</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${plan.days.length}</div>
                    <div class="stat-label">计划天数</div>
                </div>
            `;

        // 显示每日计划
        var planContent = document.getElementById("planContent");
        planContent.innerHTML = plan.days
          .map((day) => {
            var analysisIcon = day.isEdamamAnalyzed ? " 🔬" : "";
            var fiberInfo =
              day.fiber && day.fiber > 0
                ? ` | 纤维 ${day.fiber.toFixed(1)}g`
                : "";
            var sodiumInfo =
              day.sodium && day.sodium > 0
                ? ` | 钠 ${Math.round(day.sodium * 1000)}mg`
                : "";

            return `
                    <div class="day-plan">
                        <div class="day-header">
                            📅 ${day.name} - ${Math.round(
              day.calories
            )} kcal${analysisIcon}
                            ${
                              fiberInfo || sodiumInfo
                                ? `<br><small style="opacity: 0.8;">${fiberInfo}${sodiumInfo}</small>`
                                : ""
                            }
                        </div>
                        <div class="day-meals">
                            ${generateMealSectionHTML(
                              "🌅 早餐",
                              day.meals.breakfast
                            )}
                            ${generateMealSectionHTML(
                              "☀️ 午餐",
                              day.meals.lunch
                            )}
                            ${generateMealSectionHTML(
                              "🌙 晚餐",
                              day.meals.dinner
                            )}
                        </div>
                    </div>
                `;
          })
          .join("");

        // 滚动到显示区域
        document.getElementById("planDisplayArea").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
      }

      // 生成餐食区域HTML（增强版本，区分营养数据来源）
      function generateMealSectionHTML(title, meals) {
        if (!meals || meals.length === 0) {
          return `
                    <div class="meal-section">
                        <div class="meal-title">${title}</div>
                        <div class="meal-items">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                暂无推荐食物
                            </div>
                        </div>
                    </div>
                `;
        }

        return `
                <div class="meal-section">
                    <div class="meal-title">${title}</div>
                    <div class="meal-items">
                        ${meals
                          .map((meal) => {
                            // 如果营养数据为0，说明将由Edamam统一计算
                            var nutritionDisplay = "";
                            if (meal.calories > 0 || meal.protein > 0) {
                              nutritionDisplay = `
                                    ${Math.round(meal.calories || 0)} kcal | 
                                    蛋白质 ${(meal.protein || 0).toFixed(1)}g | 
                                    碳水 ${(meal.carbs || 0).toFixed(1)}g | 
                                    脂肪 ${(meal.fat || 0).toFixed(1)}g
                                `;
                            } else {
                              nutritionDisplay = "营养数据由Edamam精确计算 🔬";
                            }

                            var timeInfo = meal.readyInMinutes
                              ? ` | ${meal.readyInMinutes}分钟`
                              : "";

                            return `
                                <div class="meal-item">
                                    <div class="item-info">
                                        <div class="item-name">${
                                          meal.title || meal.name
                                        }</div>
                                        <div class="item-nutrition">
                                            ${nutritionDisplay}${timeInfo}
                                        </div>
                                    </div>
                                    ${
                                      meal.image
                                        ? `<img src="${meal.image}" alt="${
                                            meal.title || meal.name
                                          }" class="item-image">`
                                        : ""
                                    }
                                </div>
                            `;
                          })
                          .join("")}
                    </div>
                </div>
            `;
      }

      // 获取选中的过敏/不耐受食物
      function getSelectedIntolerances() {
        var checkboxes = document.querySelectorAll(
          '#intolerancesCheckboxes input[type="checkbox"]:checked'
        );
        return Array.from(checkboxes)
          .map((cb) => cb.value)
          .join(",");
      }

      // 重置表单
      function resetPlanForm() {
        document.getElementById("planDuration").value = "week";
        document.getElementById("dietType").value = "";

        // 重置复选框
        var checkboxes = document.querySelectorAll(
          '#intolerancesCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false));

        document.getElementById("excludeIngredients").value = "";
        document.getElementById("planDisplayArea").style.display = "none";
      }

      // 保存饮食计划
      function saveDietPlan() {
        if (!currentDietPlan) {
          showNotification("没有可保存的饮食计划", "warning");
          return;
        }

        savedDietPlans.push({
          ...currentDietPlan,
          savedAt: new Date().toISOString(),
        });

        saveUserData();
        loadSavedPlans();
        showNotification("✅ 饮食计划已保存", "success");
      }

      // 导出PDF（模拟功能）
      function exportDietPlan() {
        if (!currentDietPlan) {
          showNotification("没有可导出的饮食计划", "warning");
          return;
        }

        showNotification("PDF导出功能开发中...", "warning");
        // 这里可以集成PDF生成库
      }

      // 应用到今日
      function applyTodayPlan() {
        if (!currentDietPlan || !currentDietPlan.days.length) {
          showNotification("没有可应用的饮食计划", "warning");
          return;
        }

        var todayPlan = currentDietPlan.days[0];

        // 清空今日记录
        recordedFoods.breakfast = [];
        recordedFoods.lunch = [];
        recordedFoods.dinner = [];

        // 应用计划到今日记录
        Object.keys(todayPlan.meals).forEach((mealType) => {
          todayPlan.meals[mealType].forEach((meal) => {
            var foodRecord = {
              id: meal.id || Date.now() + Math.random(),
              name: meal.title || meal.name,
              calories: Math.round(meal.calories || 0),
              protein: Math.round((meal.protein || 0) * 10) / 10,
              carbs: Math.round((meal.carbs || 0) * 10) / 10,
              fat: Math.round((meal.fat || 0) * 10) / 10,
              recordId: Date.now() + Math.random(),
              quantity: 1,
              unit: "份",
            };
            recordedFoods[mealType].push(foodRecord);
          });
        });

        updateNutritionTracking();
        updateAllMealRecorded();
        saveUserData();

        showNotification("✅ 饮食计划已应用到今日记录", "success");

        // 跳转到主页显示结果
        setTimeout(() => {
          showMainPage();
        }, 1500);
      }

      // 加载已保存的计划
      function loadSavedPlans() {
        var container = document.getElementById("savedPlansList");

        if (savedDietPlans.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <p>暂无保存的饮食计划</p>
                        <small>生成并保存您的第一个饮食计划吧！</small>
                    </div>
                `;
          return;
        }

        container.innerHTML = savedDietPlans
          .map(
            (plan, index) => `
                <div class="saved-plan-item">
                    <div class="plan-item-header">
                        <div class="plan-item-title">${plan.name}</div>
                        <div class="plan-item-date">${new Date(
                          plan.savedAt
                        ).toLocaleDateString()}</div>
                    </div>
                    <div class="plan-item-stats">
                        <span>📅 ${plan.days.length}天</span>
                        <span>🔥 ${Math.round(
                          plan.totalCalories / plan.days.length
                        )} kcal/天</span>
                        <span>🥩 ${Math.round(
                          plan.totalProtein / plan.days.length
                        )}g 蛋白质/天</span>
                    </div>
                    <div class="plan-item-actions">
                        <button onclick="viewSavedPlan(${index})" style="background: #667eea; color: white;">查看详情</button>
                        <button onclick="applySavedPlan(${index})" style="background: #28a745; color: white;">应用计划</button>
                        <button onclick="deleteSavedPlan(${index})" style="background: #dc3545; color: white;">删除</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // 查看保存的计划
      function viewSavedPlan(index) {
        if (savedDietPlans[index]) {
          currentDietPlan = savedDietPlans[index];
          displayDietPlan(currentDietPlan);
          showNotification("已加载保存的饮食计划", "success");
        }
      }

      // 应用保存的计划
      function applySavedPlan(index) {
        if (savedDietPlans[index]) {
          currentDietPlan = savedDietPlans[index];
          applyTodayPlan();
        }
      }

      // 删除保存的计划
      function deleteSavedPlan(index) {
        if (confirm("确定要删除这个饮食计划吗？")) {
          savedDietPlans.splice(index, 1);
          saveUserData();
          loadSavedPlans();
          showNotification("饮食计划已删除", "success");
        }
      }
      function initializeChatPageAI() {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        var messageInput = document.getElementById("chatPageMessageInput");
        var sendButton = document.getElementById("chatPageSendButton");

        chatPageAI = {
          messages: [], // 存储对话历史
          isStreaming: false, // 防止重复发送
        };

        // 监听输入框变化，控制发送按钮状态
        messageInput.addEventListener("input", function () {
          var hasContent = this.value.trim().length > 0;
          sendButton.disabled = !hasContent || chatPageAI.isStreaming;

          // 动态调整输入框高度
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });

        // 支持Enter发送消息（Shift+Enter换行）
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled) {
              sendChatPageMessage();
            }
          }
        });

        // 初始化欢迎消息
        displayWelcomeMessage();
      }

      // 显示欢迎消息
      function displayWelcomeMessage() {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">🤖</div>
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.5em;">欢迎使用AI健康顾问</h3>
                    <p style="margin-bottom: 10px; line-height: 1.6;">我是您的专属智能健康助手，可以为您提供：</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; text-align: left;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #667eea;">
                            <strong>🥗 个性化饮食建议</strong><br>
                            <small>根据您的健康目标制定专属饮食方案</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #4CAF50;">
                            <strong>📊 营养分析解读</strong><br>
                            <small>解析您的营养摄入数据，提供改进建议</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #ff9800;">
                            <strong>💪 运动指导方案</strong><br>
                            <small>推荐适合您的运动计划和健身建议</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #e91e63;">
                            <strong>🎯 目标达成指导</strong><br>
                            <small>帮助您制定和实现健康目标</small>
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.9em; margin-top: 20px;">请随时向我提问，开始您的健康之旅！</p>
                </div>
            `;
      }

      // 拍照识别功能（完整实现）
      function openPhotoRecognitionDialog(mealType) {
        currentMealType = mealType;
        document.getElementById("photoRecognitionDialog").style.display =
          "flex";

        // 重置界面
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("recognitionResults").style.display = "none";
        document.getElementById("recognitionLoading").style.display = "none";
        document.getElementById("photoInput").value = "";
        document.getElementById("recognizedFoodsList").innerHTML = "";
      }

      // 关闭拍照识别对话框
      function closePhotoRecognitionDialog() {
        document.getElementById("photoRecognitionDialog").style.display =
          "none";
        currentMealType = "";
      }

      // 处理图片选择
      function handlePhotoSelection(event) {
        var file = event.target.files[0];
        if (!file) return;

        // 检查文件类型
        if (!file.type.startsWith("image/")) {
          showNotification("请选择图片文件", "warning");
          return;
        }

        // 检查文件大小（限制5MB）
        if (file.size > 5 * 1024 * 1024) {
          showNotification("图片文件过大，请选择小于5MB的图片", "warning");
          return;
        }

        // 显示预览
        var reader = new FileReader();
        reader.onload = function (e) {
          var previewImage = document.getElementById("previewImage");
          previewImage.src = e.target.result;
          document.getElementById("photoPreview").style.display = "block";

          // 开始识别
          recognizeFood(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      // 调用百度菜品识别API（通过Netlify Function）
      async function recognizeFood(imageDataUrl) {
        try {
          // 显示加载状态
          document.getElementById("recognitionLoading").style.display = "block";
          document.getElementById("recognitionResults").style.display = "none";

          console.log("开始食物识别...");

          // 调用Netlify Function
          var response = await fetch("/.netlify/functions/food-recognition", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: imageDataUrl,
              topNum: 5, // 返回前5个结果
              filterThreshold: 0.95, // 置信度阈值
              baikeNum: 1, // 返回百科信息
            }),
          });

          var data = await response.json();
          console.log("百度API返回结果:", data);

          // 隐藏加载状态
          document.getElementById("recognitionLoading").style.display = "none";

          if (data.success && data.results && data.results.length > 0) {
            displayRecognitionResults(data.results);
            showNotification(`成功识别${data.results.length}个菜品`, "success");
          } else if (data.success && data.results.length === 0) {
            showNotification("未能识别出菜品，请尝试更清晰的图片", "warning");
            closePhotoRecognitionDialog();
          } else {
            showNotification(data.error || "识别失败，请重试", "error");
            closePhotoRecognitionDialog();
          }
        } catch (error) {
          console.error("食物识别失败:", error);
          document.getElementById("recognitionLoading").style.display = "none";
          showNotification("食物识别失败，请稍后重试", "error");
        }
      }

      // 模拟食物识别（实际项目中可接入百度AI、腾讯AI等服务）
      async function simulateFoodRecognition(imageDataUrl) {
        // 模拟API调用延迟
        await new Promise((resolve) => setTimeout(resolve, 2000));

        // 模拟识别结果（实际项目中应该调用真实的AI识别API）
        var mockResults = [
          {
            name: "苹果",
            confidence: 0.95,
            calories: 52,
            protein: 0.3,
            carbs: 14,
            fat: 0.2,
            unit: "个",
          },
          {
            name: "香蕉",
            confidence: 0.88,
            calories: 89,
            protein: 1.1,
            carbs: 23,
            fat: 0.3,
            unit: "根",
          },
          {
            name: "鸡胸肉",
            confidence: 0.92,
            calories: 165,
            protein: 31,
            carbs: 0,
            fat: 3.6,
            unit: "100g",
          },
          {
            name: "西兰花",
            confidence: 0.85,
            calories: 34,
            protein: 2.8,
            carbs: 7,
            fat: 0.4,
            unit: "100g",
          },
          {
            name: "米饭",
            confidence: 0.9,
            calories: 130,
            protein: 2.7,
            carbs: 28,
            fat: 0.3,
            unit: "碗",
          },
        ];

        // 随机返回1-3个识别结果
        var resultCount = Math.floor(Math.random() * 3) + 1;
        return mockResults.slice(0, resultCount).map((result) => ({
          ...result,
          id: "recognized_" + Date.now() + Math.random(),
        }));
      }

      // 显示识别结果
      function displayRecognitionResults(results) {
        var container = document.getElementById("recognizedFoodsList");
        container.innerHTML = "";

        // 按置信度排序
        results.sort((a, b) => b.confidence - a.confidence);

        results.forEach((food) => {
          var resultItem = document.createElement("div");
          resultItem.className = "food-result-item";
          resultItem.style.margin = "10px 0";
          resultItem.style.padding = "15px";
          resultItem.style.background = "white";
          resultItem.style.borderRadius = "10px";
          resultItem.style.border = "2px solid #e9ecef";
          resultItem.style.transition = "all 0.3s ease";

          // 根据置信度设置边框颜色
          if (food.confidence > 0.9) {
            resultItem.style.borderColor = "#4CAF50";
          } else if (food.confidence > 0.7) {
            resultItem.style.borderColor = "#FF9800";
          }

          // 构建HTML内容
          var baikeInfo = "";
          if (food.baike_info && food.baike_info.description) {
            var description = food.baike_info.description;
            if (description.length > 100) {
              description = description.substring(0, 100) + "...";
            }
            baikeInfo = `
                <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                    <small style="color: #666;">
                        <strong>百科：</strong>${description}
                        ${
                          food.baike_info.baike_url
                            ? `<a href="${food.baike_info.baike_url}" target="_blank" style="color: #667eea; margin-left: 5px;">查看更多</a>`
                            : ""
                        }
                    </small>
                </div>
            `;
          }

          resultItem.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #333; font-size: 1.1em;">
                            ${food.name}
                        </span>
                        <span style="background: ${
                          food.confidence > 0.9
                            ? "#4CAF50"
                            : food.confidence > 0.7
                            ? "#FF9800"
                            : "#9E9E9E"
                        }; 
                                   color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">
                            ${(food.confidence * 100).toFixed(1)}%
                        </span>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                        <span class="nutrition-badge" style="background: #fff3cd; color: #856404;">
                            🔥 ${food.calorie.toFixed(1)} kcal/100g
                        </span>
                        <span class="nutrition-badge" style="background: #d1ecf1; color: #0c5460;">
                            估算 ${food.estimatedWeight}g
                        </span>
                        <span class="nutrition-badge" style="background: #f8d7da; color: #721c24;">
                            总热量 ${food.totalCalories} kcal
                        </span>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <small style="color: #666;">
                            蛋白质: ${food.nutrition.protein}g | 
                            碳水: ${food.nutrition.carbs}g | 
                            脂肪: ${food.nutrition.fat}g
                        </small>
                    </div>
                    
                    ${baikeInfo}
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="add-food-btn" 
                            onclick="addRecognizedFoodWithQuantity('${encodeURIComponent(
                              JSON.stringify(food)
                            )}')"
                            style="background: #28a745; color: white; border: none; 
                                   padding: 10px 20px; border-radius: 20px; cursor: pointer;
                                   font-size: 0.9em; font-weight: 500; white-space: nowrap;">
                        添加
                    </button>
                    <button onclick="adjustFoodWeight('${encodeURIComponent(
                      JSON.stringify(food)
                    )}')"
                            style="background: #17a2b8; color: white; border: none; 
                                   padding: 8px 15px; border-radius: 15px; cursor: pointer;
                                   font-size: 0.85em; white-space: nowrap;">
                        调整重量
                    </button>
                </div>
            </div>
        `;

          container.appendChild(resultItem);
        });

        document.getElementById("recognitionResults").style.display = "block";
      }

      // 添加识别的食物（带数量确认）
      function addRecognizedFoodWithQuantity(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));

          // 使用默认估算重量或让用户输入
          var weight = prompt(
            `请输入 "${food.name}" 的重量（克）：`,
            food.estimatedWeight
          );

          if (weight && !isNaN(weight) && parseFloat(weight) > 0) {
            weight = parseFloat(weight);

            // 根据实际重量重新计算营养信息
            var factor = weight / 100; // 百度API返回的是每100g的数据

            var foodRecord = {
              id: food.id,
              name: food.name,
              calories: Math.round(food.calorie * factor),
              protein:
                Math.round(
                  ((food.nutrition.protein * weight) / food.estimatedWeight) *
                    10
                ) / 10,
              carbs:
                Math.round(
                  ((food.nutrition.carbs * weight) / food.estimatedWeight) * 10
                ) / 10,
              fat:
                Math.round(
                  ((food.nutrition.fat * weight) / food.estimatedWeight) * 10
                ) / 10,
              recordId: Date.now(),
              quantity: 1,
              unit: weight + "g",
              isBaiduRecognized: true,
              confidence: food.confidence,
            };

            // 添加到当前餐食记录
            addFoodRecord(foodRecord, currentMealType, 1);

            showNotification(`✅ 已添加 ${food.name} (${weight}g)`, "success");

            // 如果所有食物都已处理，关闭对话框
            var remainingItems = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            if (remainingItems.length <= 1) {
              setTimeout(() => {
                closePhotoRecognitionDialog();
              }, 1000);
            }
          }
        } catch (error) {
          console.error("添加识别食物失败:", error);
          showNotification("添加失败，请重试", "error");
        }
      }

      // 调整食物重量
      function adjustFoodWeight(encodedFood) {
        try {
          var food = JSON.parse(decodeURIComponent(encodedFood));

          var newWeight = prompt(
            `调整 "${food.name}" 的重量（克）：`,
            food.estimatedWeight
          );

          if (newWeight && !isNaN(newWeight) && parseFloat(newWeight) > 0) {
            newWeight = parseFloat(newWeight);

            // 更新显示的重量和营养信息
            food.estimatedWeight = newWeight;
            food.totalCalories = Math.round((food.calorie * newWeight) / 100);
            food.nutrition.calories = food.totalCalories;
            food.nutrition.protein = Math.round((food.totalCalories * 0.2) / 4);
            food.nutrition.carbs = Math.round((food.totalCalories * 0.5) / 4);
            food.nutrition.fat = Math.round((food.totalCalories * 0.3) / 9);
            food.nutrition.unit = `${newWeight}g`;

            // 重新显示结果
            var currentResults = document.querySelectorAll(
              "#recognizedFoodsList .food-result-item"
            );
            var results = [];
            currentResults.forEach((item) => {
              // 保留其他项，更新当前项
              results.push(food);
            });

            displayRecognitionResults(results);
            showNotification(`已调整重量为 ${newWeight}g`, "success");
          }
        } catch (error) {
          console.error("调整重量失败:", error);
          showNotification("调整失败，请重试", "error");
        }
      }

      // 发送聊天消息（支持SSE流式输出）
      async function sendChatPageMessage() {
        var messageInput = document.getElementById("chatPageMessageInput");
        var message = messageInput.value.trim();

        // 验证消息内容
        if (!message || chatPageAI.isStreaming) {
          return;
        }

        // 清空输入框并设置状态
        messageInput.value = "";
        messageInput.style.height = "auto";
        document.getElementById("chatPageSendButton").disabled = true;
        chatPageAI.isStreaming = true;

        try {
          // 添加用户消息到界面
          addChatPageMessage(message, "user");

          // 添加AI消息容器（用于流式输出）
          var aiMessageDiv = addChatPageMessage(
            "",
            "assistant",
            false,
            false,
            true
          );
          var aiMessageContent = aiMessageDiv.querySelector(
            ".chat-message-content"
          );

          // 构建请求消息历史
          var requestMessages = [
            {
              role: "system",
              content: buildSystemPrompt(),
            },
            ...chatPageAI.messages,
            {
              role: "user",
              content: message,
            },
          ];

          console.log("开始SSE流式对话...");

          // 调用SSE流式API
          var fullResponse = await streamChatCompletion(
            requestMessages,
            aiMessageContent
          );

          // 保存对话历史
          chatPageAI.messages.push(
            { role: "user", content: message },
            { role: "assistant", content: fullResponse }
          );
        } catch (error) {
          console.error("AI聊天错误:", error);

          // 移除空的AI消息容器
          var emptyAiMessage = document.querySelector(
            ".chat-message.assistant .chat-message-content:empty"
          );
          if (emptyAiMessage) {
            emptyAiMessage.closest(".chat-message").remove();
          }

          addChatPageMessage(
            `抱歉，我现在无法回复您的问题。请稍后再试。\n\n错误信息：${error.message}`,
            "assistant",
            false,
            true
          );
        } finally {
          // 恢复界面状态
          chatPageAI.isStreaming = false;
          var messageInput = document.getElementById("chatPageMessageInput");
          var sendButton = document.getElementById("chatPageSendButton");
          sendButton.disabled = messageInput.value.trim().length === 0;
        }
      }

      // SSE流式聊天完成
      async function streamChatCompletion(messages, targetElement) {
        return new Promise((resolve, reject) => {
          var fullResponse = "";
          var controller = new AbortController();
          var timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error("请求超时"));
          }, 60000); // 60秒超时

          fetch(AI_API_CONFIG.endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: AI_API_CONFIG.headers.Authorization,
            },
            body: JSON.stringify({
              messages: messages,
              stream: true, // 启用流式输出
            }),
            signal: controller.signal,
          })
            .then((response) => {
              clearTimeout(timeoutId);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              if (!response.body) {
                throw new Error("响应体为空");
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              function processStream() {
                return reader.read().then(({ done, value }) => {
                  if (done) {
                    console.log("SSE流式输出完成");
                    // 移除光标
                    var cursor =
                      targetElement.querySelector(".streaming-cursor");
                    if (cursor) cursor.remove();
                    resolve(fullResponse);
                    return;
                  }

                  const chunk = decoder.decode(value, { stream: true });
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      const data = line.slice(6).trim();

                      if (data === "[DONE]") {
                        // 移除光标
                        var cursor =
                          targetElement.querySelector(".streaming-cursor");
                        if (cursor) cursor.remove();
                        resolve(fullResponse);
                        return;
                      }

                      try {
                        const parsed = JSON.parse(data);
                        const content = parsed.choices?.[0]?.delta?.content;

                        if (content) {
                          fullResponse += content;
                          // 实时更新显示内容
                          updateStreamingContent(targetElement, fullResponse);
                        }
                      } catch (e) {
                        console.warn("解析SSE数据失败:", e, data);
                      }
                    }
                  }

                  return processStream();
                });
              }

              return processStream();
            })
            .catch((error) => {
              clearTimeout(timeoutId);
              console.error("SSE流式请求失败:", error);
              reject(error);
            });
        });
      }

      // 更新流式内容显示
      function updateStreamingContent(targetElement, content) {
        // 处理换行和格式化
        var formattedContent = content
          .replace(/\n/g, "<br>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        // 添加流式输出光标
        targetElement.innerHTML =
          formattedContent + '<span class="streaming-cursor"></span>';

        // 自动滚动到最新内容
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: "smooth",
        });
      }

      // 添加聊天消息到界面（增强版本，支持流式输出）
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false,
        isStreaming = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // 清除欢迎消息
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // 设置头像
        var avatar = role === "user" ? "👤" : "🤖";

        // 设置消息内容
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else if (isStreaming) {
          messageContent = '<span class="streaming-cursor"></span>'; // 初始只显示光标
        } else {
          // 处理换行和格式化
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // 平滑滚动到最新消息
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // SSE流式聊天完成
      async function streamChatCompletion(messages, targetElement) {
        return new Promise((resolve, reject) => {
          var fullResponse = "";
          var controller = new AbortController();
          var timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error("请求超时"));
          }, 60000); // 60秒超时

          fetch(AI_API_CONFIG.endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: AI_API_CONFIG.headers.Authorization,
            },
            body: JSON.stringify({
              messages: messages,
              stream: true, // 启用流式输出
            }),
            signal: controller.signal,
          })
            .then((response) => {
              clearTimeout(timeoutId);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              if (!response.body) {
                throw new Error("响应体为空");
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              function processStream() {
                return reader.read().then(({ done, value }) => {
                  if (done) {
                    console.log("SSE流式输出完成");
                    resolve(fullResponse);
                    return;
                  }

                  const chunk = decoder.decode(value, { stream: true });
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      const data = line.slice(6).trim();

                      if (data === "[DONE]") {
                        resolve(fullResponse);
                        return;
                      }

                      try {
                        const parsed = JSON.parse(data);
                        const content = parsed.choices?.[0]?.delta?.content;

                        if (content) {
                          fullResponse += content;
                          // 实时更新显示内容
                          updateStreamingContent(targetElement, fullResponse);
                        }
                      } catch (e) {
                        console.warn("解析SSE数据失败:", e, data);
                      }
                    }
                  }

                  return processStream();
                });
              }

              return processStream();
            })
            .catch((error) => {
              clearTimeout(timeoutId);
              console.error("SSE流式请求失败:", error);
              reject(error);
            });
        });
      }

      // 更新流式内容显示
      function updateStreamingContent(targetElement, content) {
        // 处理换行和格式化
        var formattedContent = content
          .replace(/\n/g, "<br>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        // 添加流式输出光标
        targetElement.innerHTML =
          formattedContent + '<span class="streaming-cursor"></span>';

        // 自动滚动到最新内容
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: "smooth",
        });
      }

      // 添加聊天消息到界面（增强版本，支持流式输出）
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false,
        isStreaming = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // 清除欢迎消息
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // 设置头像
        var avatar = role === "user" ? "👤" : "🤖";

        // 设置消息内容
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else if (isStreaming) {
          messageContent = '<span class="streaming-cursor"></span>'; // 初始只显示光标
        } else {
          // 处理换行和格式化
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // 平滑滚动到最新消息
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // 构建系统提示词
      function buildSystemPrompt() {
        var systemPrompt = `你是一个专业的AI健康饮食助手，名字叫"小健"。请用温暖、专业的语气为用户提供个性化的健康建议。

你的专长领域包括：
- 营养学和饮食搭配
- 运动健身指导  
- 健康生活方式建议
- 疾病预防知识

请注意：
1. 回答要专业但易懂，避免过于医学化的术语
2. 根据用户的个人信息提供个性化建议
3. 如果涉及严重健康问题，建议用户咨询专业医生
4. 保持积极正面的态度，鼓励用户养成健康习惯`;

        // 添加用户个人信息
        if (userProfile.fullName) {
          systemPrompt += `\n\n📋 用户个人档案：
- 姓名：${userProfile.fullName}
- 性别：${
            userProfile.gender === "male"
              ? "男性"
              : userProfile.gender === "female"
              ? "女性"
              : "未设置"
          }
- 身高：${userProfile.height || "未设置"}cm
- 体重：${userProfile.weight || "未设置"}kg`;

          if (userProfile.targetWeight) {
            systemPrompt += `\n- 目标体重：${userProfile.targetWeight}kg`;
          }

          if (userProfile.activityLevel) {
            var activityLabels = {
              sedentary: "久坐少动",
              light: "轻度运动",
              moderate: "中度运动",
              active: "高度运动",
              "very-active": "专业运动员",
            };
            systemPrompt += `\n- 运动频率：${
              activityLabels[userProfile.activityLevel] ||
              userProfile.activityLevel
            }`;
          }

          if (userProfile.goals && userProfile.goals.length > 0) {
            var goalLabels = {
              "weight-loss": "减重瘦身",
              "muscle-gain": "增肌塑形",
              "healthy-eating": "健康饮食",
              "disease-prevention": "疾病预防",
            };
            var goalsText = userProfile.goals
              .map((goal) => goalLabels[goal] || goal)
              .join("、");
            systemPrompt += `\n- 健康目标：${goalsText}`;
          }
        }

        // 添加当前营养状况
        var currentNutrition = getCurrentNutrition();
        if (currentNutrition.calories > 0) {
          systemPrompt += `\n\n📊 今日营养摄入情况：
- 已摄入热量：${Math.round(currentNutrition.calories)} kcal
- 蛋白质：${currentNutrition.protein.toFixed(1)}g
- 碳水化合物：${currentNutrition.carbs.toFixed(1)}g  
- 脂肪：${currentNutrition.fat.toFixed(1)}g`;

          if (nutritionPlan.targets) {
            systemPrompt += `\n\n🎯 营养目标：
- 目标热量：${nutritionPlan.targets.calories} kcal
- 目标蛋白质：${nutritionPlan.targets.protein}g
- 目标碳水：${nutritionPlan.targets.carbs}g
- 目标脂肪：${nutritionPlan.targets.fat}g`;
          }
        }

        return systemPrompt;
      }

      // 添加聊天消息到界面
      function addChatPageMessage(
        content,
        role,
        isLoading = false,
        isError = false
      ) {
        var messagesContainer = document.getElementById(
          "chatPageMessagesContainer"
        );

        // 清除欢迎消息
        var welcomeMsg = messagesContainer.querySelector(
          '[style*="text-align: center"]'
        );
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        var messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${role}`;

        // 设置头像
        var avatar = role === "user" ? "👤" : "🤖";

        // 设置消息内容
        var messageContent;
        if (isLoading) {
          messageContent =
            '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
        } else {
          // 处理换行和格式化
          var formattedContent = content
            .replace(/\n/g, "<br>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>");

          if (isError) {
            messageContent = `<div style="color: #ff4757;">${formattedContent}</div>`;
          } else {
            messageContent = formattedContent;
          }
        }

        messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-message-content">${messageContent}</div>
            `;

        messagesContainer.appendChild(messageDiv);

        // 平滑滚动到最新消息
        setTimeout(() => {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: "smooth",
          });
        }, 100);

        return messageDiv;
      }

      // 显示通知（增强版本，支持不同类型）
      function showNotification(message, type = "success") {
        var notification = document.getElementById("notification");
        notification.innerHTML = message; // 支持HTML内容
        notification.className = "notification " + type;
        notification.style.display = "block";

        // 根据类型设置不同的显示时间
        var displayTime =
          type === "info" ? 4000 : type === "warning" ? 5000 : 3000;

        setTimeout(() => {
          notification.style.display = "none";
        }, displayTime);
      }

      // 保存用户数据
      function saveUserData() {
        var userData = {
          userProfile: userProfile,
          nutritionPlan: nutritionPlan,
          recordedFoods: recordedFoods,
          waterGlasses: waterGlasses,
          lastSaved: new Date().toISOString(),
        };

        try {
          // 由于不能使用localStorage，我们只在内存中保存
          console.log("数据已保存到内存:", userData);
        } catch (error) {
          console.error("保存数据失败:", error);
        }
      }

      // 加载用户数据
      function loadUserData() {
        try {
          // 由于不能使用localStorage，我们使用默认数据
          console.log("从内存加载数据");
          updateNutritionTracking();
          updateWaterDisplay();
          updateAllMealRecorded();
        } catch (error) {
          console.error("加载数据失败:", error);
        }
      }

      // 更新所有餐食记录显示
      function updateAllMealRecorded() {
        ["breakfast", "lunch", "dinner"].forEach((mealType) => {
          updateMealRecorded(mealType);
        });
      }

      // 页面加载完成后初始化（增强版本）
      document.addEventListener("DOMContentLoaded", function () {
        var customDialog = document.getElementById("customFoodDialog");
        var photoDialog = document.getElementById("photoRecognitionDialog");

        // 验证按钮
        var customBtns = document.querySelectorAll(
          '[onclick*="openCustomFoodDialog"]'
        );
        var photoBtns = document.querySelectorAll(
          '[onclick*="openPhotoRecognitionDialog"]'
        );

        loadUserData();
        displayPersonalPlan();

        // 自动展开第一个餐食区域
        var firstMealSection = document.querySelector(".meal-time-section");
        if (firstMealSection) {
          firstMealSection.classList.add("expanded");
        }

        // 添加对话框点击外部关闭功能
        if (customDialog) {
          customDialog.addEventListener("click", function (e) {
            if (e.target === this) {
              closeCustomFoodDialog();
            }
          });
        }

        if (photoDialog) {
          photoDialog.addEventListener("click", function (e) {
            if (e.target === this) {
              closePhotoRecognitionDialog();
            }
          });
        }

        // 添加键盘快捷键支持
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCustomFoodDialog();
            closePhotoRecognitionDialog();
          }

          // 在自定义食物对话框中支持Enter快捷键
          if (e.key === "Enter" && e.ctrlKey) {
            var customDialog = document.getElementById("customFoodDialog");
            if (customDialog && customDialog.style.display === "flex") {
              var analyzeBtn = document.getElementById("analyzeNutritionBtn");
              var addBtn = document.getElementById("addAnalyzedFoodBtn");

              if (analyzeBtn && analyzeBtn.style.display !== "none") {
                analyzeCustomFood();
              } else if (addBtn && addBtn.style.display !== "none") {
                addAnalyzedFood();
              }
            }
          }
        });

        console.log("✅ 智能健康饮食助手加载完成");
        console.log("✅ 全局函数已注册到window对象");

        // 最后验证一次
        setTimeout(() => {
          console.log("🔍 最终验证函数可访问性:");
          console.log(
            "- window.openCustomFoodDialog:",
            typeof window.openCustomFoodDialog
          );
          console.log(
            "- window.openPhotoRecognitionDialog:",
            typeof window.openPhotoRecognitionDialog
          );

          if (typeof window.openCustomFoodDialog === "function") {
            console.log("✅ 自定义食物功能就绪");
          } else {
            console.error("❌ 自定义食物功能未就绪");
          }
        }, 1000);
      });

      // 添加一些示例数据用于演示
      function addSampleData() {
        // 添加示例早餐
        addFoodRecord(foodDatabase[0], "breakfast", 1); // 燕麦粥
        addFoodRecord(foodDatabase[2], "breakfast", 1); // 煮鸡蛋

        // 添加示例午餐
        addFoodRecord(foodDatabase[4], "lunch", 1); // 鸡胸肉
        addFoodRecord(foodDatabase[5], "lunch", 1); // 米饭
        addFoodRecord(foodDatabase[6], "lunch", 1); // 西兰花

        // 设置一些饮水记录
        waterGlasses[0] = true;
        waterGlasses[1] = true;
        waterGlasses[2] = true;

        updateNutritionTracking();
        updateWaterDisplay();
        updateAllMealRecorded();

        showNotification("已添加示例数据！", "success");
      }

      // 为了演示效果，可以调用这个函数
      // addSampleData();
    </script>
  </body>
</html>
